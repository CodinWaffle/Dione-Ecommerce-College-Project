{% if current_user.is_authenticated and (current_user.role|default('',
true)|lower) in ['buyer','seller','rider'] %}
<!-- Chat Bubble for users to message admin -->
<style>
  .chat-bubble-btn {
    position: fixed;
    right: 20px;
    bottom: 24px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #0066ff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    z-index: 2000;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    cursor: pointer;
  }
  .chat-bubble-modal {
    position: fixed;
    right: 90px;
    bottom: 90px;
    width: 360px;
    max-width: calc(100% - 40px);
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.16);
    z-index: 2000;
    display: none;
    flex-direction: column;
  }
  .chat-bubble-modal.active {
    display: flex;
  }
  .chat-bubble-header {
    padding: 8px 12px;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .chat-bubble-messages {
    max-height: 300px;
    overflow-y: auto;
    padding: 8px 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .chat-bubble-input {
    display: flex;
    gap: 8px;
    padding: 8px;
    border-top: 1px solid #f3f4f6;
  }
  .chat-bubble-input input {
    flex: 1;
    padding: 8px 10px;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
  }
  .chat-msg {
    padding: 8px 10px;
    border-radius: 12px;
    max-width: 80%;
    font-size: 13px;
  }
  .chat-msg.me {
    align-self: flex-end;
    background: #0066ff;
    color: white;
  }
  .chat-msg.them {
    align-self: flex-start;
    background: #f3f4f6;
    color: #111;
  }
</style>

<div id="chatBubbleBtn" class="chat-bubble-btn" title="Message Admin">ðŸ’¬</div>
<div
  id="chatBubbleModal"
  class="chat-bubble-modal"
  role="dialog"
  aria-hidden="true"
>
  <div class="chat-bubble-header">
    <div>
      <strong>Message Admin</strong>
      <div style="font-size: 12px; color: #6b7280">Support will reply here</div>
    </div>
    <button
      id="chatBubbleClose"
      style="background: none; border: none; cursor: pointer; font-size: 18px"
    >
      âœ•
    </button>
  </div>
  <div id="chatBubbleMessages" class="chat-bubble-messages"></div>
  <div class="chat-bubble-input">
    <input id="chatBubbleInput" placeholder="Type a message..." />
    <button id="chatBubbleSend" class="btn btn-primary">Send</button>
  </div>
</div>

<script>
  (function () {
    const btn = document.getElementById("chatBubbleBtn");
    const modal = document.getElementById("chatBubbleModal");
    const closeBtn = document.getElementById("chatBubbleClose");
    const sendBtn = document.getElementById("chatBubbleSend");
    const input = document.getElementById("chatBubbleInput");
    const messages = document.getElementById("chatBubbleMessages");

    function openModal() {
      modal.classList.add("active");
      modal.setAttribute("aria-hidden", "false");
      loadMessages();
    }
    function closeModal() {
      modal.classList.remove("active");
      modal.setAttribute("aria-hidden", "true");
    }

    btn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);

    sendBtn.addEventListener("click", function () {
      const text = input.value.trim();
      if (!text) return;
      sendMessage(text);
    });

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    function renderMsgs(list) {
      messages.innerHTML = "";
      list.forEach((m) => {
        const d = document.createElement("div");
        d.className = "chat-msg " + (m.is_from_admin ? "them" : "me");
        d.textContent = m.body;
        messages.appendChild(d);
      });
      messages.scrollTop = messages.scrollHeight;
    }

    function loadMessages() {
      fetch("/chat/my", { credentials: "same-origin" })
        .then((r) => r.json())
        .then((data) => {
          if (data.messages) renderMsgs(data.messages);
        })
        .catch((err) => console.error("chat load error", err));
    }

    function sendMessage(text) {
      const form = new FormData();
      form.append("body", text);
      fetch("/chat/send", {
        method: "POST",
        body: form,
        credentials: "same-origin",
      })
        .then(async (r) => {
          let data = {};
          try {
            data = await r.json();
          } catch (e) {
            console.error("chat send: invalid json response", e);
          }
          if (r.ok && data.ok) {
            input.value = "";
            loadMessages();
          } else {
            console.error("chat send failed", r.status, data);
          }
        })
        .catch((err) => console.error("chat send error", err));
    }
  })();
</script>
{% endif %}
