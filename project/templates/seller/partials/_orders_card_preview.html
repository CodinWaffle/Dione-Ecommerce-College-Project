{# Macro partial to render a detailed order preview card used in seller order management #}
{% macro render_order_card(order, index=None) %}
{%- set placeholder_image = '/static/image/banner.png' -%}
{%- set status_options = [
  ('pending', 'Pending'),
  ('confirmed', 'Confirmed'),
  ('shipping', 'To Ship'),
  ('in_transit', 'In Transit'),
  ('delivered', 'Delivered'),
  ('completed', 'Completed'),
  ('cancelled', 'Cancelled')
] -%}
{%- set editable_status_values = ['pending', 'shipping'] -%}
{%- set status_labels = {
  'pending': 'Pending',
  'confirmed': 'Confirmed',
  'shipping': 'To Ship',
  'to ship': 'To Ship',
  'to_ship': 'To Ship',
  'in_transit': 'In Transit',
  'delivered': 'Delivered',
  'completed': 'Completed',
  'cancelled': 'Cancelled'
} -%}
{%- set shipping_status_values = ['shipping', 'to ship', 'to_ship'] -%}

{%- set order_id = order.id if order is not none and (order.id is defined) else (
  order.get('id') if order is mapping else None) -%}
{%- set order_number = order.order_number if order is not none and (order.order_number is defined) else (
  order.get('order_number') if order is mapping else order_id) -%}
{%- set status_value = (order.status if order is not none and (order.status is defined) else (
  order.get('status') if order is mapping else 'pending'))|lower -%}
{%- set status_label = status_labels.get(status_value, status_value.replace('_', ' ').title()) -%}
{%- set status_locked = status_value not in editable_status_values -%}
{%- set pickup_action_enabled = status_value in shipping_status_values -%}

{%- set created_at = order.created_at if order is not none and (order.created_at is defined) else (
  order.get('created_at') if order is mapping else None) -%}
{%- set updated_at = order.updated_at if order is not none and (order.updated_at is defined) else (
  order.get('updated_at') if order is mapping else None) -%}
{%- if created_at is string -%}{%- set created_label = created_at -%}{%- elif created_at -%}{%- set created_label = created_at.strftime('%b %d, %Y') -%}{%- else -%}{%- set created_label = '—' -%}{%- endif -%}
{%- if updated_at is string -%}{%- set updated_label = updated_at -%}{%- elif updated_at -%}{%- set updated_label = updated_at.strftime('%b %d, %Y %I:%M %p') -%}{%- else -%}{%- set updated_label = created_label -%}{%- endif -%}

{%- set billing = None -%}
{%- if order is not none and (order.billing_address is defined) -%}
  {%- set billing = order.billing_address -%}
{%- elif order is mapping -%}
  {%- set billing = order.get('billing_address') -%}
{%- endif -%}
{%- set billing_map = billing if billing is mapping else None -%}
{%- set payment_method_value = '' -%}
{%- if billing -%}
  {%- if billing.payment_method is defined and billing.payment_method -%}
    {%- set payment_method_value = billing.payment_method -%}
  {%- elif billing_map and billing_map.get('payment_method') -%}
    {%- set payment_method_value = billing_map.get('payment_method') -%}
  {%- elif billing.method is defined and billing.method -%}
    {%- set payment_method_value = billing.method -%}
  {%- elif billing_map and billing_map.get('method') -%}
    {%- set payment_method_value = billing_map.get('method') -%}
  {%- endif -%}
{%- endif -%}
{%- set payment_map = {
  'cod': 'Cash on Delivery',
  'cash_on_delivery': 'Cash on Delivery',
  'gcash': 'GCash',
  'credit-card': 'Credit Card',
  'credit_card': 'Credit Card',
  'card': 'Card',
  'paypal': 'PayPal'
} -%}
{%- set payment_label = payment_map.get(payment_method_value|lower, payment_method_value|replace('_', ' ')|title if payment_method_value else 'Manual Payment') -%}

{%- set shipping = None -%}
{%- if order is not none and (order.shipping_address is defined) -%}
  {%- set shipping = order.shipping_address -%}
{%- elif order is mapping -%}
  {%- set shipping = order.get('shipping_address') -%}
{%- endif -%}
{%- set shipping_map = shipping if shipping is mapping else None -%}
{%- set customer_name = 'Customer' -%}
{%- if order is not none and (order.customer_name is defined) and order.customer_name -%}
  {%- set customer_name = order.customer_name -%}
{%- elif shipping -%}
  {%- set first_name = None -%}
  {%- if shipping.first_name is defined and shipping.first_name -%}
    {%- set first_name = shipping.first_name -%}
  {%- elif shipping_map and shipping_map.get('first_name') -%}
    {%- set first_name = shipping_map.get('first_name') -%}
  {%- endif -%}
  {%- set last_name = None -%}
  {%- if shipping.last_name is defined and shipping.last_name -%}
    {%- set last_name = shipping.last_name -%}
  {%- elif shipping_map and shipping_map.get('last_name') -%}
    {%- set last_name = shipping_map.get('last_name') -%}
  {%- endif -%}
  {%- if first_name or last_name -%}
    {%- set customer_name = (first_name or '') ~ (' ' if first_name and last_name else '') ~ (last_name or '') -%}
  {%- elif (shipping.email is defined and shipping.email) or (shipping_map and shipping_map.get('email')) -%}
    {%- set customer_name = shipping.email if shipping.email is defined else shipping_map.get('email') -%}
  {%- endif -%}
{%- endif -%}

{%- set order_items = [] -%}
{%- if order is not none and (order.order_items is defined) and order.order_items -%}
  {%- set order_items = order.order_items -%}
{%- elif order is mapping and order.get('order_items') -%}
  {%- set order_items = order.get('order_items') -%}
{%- endif -%}
{%- set item_count = order_items|length -%}
{%- set first_item = order_items[0] if item_count > 0 else None -%}
{%- set first_item_map = first_item if first_item is mapping else None -%}

{%- set pickup_items = [] -%}
{%- if order is not none and (order.pickup_items is defined) and order.pickup_items -%}
  {%- set pickup_items = order.pickup_items -%}
{%- elif order is mapping and order.get('pickup_items') -%}
  {%- set pickup_items = order.get('pickup_items') -%}
{%- endif -%}
{%- set pickup_finder = namespace(item=None) -%}
{%- for pickup_candidate in pickup_items -%}
  {%- if pickup_finder.item is none -%}
    {%- set candidate_request = pickup_candidate.pickup_request if pickup_candidate is not mapping else pickup_candidate.get('pickup_request') -%}
    {%- if candidate_request and (candidate_request.status|lower not in ['completed', 'cancelled']) -%}
      {%- set pickup_finder.item = pickup_candidate -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}
{%- set active_pickup_item = pickup_finder.item -%}
{%- set active_pickup_request = None -%}
{%- if active_pickup_item -%}
  {%- if active_pickup_item.pickup_request is defined -%}
    {%- set active_pickup_request = active_pickup_item.pickup_request -%}
  {%- elif active_pickup_item.get('pickup_request') -%}
    {%- set active_pickup_request = active_pickup_item.get('pickup_request') -%}
  {%- endif -%}
{%- endif -%}
{%- set pickup_status_value = (active_pickup_request.status if active_pickup_request and (active_pickup_request.status is defined) else '')|lower -%}
{%- set pickup_status_label = pickup_status_value.replace('_', ' ')|title if pickup_status_value else 'Not Scheduled' -%}
{%- set pickup_request_number = '' -%}
{%- if active_pickup_request and (active_pickup_request.request_number is defined) -%}
  {%- set pickup_request_number = active_pickup_request.request_number -%}
{%- elif active_pickup_request is mapping -%}
  {%- set pickup_request_number = active_pickup_request.get('request_number', '') -%}
{%- endif -%}
{%- set pickup_packages = (active_pickup_item.package_count if active_pickup_item and (active_pickup_item.package_count is defined) else None) -%}
{%- if pickup_packages is none and active_pickup_item is mapping -%}
  {%- set pickup_packages = active_pickup_item.get('package_count') -%}
{%- endif -%}
{%- set pickup_packages = pickup_packages or item_count or 1 -%}
{# pickup_action_enabled already computed above #}

{%- set product_name = 'Order Items' -%}
{%- set product_image = placeholder_image -%}
{%- set variant_info = '' -%}
{%- set quantity_value = 1 -%}
{%- if first_item is not none -%}
  {%- if first_item.product_name is defined and first_item.product_name -%}
    {%- set product_name = first_item.product_name -%}
  {%- elif first_item_map and first_item_map.get('product_name') -%}
    {%- set product_name = first_item_map.get('product_name') -%}
  {%- endif -%}
  {%- if first_item.product_image is defined and first_item.product_image -%}
    {%- set product_image = first_item.product_image -%}
  {%- elif first_item_map and first_item_map.get('product_image') -%}
    {%- set product_image = first_item_map.get('product_image') -%}
  {%- endif -%}
  {%- if first_item.variant_name is defined and first_item.variant_name -%}
    {%- set variant_info = first_item.variant_name -%}
  {%- elif first_item_map and first_item_map.get('variant_name') -%}
    {%- set variant_info = first_item_map.get('variant_name') -%}
  {%- else -%}
    {%- set color_value = None -%}
    {%- if first_item.color is defined and first_item.color -%}
      {%- set color_value = first_item.color -%}
    {%- elif first_item_map and first_item_map.get('color') -%}
      {%- set color_value = first_item_map.get('color') -%}
    {%- endif -%}
    {%- set size_value = None -%}
    {%- if first_item.size is defined and first_item.size -%}
      {%- set size_value = first_item.size -%}
    {%- elif first_item_map and first_item_map.get('size') -%}
      {%- set size_value = first_item_map.get('size') -%}
    {%- endif -%}
    {%- if color_value or size_value -%}
      {%- set variant_info = (color_value or '') ~ ((' · ' + size_value) if color_value and size_value else (size_value or '')) -%}
    {%- endif -%}
  {%- endif -%}
  {%- if first_item.quantity is defined and first_item.quantity -%}
    {%- set quantity_value = first_item.quantity -%}
  {%- elif first_item_map and first_item_map.get('quantity') -%}
    {%- set quantity_value = first_item_map.get('quantity') -%}
  {%- endif -%}
{%- endif -%}

{%- set amount_value = order.total_amount if order is not none and (order.total_amount is defined) else (
  order.get('total_amount') if order is mapping else 0)
-%}
{%- set total_display = '₱{:,.2f}'.format((amount_value or 0)|float) -%}
{%- set row_index = (index if index is not none else 0) + 1 -%}
{%- set status_class = status_value.replace('_', '-') -%}

<div
  class="order-card"
  data-order-id="{{ order_id }}"
  data-status="{{ status_value }}"
  data-pickup-id="{{ active_pickup_request.id if active_pickup_request and (active_pickup_request.id is defined) else '' }}"
  data-pickup-status="{{ pickup_status_value }}"
  data-pickup-ready="{{ 'true' if pickup_action_enabled else 'false' }}"
>
  <div class="order-header">
    <div class="header-checkbox">
      <input
        type="checkbox"
        class="order-checkbox"
        value="{{ order_id }}"
        aria-label="Select order {{ order_number }}"
      />
    </div>
    <div class="order-info">
      <span class="customer-label">Customer</span>
      <span class="customer-name">{{ customer_name }}</span>
    </div>
    <div class="order-date">
      <span>Order Date</span>
      <strong>{{ created_label }}</strong>
    </div>
    <div class="order-id">
      <span>Order #</span>
      <strong>{{ order_number }}</strong>
    </div>
  </div>
  <div class="order-content">
    <div class="count-col">
      <div class="order-count" title="Row number">{{ row_index }}</div>
    </div>
    <div class="product-col">
      <img src="{{ product_image or placeholder_image }}" alt="{{ product_name }}" class="product-image" />
      <div class="product-details">
        <p class="product-name">{{ product_name }}</p>
        {% if variant_info %}
        <p class="product-meta">Variant: <span>{{ variant_info }}</span></p>
        {% endif %}
        <p class="product-quantity">
          Qty: <span>{{ quantity_value }}</span>
          {% if item_count > 1 %}· +{{ item_count - 1 }} more{% endif %}
        </p>
      </div>
    </div>
    <div class="price-col">
      <span class="price">{{ total_display }}</span>
    </div>
    <div class="payment-col">
      <span class="payment-method">{{ payment_label }}</span>
    </div>
    <div class="status-col">
      <span class="status-badge status-{{ status_class }}">{{ status_label }}</span>
      <select
        class="status-dropdown status-{{ status_class }}"
        data-order-id="{{ order_id }}"
        data-original-value="{{ status_value }}"
        data-current-value="{{ status_value }}"
        aria-label="Update status for order {{ order_number }}"
      >
        {% if status_locked %}
        <option value="{{ status_value }}" selected disabled>
          {{ status_label }} (locked)
        </option>
        {% endif %}
        {% for value, label in status_options if value in editable_status_values %}
        <option value="{{ value }}" {% if value == status_value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <p class="status-note">Updated {{ updated_label }}</p>
    </div>
    <div class="action-col">
      <div
        class="pickup-block"
        data-pickup-summary
        {% if not pickup_action_enabled %}hidden style="display: none"{% endif %}
      >
        {% if active_pickup_request %}
        <div class="pickup-chip status-{{ pickup_status_value|replace('_', '-') }}">
          Pickup {{ pickup_status_label }}
        </div>
        <p class="pickup-meta">
          Ref: <span>{{ pickup_request_number or '—' }}</span>
          {% if active_pickup_request.bulk_order_count and active_pickup_request.bulk_order_count > 1 %}·
          {{ active_pickup_request.bulk_order_count }} orders{% endif %}
        </p>
        <p class="pickup-meta">
          Packages: <span>{{ pickup_packages }}</span>
          {% if active_pickup_request.rider_user_id %}
          · Rider assigned
          {% else %}
          · Awaiting rider
          {% endif %}
        </p>
        <div class="pickup-actions-row">
          <button
            class="btn btn-accent"
            type="button"
            data-action="viewPickup"
            data-pickup-id="{{ active_pickup_request.id if active_pickup_request and (active_pickup_request.id is defined) else '' }}"
            data-order-id="{{ order_id }}"
          >
            <i data-lucide="truck"></i>
            View pickup
          </button>
          <button
            class="btn btn-secondary"
            type="button"
            data-action="assignRider"
            data-pickup-id="{{ active_pickup_request.id if active_pickup_request and (active_pickup_request.id is defined) else '' }}"
          >
            <i data-lucide="user-check"></i>
            Assign rider
          </button>
        </div>
        {% else %}
        <div class="pickup-chip pickup-none">No pickup scheduled</div>
        <button
          class="btn btn-accent"
          type="button"
          data-action="requestPickup"
          data-order-id="{{ order_id }}"
          {% if not pickup_action_enabled %}disabled{% endif %}
        >
          <i data-lucide="truck"></i>
          Request pickup
        </button>
        <p class="pickup-helper" {% if pickup_action_enabled %}style="display: none"{% endif %}>
          Move the order to "To Ship" to enable pickups.
        </p>
        {% endif %}
      </div>
      {% if not pickup_action_enabled %}
      <button class="btn btn-primary" type="button" data-action="printLabel" data-order-id="{{ order_id }}">
        <i data-lucide="printer"></i>
        Print label
      </button>
      <button class="btn btn-secondary" type="button" data-action="contactBuyer" data-order-id="{{ order_id }}">
        <i data-lucide="message-square"></i>
        Message buyer
      </button>
      {% endif %}
    </div>
    <div class="order-alert" role="status" aria-live="polite"></div>
  </div>
</div>
{% endmacro %}
