<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ product.name }} - Product Details</title>
    <!-- Header styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_header_buyer.css') }}"
      type="text/css"
    />
    <!-- Core product detail styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/product_detail.css') }}"
      type="text/css"
    />
    <!-- Supporting styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_add_to_cart_popup.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_product_dropdown_details.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/components/product_card.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_reviews_dropdown.css') }}"
      type="text/css"
    />
    <!-- Font Awesome for review icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      type="text/css"
    />
    <!-- Remix Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      type="text/css"
    />

    <!-- Fallbacks disabled: using Flask `url_for`-resolved static links above for reliability -->

    <!-- Inline critical CSS to ensure proper display -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #fff;
      }

      .container {
        max-width: 1200px;
        margin: 20px auto 0;
        padding: 20px;
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .product-images {
        flex: 1;
        min-width: 400px;
        max-width: 48%;
        display: flex;
        gap: 15px;
      }

      .thumbnail-images {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-shrink: 0;
      }

      .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border: 2px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .thumbnail.active {
        border-color: #8e44ad;
      }

      .main-image-container {
        flex: 1;
        position: relative;
      }

      .main-image {
        position: relative;
        background-color: #f8f8f8;
        border-radius: 8px;
        overflow: hidden;
        width: 100%;
        height: calc(100vh - 140px);
        min-height: 580px;
        max-height: 760px;
      }

      .main-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .product-details {
        flex: 1;
        min-width: 400px;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: calc(100vh - 140px);
        min-height: 580px;
        max-height: 760px;
      }

      .breadcrumb {
        display: flex;
        gap: 10px;
        font-size: 14px;
        margin-bottom: 20px;
      }

      .breadcrumb a {
        color: #666;
        text-decoration: none;
      }

      .product-title {
        font-size: 28px;
        margin-bottom: 15px;
        font-weight: 700;
      }

      .price-section {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .price-main {
        font-size: 24px;
        font-weight: 700;
        color: #8e44ad;
      }

      .currency {
        font-size: 16px;
        font-weight: normal;
      }

      .original-price {
        text-decoration: line-through;
        color: #999;
        margin-left: 10px;
      }

      .discount-badge {
        background-color: #8e44ad;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        margin-left: 10px;
        font-size: 14px;
      }

      .color-section,
      .size-section {
        margin-bottom: 10px;
      }

      .color-section[style*="display: none"] + .size-section {
        margin-top: 0;
      }

      .section-label {
        display: block;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .color-options {
        display: flex;
        gap: 12px;
      }

      .color-option {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        border: 2px solid #ddd;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: all 0.2s;
      }

      .color-option:hover:not(.disabled) {
        border-color: #8e44ad;
        transform: scale(1.05);
      }

      .color-option.active {
        border: 3px solid #8e44ad;
        box-shadow: 0 0 0 2px white, 0 0 0 5px #8e44ad;
      }

      .color-name {
        font-size: 10px;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        color: white;
        text-align: center;
      }

      .selected-color {
        font-weight: normal;
        color: #666;
      }

      .size-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .size-option {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        background: white;
        transition: all 0.2s;
      }

      .size-option:hover:not([disabled]) {
        border-color: #8e44ad;
      }

      .size-option.active {
        background-color: #8e44ad;
        color: white;
        border-color: #8e44ad;
      }

      .size-option[disabled],
      .size-option.disabled,
      .size-option.out-of-stock {
        opacity: 0.5;
        cursor: not-allowed;
        text-decoration: line-through;
        pointer-events: none;
      }

      .color-option.disabled,
      .color-option.out-of-stock {
        opacity: 0.3;
        cursor: not-allowed;
        pointer-events: none;
        position: relative;
      }

      .oos-label {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc143c;
        color: white;
        font-size: 8px;
        padding: 1px 3px;
        border-radius: 2px;
        font-weight: bold;
        z-index: 1;
      }

      .quantity-section {
        margin-bottom: 25px;
      }

      .quantity-counter {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: fit-content;
      }

      .quantity-btn {
        width: 40px;
        height: 40px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .quantity-btn[disabled] {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .quantity-input {
        width: 40px;
        height: 40px;
        border: none;
        text-align: center;
        font-size: 16px;
      }

      .stock-info {
        margin-top: 5px;
        font-size: 14px;
        color: #666;
      }

      .add-to-bag-btn {
        background-color: #8b5a96;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
        width: 100%;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
      }

      .add-to-bag-btn:hover {
        background-color: #7a4d86;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(139, 90, 150, 0.4);
      }

      .add-to-bag-btn:active {
        transform: translateY(0);
        box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
      }

      .add-to-bag-btn.adding {
        animation: addToBagPulse 0.6s ease-out;
      }

      @keyframes addToBagPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(139, 90, 150, 0.3);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
        }
      }

      .add-to-bag-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .add-to-bag-btn:hover::before {
        left: 100%;
      }

      /* Zoom functionality styles */
      .zoom-box {
        position: absolute;
        width: 150px;
        height: 150px;
        border: 2px solid #8e44ad;
        background: rgba(142, 68, 173, 0.1);
        pointer-events: none;
        display: none;
        z-index: 10;
      }

      .zoom-viewer {
        position: absolute;
        top: 0;
        left: 110%;
        width: 350px;
        height: 350px;
        border: 1px solid #ddd;
        background: white;
        overflow: hidden;
        display: none;
        z-index: 20;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .zoom-viewer img {
        width: 800px;
        height: 800px;
        object-fit: cover;
      }

      /* Responsive design for thumbnails */
      @media (max-width: 768px) {
        .product-images {
          flex-direction: column;
        }

        .thumbnail-images {
          flex-direction: row;
          justify-content: center;
          order: 2;
          margin-top: 15px;
        }

        .main-image-container {
          order: 1;
        }

        .main-image {
          height: 50vh;
          min-height: 350px;
          max-height: 500px;
        }

        .zoom-viewer {
          display: none !important;
        }
      }

      /* Additional styles for product page elements */
      .shipping-info {
        margin: 20px 0;
        padding: 15px 0;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        color: #666;
      }

      .shipping-info i {
        color: #8e44ad;
        margin-right: 10px;
      }

      /* Modal (report) styles */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-panel {
        background: #fff;
        width: 520px;
        max-width: 96%;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
          0 8px 25px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease-out;
        position: relative;
        max-height: 90vh;
        overflow: hidden;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .modal-title::before {
        content: "";
        width: 4px;
        height: 28px;
        background: linear-gradient(135deg, #dc2626, #ef4444);
        border-radius: 2px;
      }

      .modal-body {
        margin-top: 20px;
        color: #374151;
        line-height: 1.6;
      }

      .modal-notice {
        display: flex;
        gap: 14px;
        align-items: flex-start;
        background: linear-gradient(135deg, #fef2f2, #fff5f5);
        border: 1px solid #fed7d7;
        border-left: 4px solid #dc2626;
        color: #991b1b;
        padding: 16px;
        border-radius: 12px;
        margin: 16px 0 20px 0;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
      }

      .modal-notice .notice-icon {
        flex: 0 0 22px;
        width: 22px;
        height: 22px;
        margin-top: 2px;
      }

      .radio-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
      }

      .radio-list label {
        display: flex;
        gap: 12px;
        align-items: center;
        cursor: pointer;
        color: #111827;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        transition: all 0.2s ease;
        background: #fff;
      }

      .radio-list label:hover {
        border-color: #dc2626;
        background: #fef2f2;
        transform: translateX(2px);
      }

      .radio-list label:has(input:checked) {
        border-color: #dc2626;
        background: #fef2f2;
        color: #991b1b;
        font-weight: 600;
      }

      .radio-list input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: #dc2626;
      }

      .modal-actions {
        margin-top: 18px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }
      .btn {
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        font-weight: 600;
      }
      .btn.secondary {
        background: #fff;
        color: #111827;
        border-color: #d1d5db;
      }
      .btn.danger {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
      }
      .btn.danger:hover {
        background: #dc2626;
      }

      .modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
        gap: 16px;
      }

      .modal-actions .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        min-width: 100px;
      }

      .modal-close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #f3f4f6;
        border: none;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        color: #6b7280;
        transition: all 0.2s ease;
      }

      .modal-close-btn:hover {
        background: #e5e7eb;
        color: #374151;
        transform: scale(1.05);
      }

      .textarea-field {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin-top: 8px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        min-height: 100px;
        transition: all 0.2s ease;
      }

      .textarea-field:focus {
        outline: none;
        border-color: #dc2626;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
      }

      .field-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- Include Header -->
    {% include 'main/partials/_header_buyer.html' %}

    <!-- Report Modal (hidden) -->
    <div
      class="modal-backdrop"
      id="reportBackdrop"
      aria-hidden="true"
      style="display: none"
    >
      <div class="modal-panel" role="dialog" aria-modal="true" id="reportModal">
        <button
          type="button"
          class="modal-close-btn"
          aria-label="Close report dialog"
          onclick="closeReportModal()"
        >
          Ã—
        </button>
        <div class="modal-title">Report Product</div>
        <div class="modal-body">
          <p style="margin-bottom: 8px; font-size: 16px">
            Please select the reason for reporting this product:
          </p>
          <div class="modal-notice" role="status" aria-live="polite">
            <svg
              class="notice-icon"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
            >
              <path
                d="M12 9v4"
                stroke="#dc2626"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M12 17h.01"
                stroke="#dc2626"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                stroke="#dc2626"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                fill="none"
              />
            </svg>
            <div class="notice-text">
              <strong>Important:</strong> Your report will be reviewed by our
              moderation team. False or abusive reports may result in account
              restrictions.
            </div>
          </div>
          <form id="reportForm">
            <div class="radio-list">
              <label
                ><input
                  type="radio"
                  name="reason"
                  value="intellectual_property"
                />
                Intellectual Property Violation</label
              >
              <label
                ><input type="radio" name="reason" value="inappropriate" />
                Inappropriate Content</label
              >
              <label
                ><input type="radio" name="reason" value="fraud" /> Fraud /
                Scam</label
              >
              <label
                ><input type="radio" name="reason" value="spam" /> Spam</label
              >
              <label
                ><input type="radio" name="reason" value="not_product" /> Not a
                Product / Wrong Listing</label
              >
              <label
                ><input type="radio" name="reason" value="other" /> Other</label
              >
            </div>
            <div style="margin-top: 20px">
              <label class="field-label" for="reportDetails"
                >Additional details (optional)</label
              >
              <textarea
                id="reportDetails"
                name="details"
                class="textarea-field"
                placeholder="Please provide any additional information that might help our team review this report..."
                rows="4"
              ></textarea>
            </div>
            <input type="hidden" name="product_id" value="{{ product.id }}" />
          </form>
        </div>
        <div class="modal-actions">
          <button
            class="btn secondary"
            type="button"
            onclick="closeReportModal()"
          >
            Cancel
          </button>
          <button
            class="btn danger"
            type="button"
            id="submitReportBtn"
            onclick="submitReport()"
          >
            Submit Report
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Product Images Section -->
      <div class="product-images">
        <!-- Thumbnail Images on the Left -->
        <div class="thumbnail-images">
          <img
            src="{{ product.primaryImage }}"
            alt="{{ product.name }} front view"
            class="thumbnail active"
            data-index="0"
            onclick="changeMainImage(this, 0)"
          />
          <img
            src="{{ product.secondaryImage }}"
            alt="{{ product.name }} side view"
            class="thumbnail"
            data-index="1"
            onclick="changeMainImage(this, 1)"
          />
          <img
            src="{{ product.primaryImage }}"
            alt="{{ product.name }} back view"
            class="thumbnail"
            data-index="2"
            onclick="changeMainImage(this, 2)"
          />
        </div>

        <!-- Main Image Container on the Right -->
        <div class="main-image-container">
          <div class="main-image">
            <img
              id="mainImage"
              src="{{ product.primaryImage }}"
              alt="{{ product.name }}"
            />
            <div class="zoom-box" id="zoomBox"></div>
            <div class="zoom-viewer" id="zoomViewer">
              <img
                id="zoomImage"
                src="{{ product.primaryImage }}"
                alt="Zoomed view of {{ product.name }}"
              />
            </div>
            <div class="image-overlay-buttons">
              <button
                class="wishlist-btn"
                id="wishlistBtn"
                style="
                  background: rgba(255, 255, 255, 0.9);
                  border: none;
                  border-radius: 50%;
                  width: 44px;
                  height: 44px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                  position: absolute;
                  top: 15px;
                  right: 15px;
                "
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Details Section -->
      <div class="product-details" data-product-id="{{ product.id }}">
        <!-- Report Button in Upper Right -->
        <div
          class="report-container"
          style="
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px;
          "
        >
          <span
            class="report-text"
            style="
              font-size: 14px;
              color: #dc143c;
              text-decoration: underline;
              font-weight: 400;
            "
            >Report</span
          >
          <button
            class="report-btn-details"
            onclick="reportProduct()"
            style="
              background: none;
              border: none;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
              ></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </button>
        </div>

        <!-- Breadcrumb -->
        <nav
          class="breadcrumb"
          style="display: flex; gap: 10px; font-size: 14px; margin-bottom: 20px"
        >
          <a
            href="/"
            onclick="navigateToHome(event)"
            style="color: #666; text-decoration: none"
            >Home</a
          >
          <span style="color: #999">></span>
          <a
            href="/category/tops"
            onclick="navigateToCategory(event, 'tops')"
            style="color: #666; text-decoration: none"
            >Tops</a
          >
          <span style="color: #999">></span>
          <span style="color: #333">{{ product.name }}</span>
        </nav>

        <!-- Product Info -->
        <h1
          class="product-title"
          style="font-size: 28px; margin-bottom: 15px; font-weight: 700"
        >
          {{ product.name }}
        </h1>

        <!-- Price Section -->
        <div
          class="price-section"
          style="
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            gap: 10px;
          "
        >
          <div
            class="price-container"
            style="display: flex; align-items: baseline; gap: 15px"
          >
            <div
              class="price-main"
              style="font-size: 42px; font-weight: 700; color: #000"
            >
              â‚±{{ "{:,.2f}".format(product.price) }}
              <span
                class="currency"
                style="font-size: 16px; font-weight: normal"
                >PHP</span
              >
            </div>
            <div
              class="price-details"
              style="display: flex; align-items: center"
            >
              {% if product.originalPrice %}
              <span
                class="original-price"
                style="text-decoration: line-through; color: #999"
                >â‚±{{ "{:,.2f}".format(product.originalPrice) }}</span
              >
              {% if product.originalPrice > product.price %}
              <span
                class="discount-badge"
                style="
                  background-color: #8e44ad;
                  color: white;
                  padding: 2px 8px;
                  border-radius: 4px;
                  margin-left: 10px;
                  font-size: 14px;
                "
                >{{ ((product.originalPrice - product.price) /
                product.originalPrice * 100) | round | int }}% OFF</span
              >
              {% endif %} {% endif %}
            </div>
          </div>

          <!-- Sales Section (matching product card design) -->
          <div
            class="sales-section"
            style="
              display: flex;
              align-items: center;
              gap: 16px;
              font-size: 14px;
              color: #666;
              margin-bottom: 8px;
            "
          >
            <!-- Rating Container -->
            <div
              class="rating-container"
              style="display: flex; align-items: center; gap: 6px"
            >
              <!-- Star Rating -->
              <div
                class="star-rating"
                style="display: flex; align-items: center; gap: 2px"
              >
                {% set rating = product_rating or 0 %} {% for i in range(1, 6)
                %} {% if i <= rating %}
                <i
                  class="fas fa-star"
                  style="color: #ffc107; font-size: 14px"
                ></i>
                {% elif i - 0.5 <= rating %}
                <i
                  class="fas fa-star-half-alt"
                  style="color: #ffc107; font-size: 14px"
                ></i>
                {% else %}
                <i class="far fa-star" style="color: #ddd; font-size: 14px"></i>
                {% endif %} {% endfor %}
              </div>
              <!-- Rating Text -->
              <span class="rating-text" style="font-weight: 500; color: #333">
                {{ rating }}{% if rating_count %} ({{ rating_count }} {% if
                rating_count == 1 %}review{% else %}reviews{% endif %}){% endif
                %}
              </span>
            </div>

            <!-- Separator -->
            <span style="color: #ddd">â€¢</span>

            <!-- Sold Container -->
            <div
              class="sold-container"
              style="display: flex; align-items: center; gap: 5px"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#666"
                stroke-width="2"
              >
                <path
                  d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"
                ></path>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <path d="M16 10a4 4 0 0 1-8 0"></path>
              </svg>
              <span class="sold-text" style="font-weight: 500"
                >{{ product.soldCount or (range(50, 500) | random) }} sold</span
              >
            </div>
          </div>
        </div>

        <!-- Color Selection (updated design) -->
        <div
          class="color-section"
          {%
          if
          not
          stock_data
          %}style="display: none;"
          {%
          endif
          %}
        >
          <label
            class="section-label"
            style="
              font-size: 16px;
              font-weight: 600;
              margin-bottom: 12px;
              display: block;
            "
            >COLOR
            <span
              class="selected-color"
              style="font-weight: 400; color: #666; margin-left: 8px"
              >Select Color</span
            >
          </label>
          <div
            class="color-options"
            style="display: flex; gap: 12px; margin-bottom: 20px"
          >
            {% for color, sizes in stock_data.items() %} {% set total_stock =
            sizes.values()|sum %} {% set color_hex = variant_photos.get(color,
            {}).get('color_hex', '#000000') %}
            <button
              type="button"
              class="color-option{% if total_stock == 0 %} disabled out-of-stock{% endif %}"
              data-color="{{ color }}"
              data-stock="{{ sizes|tojson|e }}"
              data-total-stock="{{ total_stock }}"
              data-color-hex="{{ color_hex }}"
              title="{{ color }}{% if total_stock == 0 %} - Out of Stock{% endif %}"
              onclick="
                console.log('ðŸ–±ï¸ Onclick handler fired for: {{ color }}');
                this.classList.add('debug-clicked');
                setTimeout(() => this.classList.remove('debug-clicked'), 1000);
                if (window.simpleSelectColor) {
                  window.simpleSelectColor(this);
                } else {
                  console.error('âŒ window.simpleSelectColor not available');
                  alert('Color selection function not loaded!');
                }
              "
              style="
                width: 40px; 
                height: 40px; 
                border-radius: 50%; 
                border: 2px solid #ddd; 
                background-color: {{ color_hex }}; 
                cursor: pointer; 
                transition: all 0.2s ease;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
              "
            >
              {% if total_stock == 0 %}
              <span
                class="oos-overlay"
                style="
                  position: absolute;
                  top: -4px;
                  right: -4px;
                  background: #dc143c;
                  color: white;
                  font-size: 10px;
                  padding: 1px 3px;
                  border-radius: 50%;
                  font-weight: bold;
                  z-index: 1;
                  width: 16px;
                  height: 16px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                âœ•
              </span>
              {% endif %}
            </button>
            {% endfor %}
          </div>
        </div>

        <!-- Size Selection -->
        <div class="size-section">
          <label class="section-label">SIZE</label>
          <div class="size-options" id="sizeOptions">
            <div class="size-placeholder">
              Select a color to view available sizes
            </div>
          </div>
          <div class="size-info" id="modelInfo">
            <span>Model is 5'10", wearing a size S</span>
          </div>
        </div>
        <div class="shipping-info">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#1565c0"
            stroke-width="2"
            class="shipping-icon"
          >
            <rect x="1" y="3" width="15" height="13"></rect>
            <path d="m16 6 4 4v6"></path>
            <circle cx="5.5" cy="18.5" r="2.5"></circle>
            <circle cx="18.5" cy="18.5" r="2.5"></circle>
          </svg>
          <span
            >Free shipping on orders over â‚±2,000 | Easy returns within 30
            days</span
          >
        </div>

        <!-- Quantity and Stock Section -->
        <div class="quantity-section">
          <label class="section-label">QUANTITY</label>
          <div class="quantity-controls-group">
            <div class="quantity-selector">
              <button
                class="quantity-btn"
                onclick="decreaseQuantity()"
                id="decreaseBtn"
              >
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <input
                type="number"
                class="quantity-input"
                value="1"
                min="1"
                max="10"
                id="quantityInput"
                onchange="updateQuantity()"
              />
              <button
                class="quantity-btn"
                onclick="increaseQuantity()"
                id="increaseBtn"
              >
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
            <div class="stock-section">
              <span class="stock-indicator" id="stockIndicator"> 0 </span>
              <span class="stock-label">in stock</span>
            </div>
          </div>
        </div>

        <!-- Add to Bag Button (updated design) -->
        <button
          class="add-to-bag-btn"
          onclick="if(window.addToBag) window.addToBag(); else console.error('addToBag not found');"
          style="
            background-color: #000;
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          "
          onmouseover="this.style.backgroundColor='#333'"
          onmouseout="this.style.backgroundColor='#000'"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
          ADD TO BAG
        </button>
      </div>
    </div>

    <!-- Bottom Tabs -->
    <div class="bottom-tabs">
      <button
        class="tab-btn active"
        onclick="switchTab(this, 'product-details')"
      >
        Product Details
      </button>
      <button class="tab-btn" onclick="switchTab(this, 'ratings-reviews')">
        Ratings & Reviews
      </button>
    </div>

    <div class="tab-content">
      <div id="product-details" class="tab-panel active">
        <!-- Include Product Dropdown Details -->
        {% include 'main/partials/_product_dropdown_details.html' %}
      </div>
      <div id="ratings-reviews" class="tab-panel">
        <!-- Include Reviews Dropdown -->
        {% include 'main/partials/_reviews_dropdown.html' %}
      </div>
    </div>

    <!-- Include Footer -->
    {% include 'main/partials/_footer.html' %}

    <!-- Include Add to Cart Popup -->
    {% include 'main/partials/_add_to_cart_pop_new.html' %}

    <!-- Backup inline modal in case include fails -->
    <div
      id="backupCartModal"
      class="cart-modal-overlay"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      "
    >
      <div
        class="cart-modal"
        style="
          background: white;
          border-radius: 12px;
          width: 90%;
          max-width: 1000px;
          max-height: 90vh;
          overflow-y: auto;
          position: relative;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        "
      >
        <!-- Modal header -->
        <div
          style="
            padding: 40px 40px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              gap: 12px;
              font-size: 28px;
              font-weight: 700;
              color: #000;
            "
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M6 2l3 6v8a2 2 0 002 2h2a2 2 0 002-2V8l3-6" />
              <path d="M5 8h14l-1 13H6L5 8z" />
              <path d="M10 10v4" />
              <path d="M14 10v4" />
            </svg>
            You've Got Great Taste
            <span
              style="
                font-size: 16px;
                font-weight: 400;
                color: #666;
                margin-left: 8px;
              "
              >1 Item</span
            >
          </div>
          <button
            onclick="closeBackupModal()"
            style="
              background: none;
              border: none;
              font-size: 28px;
              color: #999;
              cursor: pointer;
              padding: 0;
              line-height: 1;
              width: 32px;
              height: 32px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            &times;
          </button>
        </div>

        <!-- Modal body -->
        <div style="padding: 40px; padding-top: 20px">
          <div
            style="
              display: flex;
              gap: 60px;
              align-items: flex-start;
              min-height: 200px;
            "
          >
            <!-- Left side - Product section -->
            <div style="flex: 1">
              <div style="display: flex; gap: 24px; align-items: flex-start">
                <div
                  style="
                    width: 120px;
                    height: 120px;
                    background-color: #f5f5f5;
                    border-radius: 8px;
                    flex-shrink: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    color: #999;
                    overflow: hidden;
                  "
                >
                  <img
                    id="backupProductImage"
                    src="/static/images/placeholder.jpg"
                    alt="Product"
                    style="
                      width: 100%;
                      height: 100%;
                      object-fit: cover;
                      border-radius: 8px;
                    "
                  />
                </div>
                <div style="flex: 1">
                  <div
                    id="backupProductName"
                    style="
                      font-size: 20px;
                      font-weight: 600;
                      color: #000;
                      margin-bottom: 12px;
                      line-height: 1.3;
                    "
                  >
                    Product Name
                  </div>
                  <div
                    style="font-size: 16px; color: #666; margin-bottom: 16px"
                  >
                    Size: <span id="backupSize">-</span>
                  </div>
                  <div
                    id="backupProductPrice"
                    style="font-size: 18px; font-weight: 600; color: #666"
                  >
                    â‚±0
                  </div>
                </div>
              </div>
            </div>

            <!-- Right side - Subtotal and actions -->
            <div
              style="
                flex: 0 0 300px;
                display: flex;
                flex-direction: column;
                gap: 20px;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 24px;
                "
              >
                <div style="font-size: 18px; font-weight: 600; color: #000">
                  Subtotal
                </div>
                <div
                  id="backupSubtotal"
                  style="font-size: 18px; font-weight: 600; color: #000"
                >
                  â‚±0
                </div>
              </div>

              <div style="display: flex; flex-direction: column; gap: 16px">
                <a
                  href="/cart"
                  style="
                    background-color: #dc2626;
                    color: white;
                    padding: 16px 24px;
                    border: none;
                    border-radius: 6px;
                    font-size: 16px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    width: 100%;
                    text-decoration: none;
                    display: inline-block;
                    text-align: center;
                  "
                  >VIEW BAG & CHECKOUT</a
                >
                <a
                  href="#"
                  onclick="closeBackupModal()"
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    color: #666;
                    text-decoration: none;
                    font-size: 16px;
                    font-weight: 500;
                    padding: 12px 8px;
                    transition: all 0.2s ease;
                  "
                >
                  Continue Shopping
                  <svg
                    viewBox="0 0 24 24"
                    style="
                      width: 16px;
                      height: 16px;
                      stroke: currentColor;
                      fill: none;
                      stroke-width: 2;
                    "
                  >
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12,5 19,12 12,19"></polyline>
                  </svg>
                </a>
              </div>
            </div>
          </div>

          <!-- Recommendations section -->
          <div style="margin-top: 40px">
            <h3
              style="
                font-size: 24px;
                font-weight: 700;
                color: #000;
                margin-bottom: 24px;
              "
            >
              Goes well with
            </h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 24px;
              "
            >
              <div style="text-align: left">
                <div
                  style="
                    width: 100%;
                    height: 200px;
                    background-color: #f5f5f5;
                    border-radius: 8px;
                    margin-bottom: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    color: #999;
                    overflow: hidden;
                  "
                >
                  <img
                    src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop"
                    alt="Clippable Nano Pouch"
                    style="width: 100%; height: 100%; object-fit: cover"
                  />
                </div>
                <div
                  style="
                    font-size: 16px;
                    font-weight: 600;
                    color: #000;
                    margin-bottom: 8px;
                    line-height: 1.3;
                  "
                >
                  Clippable Nano Pouch
                </div>
                <div style="font-size: 16px; font-weight: 600; color: #666">
                  â‚±1,200
                </div>
              </div>
              <div style="text-align: left">
                <div
                  style="
                    width: 100%;
                    height: 200px;
                    background-color: #f5f5f5;
                    border-radius: 8px;
                    margin-bottom: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    color: #999;
                    overflow: hidden;
                  "
                >
                  <img
                    src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop"
                    alt="New Crew Backpack"
                    style="width: 100%; height: 100%; object-fit: cover"
                  />
                </div>
                <div
                  style="
                    font-size: 16px;
                    font-weight: 600;
                    color: #000;
                    margin-bottom: 8px;
                    line-height: 1.3;
                  "
                >
                  New Crew Backpack 22L Updated
                </div>
                <div style="font-size: 16px; font-weight: 600; color: #666">
                  â‚±4,900
                </div>
              </div>
              <div style="text-align: left">
                <div
                  style="
                    width: 100%;
                    height: 200px;
                    background-color: #f5f5f5;
                    border-radius: 8px;
                    margin-bottom: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    color: #999;
                    overflow: hidden;
                  "
                >
                  <img
                    src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop"
                    alt="Everywhere Backpack"
                    style="width: 100%; height: 100%; object-fit: cover"
                  />
                </div>
                <div
                  style="
                    font-size: 16px;
                    font-weight: 600;
                    color: #000;
                    margin-bottom: 8px;
                    line-height: 1.3;
                  "
                >
                  Everywhere Backpack 22L Metal Hardware
                </div>
                <div style="font-size: 16px; font-weight: 600; color: #666">
                  â‚±4,900
                </div>
              </div>
              <div style="text-align: left">
                <div
                  style="
                    width: 100%;
                    height: 200px;
                    background-color: #f5f5f5;
                    border-radius: 8px;
                    margin-bottom: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    color: #999;
                    overflow: hidden;
                  "
                >
                  <img
                    src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop"
                    alt="City Essentials Pouch"
                    style="width: 100%; height: 100%; object-fit: cover"
                  />
                </div>
                <div
                  style="
                    font-size: 16px;
                    font-weight: 600;
                    color: #000;
                    margin-bottom: 8px;
                    line-height: 1.3;
                  "
                >
                  City Essentials Pouch Mini 2L
                </div>
                <div style="font-size: 16px; font-weight: 600; color: #666">
                  â‚±1,900
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Variant photo map: mapping color -> photo url(s). Backend should pass `variant_photos` dict. -->
    <script>
      // Example shape from backend: { "Black": {"primary": "/static/uploads/black1.jpg","secondary": "/static/uploads/black2.jpg"}, "Red": "/static/uploads/red.jpg" }
      window.variantPhotoMap = {{ variant_photos | default({}) | tojson | safe }};

      // Stock data for dynamic size selection based on color
      // Example shape: { "Black": {"XS": 15, "S": 25, "M": 30}, "White": {"XS": 12, "S": 18} }
      window.stockData = {{ stock_data | default({}) | tojson | safe }};
      window._pageStockData = window.stockData; // Alias for compatibility
      window.productId = {{ product.id | tojson | safe }};

      console.log('Stock data loaded:', window.stockData);
      console.log('Product ID:', window.productId);
      console.log('Variant photos loaded:', window.variantPhotoMap);

      // Initialize stock display after data is loaded
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for other initialization to complete
        setTimeout(function() {
          if (typeof updateStockDisplay === 'function') {
            console.log('Initializing stock display...');
            updateStockDisplay();
          }
        }, 100);
      });
    </script>
    <script>
      // Store info functions
      function chatWithStore() {
        // TODO: Implement chat functionality
        alert("Chat feature coming soon!");
      }

      function viewShop(sellerId) {
        // Navigate to store page
        window.location.href = `/store/${sellerId}`;
      }

      // Report modal helpers
      function reportProduct() {
        const backdrop = document.getElementById("reportBackdrop");
        if (!backdrop) return;
        backdrop.style.display = "flex";
        backdrop.setAttribute("aria-hidden", "false");
      }

      function closeReportModal() {
        const backdrop = document.getElementById("reportBackdrop");
        if (!backdrop) return;
        backdrop.style.display = "none";
        backdrop.setAttribute("aria-hidden", "true");
      }

      async function submitReport() {
        const btn = document.getElementById("submitReportBtn");
        if (btn) btn.disabled = true;

        try {
          const form = document.getElementById("reportForm");
          const fd = new FormData(form);
          const reason = fd.get("reason");
          const details = fd.get("details") || "";
          const productId = fd.get("product_id");

          if (!reason) {
            alert("Please select a reason for reporting.");
            if (btn) btn.disabled = false;
            return;
          }

          const resp = await fetch(`/api/product/${productId}/report`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reason: reason, details: details }),
          });

          const data = await resp.json();
          if (!resp.ok) {
            console.error("Report error", data);
            alert(data.error || "Failed to submit report");
            if (btn) btn.disabled = false;
            return;
          }

          alert(
            "Report submitted â€” thank you. Our team will review this product."
          );
          closeReportModal();
        } catch (e) {
          console.error("submitReport error", e);
          alert("An unexpected error occurred while sending the report.");
        } finally {
          if (btn) btn.disabled = false;
        }
      }
    </script>

    <!-- Main product detail JavaScript -->
    <script src="{{ url_for('static', filename='js/buyer_scripts/product_detail.js') }}"></script>

    <!-- Supporting scripts -->
    <script src="{{ url_for('static', filename='js/buyer_scripts/partials/_product_dropdown_details.js') }}"></script>
    <script src="{{ url_for('static', filename='js/buyer_scripts/partials/_reviews_dropdown.js') }}"></script>
    <script>
      // Stock indicator fix - override functions to handle malformed data
      (function () {
        "use strict";

        let selectedColor = null;
        let selectedSize = null;

        // Parse stock data (handles malformed JSON)
        // Removed parseStockData function with hardcoded fallback sizes
        // Size data is now fetched dynamically from the database via API

        // Override selectColor function
        // Removed conflicting inline selectColor and updateSizeOptions functions
        // These are now handled by the external product_detail.js file which calls the API

        // Removed conflicting inline selectSize function
        // This is now handled by the external product_detail.js file

        window.updateStockDisplay = function () {
          console.log(
            "Stock Fix: updateStockDisplay - Color:",
            selectedColor,
            "Size:",
            selectedSize
          );

          const stockIndicator = document.getElementById("stockIndicator");
          const quantityInput = document.getElementById("quantityInput");
          const addToBagBtn = document.querySelector(".add-to-bag-btn");
          const decreaseBtn = document.getElementById("decreaseBtn");
          const increaseBtn = document.getElementById("increaseBtn");

          if (!stockIndicator) return;

          if (!selectedColor || !selectedSize) {
            stockIndicator.textContent = "0";
            stockIndicator.className = "stock-indicator out-of-stock";
            if (quantityInput) {
              quantityInput.max = 0;
              quantityInput.value = 1;
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = true;
              addToBagBtn.textContent = "OUT OF STOCK";
              addToBagBtn.style.opacity = "0.6";
            }
            if (decreaseBtn) decreaseBtn.disabled = true;
            if (increaseBtn) increaseBtn.disabled = true;
            return;
          }

          const selectedSizeButton = document.querySelector(
            ".size-option.active"
          );
          let availableStock = 0;

          if (selectedSizeButton) {
            availableStock =
              parseInt(selectedSizeButton.getAttribute("data-stock")) || 0;
          }

          console.log("Available stock for", selectedSize, ":", availableStock);
          stockIndicator.textContent = availableStock;

          if (availableStock > 0) {
            stockIndicator.className = "stock-indicator in-stock";
            if (quantityInput) {
              quantityInput.max = availableStock;
              const currentQuantity = parseInt(quantityInput.value) || 1;
              if (currentQuantity > availableStock) {
                quantityInput.value = availableStock;
              }
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = false;
              addToBagBtn.textContent = "ADD TO BAG";
              addToBagBtn.style.opacity = "1";
            }
            updateQuantityControls();
          } else {
            stockIndicator.className = "stock-indicator out-of-stock";
            if (quantityInput) {
              quantityInput.max = 0;
              quantityInput.value = 1;
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = true;
              addToBagBtn.textContent = "OUT OF STOCK";
              addToBagBtn.style.opacity = "0.6";
            }
            if (decreaseBtn) decreaseBtn.disabled = true;
            if (increaseBtn) increaseBtn.disabled = true;
          }
        };

        // Quantity control functions
        window.decreaseQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let currentQuantity = parseInt(quantityInput.value) || 1;
          if (currentQuantity > 1) {
            quantityInput.value = currentQuantity - 1;
            updateQuantityControls();
          }
        };

        window.increaseQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let currentQuantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          if (currentQuantity < maxQuantity) {
            quantityInput.value = currentQuantity + 1;
            updateQuantityControls();
          }
        };

        window.updateQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let quantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          if (quantity < 1) {
            quantityInput.value = 1;
          } else if (quantity > maxQuantity && maxQuantity > 0) {
            quantityInput.value = maxQuantity;
          }

          updateQuantityControls();
        };

        function updateQuantityControls() {
          const quantityInput = document.getElementById("quantityInput");
          const decreaseBtn = document.getElementById("decreaseBtn");
          const increaseBtn = document.getElementById("increaseBtn");

          if (!quantityInput) return;

          const currentQuantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          // Update decrease button
          if (decreaseBtn) {
            decreaseBtn.disabled = currentQuantity <= 1;
          }

          // Update increase button
          if (increaseBtn) {
            increaseBtn.disabled =
              currentQuantity >= maxQuantity || maxQuantity <= 0;
          }

          console.log("ðŸŽ›ï¸ Quantity controls updated:", {
            current: currentQuantity,
            max: maxQuantity,
            decreaseDisabled: currentQuantity <= 1,
            increaseDisabled: currentQuantity >= maxQuantity,
          });
        }

        // Make updateQuantityControls globally accessible
        window.updateQuantityControls = updateQuantityControls;

        // Add to bag functionality
        window.addToBag = function () {
          try {
            console.log("ðŸ›’ Add to bag clicked!");

            // Validate selections first
            const selectedColor = getSelectedColor();
            const selectedSize = getSelectedSize();
            const quantity = parseInt(document.getElementById("quantityInput")?.value || 1);

            console.log("Current selections:", {
              color: selectedColor,
              size: selectedSize,
              quantity: quantity
            });

            // Validate required selections
            if (!selectedColor) {
              alert("Please select a color first");
              return;
            }

            if (!selectedSize) {
              alert("Please select a size first");
              return;
            }

            if (quantity < 1) {
              alert("Please select a valid quantity");
              return;
            }

            // Check if button is disabled due to stock
            const addToBagBtn = document.querySelector(".add-to-bag-btn");
            if (addToBagBtn && addToBagBtn.disabled) {
              console.log("â›” Button is disabled - likely out of stock");
              alert("This item is currently out of stock for the selected size");
              return;
            }

            // Try to show the new modal first
            const cartModalOverlay = document.getElementById("cartModalOverlay");
            if (cartModalOverlay) {
              console.log("ðŸ“± Using new cart modal");
              updateCartModal(selectedColor, selectedSize, quantity);
              showCartModal();
            } else {
              // Fallback to dynamic modal
              console.log("ðŸ“± Using dynamic modal fallback");
              createDynamicModal();
            }

          } catch (error) {
            console.error("âŒ Error in addToBag:", error);
            // Last resort: show backup modal
            showBackupModal();
          };

        // Get currently selected color
        function getSelectedColor() {
          const selectedColorOption = document.querySelector(
            ".color-option.active"
          );
          return selectedColorOption ? selectedColorOption.dataset.color : null;
        }

        // Get currently selected size
        function getSelectedSize() {
          const selectedSizeOption = document.querySelector(
            ".size-option.active"
          );
          return selectedSizeOption ? selectedSizeOption.dataset.size : null;
        }

        // Get current quantity
        function getSelectedQuantity() {
          const quantityInput = document.getElementById("quantityInput");
          return quantityInput ? parseInt(quantityInput.value) || 1 : 1;
        }

        // Update cart modal with current selections
        function updateCartModal(color, size, quantity) {
          console.log("ðŸŽ¨ Updating cart modal with:", {
            color,
            size,
            quantity,
          });

          // Get variant-specific information
          let productPrice = 'â‚±0';
          let productImage = '/static/images/placeholder.jpg';
          let numericPrice = 0;

          // Try to get variant-specific price and image
          const selectedColorBtn = document.querySelector('.color-option.active');
          const selectedSizeBtn = document.querySelector('.size-option.active');

          if (selectedColorBtn) {
            const variantImage = selectedColorBtn.dataset.image;
            if (variantImage) {
              productImage = variantImage;
            }
          }

          if (selectedSizeBtn) {
            const sizePrice = selectedSizeBtn.dataset.price;
            if (sizePrice) {
              numericPrice = parseFloat(sizePrice);
              productPrice = `â‚±${numericPrice.toLocaleString()}`;
            }
          }

          // Fallback to main product price if no variant price
          if (numericPrice === 0) {
            const mainPriceEl = document.querySelector('.current-price');
            if (mainPriceEl) {
              productPrice = mainPriceEl.textContent;
              const priceMatch = productPrice.match(/[\d,]+/);
              if (priceMatch) {
                numericPrice = parseFloat(priceMatch[0].replace(/,/g, ''));
              }
            }
          }

          // Fallback to main image if no variant image
          if (productImage === '/static/images/placeholder.jpg') {
            const mainImage = document.querySelector('.main-image img');
            if (mainImage) {
              productImage = mainImage.src;
            }
          }

          // Calculate subtotal
          const subtotal = numericPrice * quantity;
          const subtotalFormatted = `â‚±${subtotal.toLocaleString()}`;

          // Update color display
          const colorDisplay = document.getElementById("cartModalSelectedColor");
          if (colorDisplay) {
            colorDisplay.textContent = color;
          }

          // Update size display
          const sizeDisplay = document.getElementById("cartModalSelectedSize");
          if (sizeDisplay) {
            sizeDisplay.textContent = size;
          }

          // Update quantity display
          const quantityDisplay = document.getElementById("cartModalSelectedQuantity");
          if (quantityDisplay) {
            quantityDisplay.textContent = quantity;
          }

          // Update item count in modal header
          const itemCount = document.querySelector(".cart-item-count");
          if (itemCount) {
            itemCount.textContent = quantity === 1 ? "1 Item" : `${quantity} Items`;
          }

          // Update product price in modal
          const modalPrice = document.querySelector(".cart-product-price");
          if (modalPrice) {
            modalPrice.textContent = productPrice;
          }

          // Update subtotal in modal
          const modalSubtotal = document.querySelector(".cart-subtotal-amount");
          if (modalSubtotal) {
            modalSubtotal.textContent = subtotalFormatted;
          }

          // Add item to cart via API
          addToCartAPI({
            product_id: {{ product.id }},
            color: color,
            size: size,
            quantity: quantity
          });

          // Update product image in modal
          const modalImage = document.querySelector(".cart-product-image img");
          const currentMainImage = document.querySelector(
            ".main-product-image"
          );
          if (modalImage && currentMainImage) {
            modalImage.src = currentMainImage.src;
            modalImage.alt = currentMainImage.alt;
            console.log("ðŸ–¼ï¸ Updated modal image to:", modalImage.src);
          }
        }

        // Show cart modal with success animation
        function showCartModal() {
          try {
            console.log("ðŸ“± Opening cart modal with success animation");

            // First show the success animation
            const successAnimation = document.getElementById(
              "cartSuccessAnimation"
            );
            if (successAnimation) {
              console.log("âœ… Showing success animation first");
              successAnimation.classList.add("active");
              document.body.style.overflow = "hidden";

              // Hide success animation after 2 seconds and show modal
              setTimeout(() => {
                successAnimation.classList.remove("active");
                console.log("ðŸ”„ Success animation complete, showing modal");

                // Show the modal after success animation
                setTimeout(() => {
                  const modal = document.getElementById("cartModalOverlay");
                  if (modal) {
                    console.log("ðŸ“± Opening main cart modal");
                    modal.classList.add("active");
                    document.body.style.overflow = "hidden";
                  } else {
                    console.error("âŒ Cart modal not found, using fallback");
                    createDynamicModal();
                  }
                }, 300);
              }, 2000);
            } else {
              console.log(
                "ðŸ”„ Success animation not found, showing modal directly"
              );
              // Fallback to direct modal if success animation not found
              const modal = document.getElementById("cartModalOverlay");
              if (modal) {
                modal.classList.add("active");
                modal.style.display = "flex";
                modal.style.opacity = "1";
                modal.style.visibility = "visible";
                document.body.style.overflow = "hidden";
              } else {
                createDynamicModal();
              }
            }
          } catch (error) {
            console.error("âŒ Error in showCartModal:", error);
            createDynamicModal();
          }
        }

        // Backup modal close function
        window.closeBackupModal = function () {
          const modal = document.getElementById("backupCartModal");
          if (modal) {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
          }
        };

        // Show backup modal function
        window.showBackupModal = function () {
          const modal = document.getElementById("backupCartModal");
          if (modal) {
            // Get current product information with variant data
            const productName = document.querySelector('.product-name')?.textContent || 'Product';
            const selectedColor = window.selectedColor || getSelectedColor() || 'Default';
            const selectedSize = window.selectedSize || getSelectedSize() || 'ONE SIZE';
            const quantity = parseInt(document.getElementById("quantityInput")?.value || 1);

            // Get variant-specific information
            let productPrice = 'â‚±0';
            let productImage = '/static/images/placeholder.jpg';
            let numericPrice = 0;

            // Try to get variant-specific price and image
            const selectedColorBtn = document.querySelector('.color-option.active');
            const selectedSizeBtn = document.querySelector('.size-option.active');

            if (selectedColorBtn) {
              const variantImage = selectedColorBtn.dataset.image;
              if (variantImage) {
                productImage = variantImage;
              }
            }

            if (selectedSizeBtn) {
              const sizePrice = selectedSizeBtn.dataset.price;
              if (sizePrice) {
                numericPrice = parseFloat(sizePrice);
                productPrice = `â‚±${numericPrice.toLocaleString()}`;
              }
            }

            // Fallback to main product price if no variant price
            if (numericPrice === 0) {
              const mainPriceEl = document.querySelector('.current-price');
              if (mainPriceEl) {
                productPrice = mainPriceEl.textContent;
                const priceMatch = productPrice.match(/[\d,]+/);
                if (priceMatch) {
                  numericPrice = parseFloat(priceMatch[0].replace(/,/g, ''));
                }
              }
            }

            // Fallback to main image if no variant image
            if (productImage === '/static/images/placeholder.jpg') {
              const mainImage = document.querySelector('.main-image img');
              if (mainImage) {
                productImage = mainImage.src;
              }
            }

            // Calculate subtotal
            const subtotal = numericPrice * quantity;
            const subtotalFormatted = `â‚±${subtotal.toLocaleString()}`;

            // Update modal content
            const productNameEl = document.getElementById('backupProductName');
            const productPriceEl = document.getElementById('backupProductPrice');
            const sizeEl = document.getElementById('backupSize');
            const subtotalEl = document.getElementById('backupSubtotal');
            const imageEl = document.getElementById('backupProductImage');

            if (productNameEl) productNameEl.textContent = productName;
            if (productPriceEl) productPriceEl.textContent = productPrice;
            if (sizeEl) sizeEl.textContent = selectedSize;
            if (subtotalEl) subtotalEl.textContent = subtotalFormatted;
            if (imageEl) imageEl.src = productImage;

            // Add item to cart via API
            addToCartAPI({
              product_id: {{ product.id }},
              color: selectedColor,
              size: selectedSize,
              quantity: quantity
            });

            modal.style.display = "flex";
            document.body.style.overflow = "hidden";
          }
        };

        // Create dynamic modal as last resort
        function createDynamicModal() {
          console.log("ðŸš¨ Creating dynamic modal with variant data");

          // Remove existing dynamic modal if any
          const existing = document.getElementById("dynamicCartModal");
          if (existing) existing.remove();

          // Get current product information
          const productName = document.querySelector('.product-name')?.textContent || 'Product';
          const selectedColor = window.selectedColor || getSelectedColor() || 'Default';
          const selectedSize = window.selectedSize || getSelectedSize() || 'ONE SIZE';
          const quantity = parseInt(document.getElementById("quantityInput")?.value || 1);

          // Get variant-specific information
          let productPrice = 'â‚±0';
          let productImage = '/static/images/placeholder.jpg';
          let numericPrice = 0;

          // Try to get variant-specific price and image
          const selectedColorBtn = document.querySelector('.color-option.active');
          const selectedSizeBtn = document.querySelector('.size-option.active');

          if (selectedColorBtn) {
            // Get variant image from the selected color button
            const variantImage = selectedColorBtn.dataset.image;
            if (variantImage) {
              productImage = variantImage;
            }
          }

          if (selectedSizeBtn) {
            // Get price from the selected size button
            const sizePrice = selectedSizeBtn.dataset.price;
            if (sizePrice) {
              numericPrice = parseFloat(sizePrice);
              productPrice = `â‚±${numericPrice.toLocaleString()}`;
            }
          }

          // Fallback to main product price if no variant price
          if (numericPrice === 0) {
            const mainPriceEl = document.querySelector('.current-price');
            if (mainPriceEl) {
              productPrice = mainPriceEl.textContent;
              // Extract numeric value
              const priceMatch = productPrice.match(/[\d,]+/);
              if (priceMatch) {
                numericPrice = parseFloat(priceMatch[0].replace(/,/g, ''));
              }
            }
          }

          // Fallback to main image if no variant image
          if (productImage === '/static/images/placeholder.jpg') {
            const mainImage = document.querySelector('.main-image img');
            if (mainImage) {
              productImage = mainImage.src;
            }
          }

          // Calculate subtotal
          const subtotal = numericPrice * quantity;
          const subtotalFormatted = `â‚±${subtotal.toLocaleString()}`;

          console.log("Modal data:", {
            productName,
            selectedColor,
            selectedSize,
            quantity,
            productPrice,
            productImage,
            subtotal: subtotalFormatted
          });

          // Add item to cart via API
          addToCartAPI({
            product_id: {{ product.id }},
            color: selectedColor,
            size: selectedSize,
            quantity: quantity
          });

          const modal = document.createElement("div");
          modal.id = "dynamicCartModal";
          modal.innerHTML = `
            <div class="cart-modal-overlay active" onclick="closeDynamicModal(event)" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 1; visibility: visible; transition: all 0.3s ease;">
              <div class="cart-modal" onclick="event.stopPropagation()" style="background: white; border-radius: 12px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; position: relative; transform: translateY(0); transition: transform 0.3s ease; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);">

                <!-- Modal header -->
                <div class="cart-modal-header" style="padding: 40px 40px 0; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: none;">
                  <div class="cart-modal-title" style="display: flex; align-items: center; gap: 12px; font-size: 28px; font-weight: 700; color: #000;">
                    <svg class="cart-bag-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M6 2l3 6v8a2 2 0 002 2h2a2 2 0 002-2V8l3-6"/>
                      <path d="M5 8h14l-1 13H6L5 8z"/>
                      <path d="M10 10v4"/>
                      <path d="M14 10v4"/>
                    </svg>
                    You've Got Great Taste
                    <span class="cart-item-count" style="font-size: 16px; font-weight: 400; color: #666; margin-left: 8px;">1 Item</span>
                  </div>
                  <button class="cart-close-button" onclick="closeDynamicModal()" style="background: none; border: none; font-size: 28px; color: #999; cursor: pointer; padding: 0; line-height: 1; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="cart-modal-body" style="padding: 40px; padding-top: 20px;">
                  <div class="cart-modal-content-wrapper" style="display: flex; gap: 60px; align-items: flex-start; min-height: 200px;">

                    <!-- Left side - Product section -->
                    <div class="cart-left-section" style="flex: 1;">
                      <div class="cart-product-section" style="display: flex; gap: 24px; align-items: flex-start;">
                        <div class="cart-product-image" style="width: 120px; height: 120px; background-color: #f5f5f5; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999; overflow: hidden;">
                          <img src="${productImage}" alt="${productName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        </div>
                        <div class="cart-product-details" style="flex: 1;">
                          <div class="cart-product-name" style="font-size: 20px; font-weight: 600; color: #000; margin-bottom: 12px; line-height: 1.3;">${productName}</div>
                          <div class="cart-product-color" style="font-size: 16px; color: #666; margin-bottom: 8px;">Color: ${selectedColor}</div>
                          <div class="cart-product-size" style="font-size: 16px; color: #666; margin-bottom: 16px;">Size: ${selectedSize}</div>
                          <div class="cart-product-price" style="font-size: 18px; font-weight: 600; color: #666;">${productPrice}</div>
                        </div>
                      </div>
                    </div>

                    <!-- Right side - Subtotal and actions -->
                    <div class="cart-right-section" style="flex: 0 0 300px; display: flex; flex-direction: column; gap: 20px;">
                      <div class="cart-subtotal-section" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div class="cart-subtotal-label" style="font-size: 18px; font-weight: 600; color: #000;">Subtotal</div>
                        <div class="cart-subtotal-amount" style="font-size: 18px; font-weight: 600; color: #000;">${subtotalFormatted}</div>
                      </div>

                      <div class="cart-action-buttons" style="display: flex; flex-direction: column; gap: 16px;">
                        <a class="cart-checkout-button" href="/cart" style="background-color: #dc2626; color: white; padding: 16px 24px; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.2s ease; width: 100%; text-decoration: none; display: inline-block; text-align: center;">VIEW BAG & CHECKOUT</a>
                        <a href="#" class="cart-continue-shopping" onclick="closeDynamicModal()" style="display: flex; align-items: center; justify-content: center; gap: 8px; color: #666; text-decoration: none; font-size: 16px; font-weight: 500; padding: 12px 8px; transition: all 0.2s ease;">
                          Continue Shopping
                          <svg class="cart-arrow-icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12,5 19,12 12,19"></polyline>
                          </svg>
                        </a>
                      </div>
                    </div>
                  </div>

                  <!-- Recommendations section -->
                  <div class="cart-recommendations" style="margin-top: 40px; padding-top: 0;">
                    <h3 class="cart-recommendations-title" style="font-size: 24px; font-weight: 700; color: #000; margin-bottom: 24px;">Goes well with</h3>
                    <div class="cart-recommendations-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px;">
                      <div class="cart-recommendation-item" style="text-align: left;">
                        <div class="cart-recommendation-image" style="width: 100%; height: 200px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999; overflow: hidden;">
                          <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" alt="Clippable Nano Pouch" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="cart-recommendation-name" style="font-size: 16px; font-weight: 600; color: #000; margin-bottom: 8px; line-height: 1.3;">Clippable Nano Pouch</div>
                        <div class="cart-recommendation-price" style="font-size: 16px; font-weight: 600; color: #666;">â‚±1,200</div>
                      </div>
                      <div class="cart-recommendation-item" style="text-align: left;">
                        <div class="cart-recommendation-image" style="width: 100%; height: 200px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999; overflow: hidden;">
                          <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" alt="New Crew Backpack" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="cart-recommendation-name" style="font-size: 16px; font-weight: 600; color: #000; margin-bottom: 8px; line-height: 1.3;">New Crew Backpack 22L Updated</div>
                        <div class="cart-recommendation-price" style="font-size: 16px; font-weight: 600; color: #666;">â‚±4,900</div>
                      </div>
                      <div class="cart-recommendation-item" style="text-align: left;">
                        <div class="cart-recommendation-image" style="width: 100%; height: 200px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999; overflow: hidden;">
                          <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" alt="Everywhere Backpack" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="cart-recommendation-name" style="font-size: 16px; font-weight: 600; color: #000; margin-bottom: 8px; line-height: 1.3;">Everywhere Backpack 22L Metal Hardware</div>
                        <div class="cart-recommendation-price" style="font-size: 16px; font-weight: 600; color: #666;">â‚±4,900</div>
                      </div>
                      <div class="cart-recommendation-item" style="text-align: left;">
                        <div class="cart-recommendation-image" style="width: 100%; height: 200px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999; overflow: hidden;">
                          <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" alt="City Essentials Pouch" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="cart-recommendation-name" style="font-size: 16px; font-weight: 600; color: #000; margin-bottom: 8px; line-height: 1.3;">City Essentials Pouch Mini 2L</div>
                        <div class="cart-recommendation-price" style="font-size: 16px; font-weight: 600; color: #666;">â‚±1,900</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          document.body.style.overflow = "hidden";
          console.log("âœ… Dynamic modal created and displayed with new design");
        }

        // Add to cart API function
        function addToCartAPI(itemData) {
          console.log("ðŸ›’ Adding to cart:", itemData);

          fetch('/add-to-cart', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(itemData)
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('ðŸ“¡ Server response:', data);
            if (data.success) {
              console.log('âœ… Successfully added to cart:', data);

              // Update cart count in header if available
              const cartCountEl = document.querySelector('.cart-count');
              if (cartCountEl && data.cart_count) {
                cartCountEl.textContent = data.cart_count;
              }
            } else {
              console.error('âŒ Failed to add to cart:', data.error);
              alert('Failed to add item to cart: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('âŒ Error adding to cart:', error);
            alert('Error adding item to cart. Please try again.');
          });
        }

        // Close dynamic modal function
        function closeDynamicModal(event) {
          // Only close if clicking the overlay or close button
          if (event && event.target !== event.currentTarget && !event.target.classList.contains("cart-close-button")) {
            return;
          }

          const modal = document.getElementById("dynamicCartModal");
          if (modal) {
            modal.remove();
            document.body.style.overflow = "auto";
          }
        }

        // Make functions available globally
        window.addToCartAPI = addToCartAPI;
        window.closeDynamicModal = closeDynamicModal;

        // Auto-initialize
        console.log("Stock indicator fix script loaded successfully");

        // Initialize product controls
        setTimeout(() => {
          initializeProductControls();

          // Add debugging info
          console.log("ðŸ” Available debug functions:");
          console.log("- window.debugAddToBagButton() - Check button state");
          console.log("- window.debugStockData() - Check stock data");
          console.log("- window.testColorSelection() - Test color selection");
          console.log("- window.testCartModal() - Test cart modal display");
          console.log(
            "- window.forceShowModal() - Force show modal (bypass all checks)"
          );
          console.log(
            "- window.testDynamicModal() - Test dynamic modal creation"
          );
          console.log(
            "- window.testAddToBagButton() - Test button click detection"
          );
        }, 500);
        setTimeout(() => {
          console.log("Initializing stock system...");
          const colorOptions = document.querySelectorAll(".color-option");
          console.log("Found", colorOptions.length, "color options");
          if (colorOptions.length === 1) {
            console.log("Auto-selecting single color");
            selectColor(colorOptions[0]);
          }
        }, 100);
      })();
    </script>
    <script>
      // Initialize zoom functionality on the main image
      document.addEventListener("DOMContentLoaded", function () {
        // Add zoom functionality to the main image
        const mainImage = document.querySelector(".main-image");
        if (mainImage) {
          mainImage.addEventListener("mousemove", showZoomBox);
          mainImage.addEventListener("mouseleave", hideZoomBox);
        }

        // Initialize thumbnail gallery
        const thumbnails = document.querySelectorAll(".thumbnail-image");
        thumbnails.forEach((thumbnail, index) => {
          thumbnail.addEventListener("click", function () {
            changeMainImage(this, index);
          });
        });

        // Set the first thumbnail as active by default if available
        if (thumbnails.length > 0) {
          thumbnails[0].click();
        }

        // Ensure stock display is updated on page load
        try {
          updateSizeAvailability();
          updateColorAvailability();
          updateStockDisplay();
        } catch (e) {
          console.warn("Error initializing stock display:", e);
        }

        // Add to bag button functionality with better timing
        setTimeout(() => {
          const addToBagBtn = document.querySelector(".add-to-bag-btn");
          if (addToBagBtn) {
            console.log("ðŸ›’ Add to bag button found and event listener added");

            // Remove any existing onclick attribute to avoid conflicts
            addToBagBtn.removeAttribute("onclick");

            // Remove any existing event listeners
            const newBtn = addToBagBtn.cloneNode(true);
            addToBagBtn.parentNode.replaceChild(newBtn, addToBagBtn);

            // Add click event listener
            newBtn.addEventListener("click", function (event) {
              event.preventDefault();
              event.stopPropagation();
              console.log("ðŸ’¯ Button click event fired!");

              if (typeof window.addToBag === "function") {
                window.addToBag();
              } else {
                console.error("âŒ window.addToBag function not found!");
              }
            });

            // Also add a backup onclick handler
            newBtn.onclick = function (event) {
              event.preventDefault();
              console.log("ðŸ’¯ Backup onclick fired!");
              if (typeof window.addToBag === "function") {
                window.addToBag();
              }
            };

            console.log("âœ… Event listeners attached successfully");
          } else {
            console.error("âŒ Add to bag button not found!");
          }
        }, 100);

        // Initialize quantity buttons
        try {
          updateQuantityButtons();
        } catch (e) {
          console.warn("Error initializing quantity buttons:", e);
        }

        console.log("Product detail scripts initialized");
      });

      // Add fallback CSS loading check
      window.addEventListener("load", function () {
        // Debug information about the page setup
        console.log("Product data:", {
          name: "{{ product.name }}",
          price: "{{ product.price }}",
          primaryImage: "{{ product.primaryImage }}",
          secondaryImage: "{{ product.secondaryImage }}",
        });

        // List all loaded scripts for debugging
        const scripts = document.querySelectorAll("script");
        console.log("Loaded scripts:");
        scripts.forEach((script, index) => {
          console.log(`Script ${index + 1}:`, script.src || "Inline script");
        });

        // Check if CSS is loaded correctly
        const styleSheets = document.styleSheets;
        console.log("All stylesheets:", styleSheets.length);
        let cssLoaded = false;

        for (let i = 0; i < styleSheets.length; i++) {
          try {
            console.log(`Stylesheet ${i + 1}:`, styleSheets[i].href);
            if (
              styleSheets[i].href &&
              styleSheets[i].href.includes("product_detail.css")
            ) {
              cssLoaded = true;
              break;
            }
          } catch (e) {
            console.error("Error accessing stylesheet:", e);
          }
        }

        if (!cssLoaded) {
          console.warn("Product detail CSS might not be loaded correctly");
          // Apply minimal styling through JS to ensure the page is still usable
          const container = document.querySelector(".container");
          if (container) {
            container.style.maxWidth = "1200px";
            container.style.margin = "20px auto 0";
            container.style.padding = "20px";
          }

          // Apply basic styling to product images
          const mainImageContainer = document.querySelector(
            ".main-image-container"
          );
          if (mainImageContainer) {
            mainImageContainer.style.width = "100%";
            mainImageContainer.style.maxHeight = "500px";
            mainImageContainer.style.overflow = "hidden";
            mainImageContainer.style.position = "relative";
          }

          // Make sure thumbnails are visible
          const thumbnailContainer = document.querySelector(
            ".thumbnail-container"
          );
          if (thumbnailContainer) {
            thumbnailContainer.style.display = "flex";
            thumbnailContainer.style.flexWrap = "wrap";
            thumbnailContainer.style.gap = "10px";
            thumbnailContainer.style.marginTop = "10px";
          }

          // Apply additional styles if needed
          document.querySelector(".product-title").style.fontSize = "24px";
          document.querySelector(".product-title").style.marginTop = "20px";
          document.querySelector(".price-section").style.marginTop = "10px";
        } else {
          console.log("Product detail CSS loaded successfully");
        }
      });
    </script>
    <!-- Debug script to verify functionality -->
    <script>
      // Verify our functions are loaded
      setTimeout(() => {
        console.log("ðŸ” Checking function availability:");
        console.log(
          "- window.simpleSelectColor:",
          typeof window.simpleSelectColor
        );
        console.log("- selectColor:", typeof selectColor);

        const colorOptions = document.querySelectorAll(".color-option");
        const sizeContainer = document.getElementById("sizeOptions");
        console.log("ðŸ“Š DOM elements:");
        console.log("- Color options found:", colorOptions.length);
        console.log("- Size container found:", !!sizeContainer);

        if (colorOptions.length > 0) {
          console.log("âœ… Product detail page setup looks good!");
        } else {
          console.log(
            "âš ï¸ No color options found - may be a product without variants"
          );
        }
      }, 1000);
    </script>

    <!-- Fallback CSS for debug -->
    <style>
      /* Aggressive color option active state */
      .color-option.active {
        border-color: #8e44ad !important;
        transform: scale(1.1) !important;
        box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.3) !important;
        z-index: 15 !important;
        position: relative !important;
      }

      /* Ensure color options are clickable */
      .color-option {
        pointer-events: auto !important;
        cursor: pointer !important;
        z-index: 10 !important;
      }

      /* Size option active state */
      .size-option.active {
        border-color: #8e44ad !important;
        background-color: #8e44ad !important;
        color: white !important;
        transform: scale(1.05) !important;
        z-index: 10 !important;
      }

      /* Ensure size options are clickable */
      .size-option {
        pointer-events: auto !important;
        cursor: pointer !important;
      }

      /* Make sure overlays don't block clicks */
      .oos-overlay {
        pointer-events: none !important;
      }

      /* Debug styles */
      .color-option:hover {
        outline: 2px solid orange !important;
      }

      .debug-clicked {
        outline: 3px solid red !important;
      }
    </style>

    <!-- Load order check -->
    <script>
      console.log("ðŸ“„ Product detail template scripts loaded");

      // Define simple color selection function directly in template to ensure availability
      window.simpleSelectColor = function (button) {
        console.log("=== SIMPLE SELECT COLOR CALLED ===", button.dataset.color);

        // Remove active from all color buttons
        document.querySelectorAll(".color-option").forEach((btn) => {
          btn.classList.remove("active");
          btn.style.transform = "";
          btn.style.boxShadow = "";
        });

        // Add active to clicked button
        button.classList.add("active");
        button.style.transform = "scale(1.1)";
        button.style.boxShadow = "0 0 0 3px rgba(142, 68, 173, 0.3)";

        // Update selected color text
        const span = document.querySelector(".selected-color");
        if (span) span.textContent = button.dataset.color;

        // Update global state
        window.selectedColor = button.dataset.color;

        console.log("âœ… Color selected:", button.dataset.color);

        // Reset stock indicator when color changes (before size selection)
        const stockIndicator = document.getElementById("stockIndicator");
        if (stockIndicator) {
          stockIndicator.textContent = "Select size";
          stockIndicator.className = "stock-indicator";
        }

        // Reset quantity input
        const quantityInput = document.getElementById("quantityInput");
        if (quantityInput) {
          quantityInput.value = 1;
          quantityInput.max = 0;
        }

        // Update quantity button states
        if (typeof updateQuantityControls === "function") {
          updateQuantityControls();
        }

        // Load sizes for this color
        window.loadSizesForColor(button.dataset.color, button);
      };

      // Function to load sizes for selected color
      window.loadSizesForColor = function (colorName, colorButton) {
        console.log("ðŸ“ Loading sizes for color:", colorName);

        const sizeContainer = document.getElementById("sizeOptions");
        if (!sizeContainer) {
          console.error("âŒ Size container not found!");
          return;
        }

        try {
          // Get stock data from button with robust parsing
          let stockData = {};
          const rawStockData = colorButton.dataset.stock || "{}";

          console.log("ðŸ“‹ Raw stock data:", rawStockData);
          console.log("ðŸ“‹ Raw stock data type:", typeof rawStockData);
          console.log("ðŸ“‹ Raw stock data length:", rawStockData.length);

          try {
            // First try to parse as JSON
            stockData = JSON.parse(rawStockData);
          } catch (jsonError) {
            console.warn(
              "âš ï¸ JSON parse failed, trying alternative parsing:",
              jsonError.message
            );

            // Try to fix common JSON issues
            let fixedData = rawStockData
              .replace(/'/g, '"') // Replace single quotes with double quotes
              .replace(/(\w+):/g, '"$1":') // Add quotes around property names
              .replace(/,\s*}/g, "}") // Remove trailing commas
              .replace(/,\s*]/g, "]"); // Remove trailing commas in arrays

            console.log("ðŸ”§ Attempting to parse fixed data:", fixedData);

            try {
              stockData = JSON.parse(fixedData);
            } catch (fixError) {
              console.error(
                "âŒ Both parsing attempts failed, trying API fallback"
              );

              // Try to get product ID for API call
              const productId =
                window.productId ||
                document.querySelector("[data-product-id]")?.dataset
                  .productId ||
                window.location.pathname.split("/").pop();

              if (productId) {
                console.log(
                  "ðŸŒ Attempting API fallback for product:",
                  productId
                );

                // Show loading message
                sizeContainer.innerHTML =
                  '<div style="color: #666; padding: 10px; font-style: italic;">Loading sizes...</div>';

                // Fetch from API
                fetch(
                  `/api/product/${productId}/sizes/${encodeURIComponent(
                    colorName
                  )}`
                )
                  .then((response) => response.json())
                  .then((data) => {
                    if (data.success && data.sizes) {
                      console.log("âœ… API fallback successful:", data.sizes);
                      stockData = data.sizes;
                      renderSizes(stockData, sizeContainer);
                    } else {
                      throw new Error(data.error || "API returned no sizes");
                    }
                  })
                  .catch((apiError) => {
                    console.error("âŒ API fallback also failed:", apiError);
                    // Final fallback: create basic structure
                    stockData = { XS: 0, S: 0, M: 0, L: 0, XL: 0 };
                    renderSizes(stockData, sizeContainer);
                  });
                return; // Exit early since we're using async API
              } else {
                // No product ID available, use basic fallback
                stockData = { XS: 0, S: 0, M: 0, L: 0, XL: 0 };
              }
            }
          }

          console.log("ðŸ“Š Final stock data for color:", stockData);

          // Render the sizes using helper function
          renderSizes(stockData, sizeContainer);
        } catch (e) {
          console.error("âŒ Error loading sizes:", e);
          sizeContainer.innerHTML = `<div style="color: red; padding: 10px;">Error loading sizes: ${e.message}</div>`;
        }
      };

      // Helper function to render sizes
      function renderSizes(stockData, sizeContainer) {
        console.log("ðŸŽ¨ Rendering sizes with data:", stockData);

        // Clear container
        sizeContainer.innerHTML = "";

        // Define size order for proper sorting
        const sizeOrder = ["XS", "S", "M", "L", "XL", "XXL", "3XL"];
        const sizes = Object.keys(stockData).sort((a, b) => {
          const aIndex = sizeOrder.indexOf(a);
          const bIndex = sizeOrder.indexOf(b);
          if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
          if (aIndex !== -1) return -1;
          if (bIndex !== -1) return 1;
          return a.localeCompare(b);
        });

        // Create size buttons
        sizes.forEach((size) => {
          let stock = stockData[size];

          // Debug the stock value
          console.log(
            `ðŸ“¦ Size ${size} raw stock:`,
            stock,
            `(type: ${typeof stock})`
          );

          // Convert to number and handle various data types
          if (typeof stock === "string") {
            stock = parseInt(stock, 10);
          } else if (typeof stock === "object" && stock !== null) {
            // If it's an object, try to get a stock property
            stock = stock.stock || stock.quantity || stock.count || 0;
          }

          // Ensure we have a valid number
          if (isNaN(stock) || stock === null || stock === undefined) {
            stock = 0;
          }

          console.log(
            `ðŸ“Š Size ${size} final stock:`,
            stock,
            `(available: ${stock > 0})`
          );

          const sizeBtn = document.createElement("button");
          sizeBtn.className =
            "size-option" + (stock > 0 ? "" : " out-of-stock");
          sizeBtn.textContent = size;
          sizeBtn.dataset.size = size;
          sizeBtn.dataset.stock = stock;
          sizeBtn.title = `${size} - ${stock} in stock`;

          // Add debug info to button text temporarily
          sizeBtn.textContent = `${size} (${stock})`;

          sizeBtn.onclick = () => window.simpleSelectSize(sizeBtn);
          sizeContainer.appendChild(sizeBtn);
        });

        console.log(`âœ… ${sizes.length} sizes rendered successfully`);
      }

      // Simple size selection function
      window.simpleSelectSize = function (button) {
        console.log("=== SIMPLE SELECT SIZE CALLED ===", button.dataset.size);

        // Remove active from all size buttons
        document.querySelectorAll(".size-option").forEach((btn) => {
          btn.classList.remove("active");
          btn.style.transform = "";
          btn.style.boxShadow = "";
        });

        // Add active to clicked button
        button.classList.add("active");
        button.style.transform = "scale(1.05)";
        button.style.boxShadow = "0 2px 8px rgba(142, 68, 173, 0.3)";

        // Update global state
        window.selectedSize = button.dataset.size;

        // Get stock for selected size
        const stock = parseInt(button.dataset.stock) || 0;

        // Update stock indicator
        const stockIndicator = document.getElementById("stockIndicator");
        if (stockIndicator) {
          stockIndicator.textContent = stock;
          stockIndicator.className =
            "stock-indicator " + (stock > 0 ? "in-stock" : "out-of-stock");
          console.log("ðŸ“Š Stock indicator updated:", stock);
        }

        // Update quantity input max value
        const quantityInput = document.getElementById("quantityInput");
        if (quantityInput) {
          quantityInput.max = stock;
          if (parseInt(quantityInput.value) > stock) {
            quantityInput.value = Math.max(1, stock);
          }
          console.log("ðŸ”¢ Quantity max set to:", stock);
        }

        // Update quantity button states
        updateQuantityControls();

        console.log("âœ… Size selected:", button.dataset.size, "Stock:", stock);
      };

      console.log("ðŸŽ¨ Simple color/size functions defined and ready!");

      // Aggressively attach event listeners when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ðŸ”§ DOM ready, attaching aggressive event listeners...");

        setTimeout(() => {
          const colorOptions = document.querySelectorAll(".color-option");
          console.log(
            `ðŸŽ¨ Found ${colorOptions.length} color options to attach listeners to`
          );

          colorOptions.forEach((btn, index) => {
            console.log(
              `Attaching listener to color ${index + 1}: ${btn.dataset.color}`
            );

            // Remove any existing listeners
            btn.removeEventListener("click", btn._clickHandler);
            btn.removeEventListener("mousedown", btn._clickHandler);
            btn.removeEventListener("touchstart", btn._clickHandler);

            // Create click handler
            btn._clickHandler = function (e) {
              e.preventDefault();
              e.stopPropagation();
              console.log(
                `ðŸŽ¯ Event listener fired for color: ${this.dataset.color}`
              );
              window.simpleSelectColor(this);
            };

            // Attach multiple event types to ensure it works
            btn.addEventListener("click", btn._clickHandler);
            btn.addEventListener("mousedown", btn._clickHandler);
            btn.addEventListener("touchstart", btn._clickHandler);

            // Ensure the button is clickable
            btn.style.pointerEvents = "auto";
            btn.style.zIndex = "10";

            console.log(`âœ… Listeners attached to ${btn.dataset.color}`);
          });

          console.log("âœ… All event listeners attached!");

          // Initialize stock indicator and quantity controls
          initializeProductControls();

          // Test that functions are available
          if (typeof window.simpleSelectColor === "function") {
            console.log("âœ… window.simpleSelectColor is available");
          } else {
            console.error("âŒ window.simpleSelectColor is NOT available");
          }
        }, 100);
      });

      // Initialize product controls on page load
      function initializeProductControls() {
        console.log("ðŸ”§ Initializing product controls...");

        // Set initial stock indicator state
        const stockIndicator = document.getElementById("stockIndicator");
        if (stockIndicator) {
          stockIndicator.textContent = "Select color & size";
          stockIndicator.className = "stock-indicator";
        }

        // Set initial quantity input state
        const quantityInput = document.getElementById("quantityInput");
        if (quantityInput) {
          quantityInput.value = 1;
          quantityInput.max = 0;
        }

        // Initialize add to bag button state - enable it by default
        const addToBagBtn = document.querySelector(".add-to-bag-btn");
        if (addToBagBtn) {
          addToBagBtn.disabled = false;
          addToBagBtn.textContent = "ADD TO BAG";
          addToBagBtn.style.opacity = "1";
          console.log("âœ… Add to bag button initialized and enabled");
        }

        // Update quantity controls
        if (typeof updateQuantityControls === "function") {
          updateQuantityControls();
        }

        console.log("âœ… Product controls initialized");
      }

      // Test function to verify functionality
      window.testQuantityControls = function () {
        console.log("ðŸ§ª Testing quantity controls...");

        const quantityInput = document.getElementById("quantityInput");
        const decreaseBtn = document.getElementById("decreaseBtn");
        const increaseBtn = document.getElementById("increaseBtn");
        const addToBagBtn = document.querySelector(".add-to-bag-btn");

        console.log("Elements found:", {
          quantityInput: !!quantityInput,
          decreaseBtn: !!decreaseBtn,
          increaseBtn: !!increaseBtn,
          addToBagBtn: !!addToBagBtn,
        });

        console.log("Functions available:", {
          increaseQuantity: typeof window.increaseQuantity,
          decreaseQuantity: typeof window.decreaseQuantity,
          updateQuantity: typeof window.updateQuantity,
          addToBag: typeof window.addToBag,
        });

        if (quantityInput) {
          console.log("Current quantity:", quantityInput.value);
          console.log("Max quantity:", quantityInput.max);
        }

        if (addToBagBtn) {
          console.log("Add to bag button disabled:", addToBagBtn.disabled);
        }
      };

      // Add a test function accessible from console
      window.testColorSelection = function () {
        console.log("ðŸ§ª Testing color selection...");
        const firstColor = document.querySelector(".color-option");
        if (firstColor) {
          console.log("Testing with first color:", firstColor.dataset.color);
          window.simpleSelectColor(firstColor);
        } else {
          console.log("âŒ No color buttons found");
        }
      };

      // Add simple button test function
      window.testAddToBagButton = function () {
        console.log("ðŸ§ª Testing add to bag button...");

        const btn = document.querySelector(".add-to-bag-btn");
        console.log("Button found:", btn);
        console.log("Button disabled:", btn ? btn.disabled : "N/A");
        console.log("Button onclick:", btn ? btn.onclick : "N/A");

        if (btn) {
          console.log("Simulating button click...");
          btn.click();
        } else {
          console.error("âŒ Button not found!");
        }
      };

      // Add simple modal test function that forces dynamic modal
      window.testDynamicModal = function () {
        console.log("ðŸ§ª Testing dynamic modal creation...");
        createDynamicModal();
      };

      // Add simple modal test function
      window.forceShowModal = function () {
        console.log("ðŸš€ Force showing modal...");

        // Update modal with test data
        updateCartModal("Test Color", "Test Size", 1);

        // Get modal element
        const modal = document.getElementById("cartModalOverlay");
        if (modal) {
          // Remove any existing classes and styles
          modal.className = "cart-modal-overlay active";
          modal.style.cssText =
            "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 1; visibility: visible;";
          document.body.style.overflow = "hidden";

          console.log("âœ… Modal forced to display with inline styles");
          console.log("Modal element:", modal);
          console.log("Modal should now be visible!");

          return true;
        } else {
          console.error("âŒ Modal element not found!");
          return false;
        }
      };

      // Add test function for modal
      window.testCartModal = function () {
        console.log("ðŸ§ª Testing cart modal...");

        // Test if modal element exists
        const modal = document.getElementById("cartModalOverlay");
        console.log("Modal found:", modal);

        if (!modal) {
          console.error("âŒ Modal element not found!");
          return;
        }

        // Test updating modal content first
        updateCartModal("Red", "M", 2);

        // Test showing modal
        console.log("ðŸ“± Attempting to show modal...");
        showCartModal();

        // Check if modal is visible after 500ms
        setTimeout(() => {
          const isVisible = modal.classList.contains("active");
          console.log("Modal has active class:", isVisible);

          if (isVisible) {
            console.log("âœ… Modal should be visible now!");
            console.log("If you don't see it, there might be a CSS issue.");
          } else {
            console.log("âŒ Modal doesn't have active class!");
          }
        }, 500);
      };

      // Add debug function to inspect current state
      window.debugAddToBagButton = function () {
        console.log("ðŸ” DEBUGGING ADD TO BAG BUTTON:");
        const addToBagBtn = document.querySelector(".add-to-bag-btn");
        const selectedColor = getSelectedColor();
        const selectedSize = getSelectedSize();
        const selectedSizeBtn = document.querySelector(".size-option.active");

        console.log("Button element:", addToBagBtn);
        console.log(
          "Button disabled:",
          addToBagBtn ? addToBagBtn.disabled : "N/A"
        );
        console.log(
          "Button text:",
          addToBagBtn ? addToBagBtn.textContent : "N/A"
        );
        console.log("Selected color:", selectedColor);
        console.log("Selected size:", selectedSize);
        console.log("Selected size button:", selectedSizeBtn);
        console.log(
          "Size button stock:",
          selectedSizeBtn ? selectedSizeBtn.dataset.stock : "N/A"
        );

        if (
          selectedColor &&
          selectedSize &&
          addToBagBtn &&
          addToBagBtn.disabled
        ) {
          console.log(
            "ðŸš¨ ISSUE: Color and size selected but button still disabled!"
          );
          console.log("Attempting to manually enable button...");
          addToBagBtn.disabled = false;
          addToBagBtn.textContent = "ADD TO BAG";
          addToBagBtn.style.opacity = "1";
          console.log("âœ… Button manually enabled. Try clicking it now.");
        }
      };

      // Add debug function to inspect stock data
      window.debugStockData = function () {
        console.log("ðŸ” DEBUGGING STOCK DATA:");
        const colorButtons = document.querySelectorAll(".color-option");
        colorButtons.forEach((btn, index) => {
          console.log(`Color ${index + 1}: ${btn.dataset.color}`);
          console.log(`  Raw data-stock:`, btn.dataset.stock);
          console.log(`  Type:`, typeof btn.dataset.stock);

          try {
            const parsed = JSON.parse(btn.dataset.stock || "{}");
            console.log(`  Parsed data:`, parsed);
            console.log(`  Object keys:`, Object.keys(parsed));
            Object.keys(parsed).forEach((size) => {
              console.log(
                `    ${size}:`,
                parsed[size],
                `(type: ${typeof parsed[size]})`
              );
            });
          } catch (e) {
            console.log(`  Parse error:`, e.message);
          }
        });
      };

      console.log("ðŸš€ All debugging and event handling ready!");
    </script>

    <!-- Final initialization script to ensure functions work -->
    <script>
      // Final check and fix for quantity controls
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
          console.log('ðŸ”§ Final initialization check...');

          // Ensure functions are available
          if (typeof window.increaseQuantity !== 'function') {
            console.log('âš ï¸ Redefining increaseQuantity function');
            window.increaseQuantity = function() {
              const input = document.getElementById('quantityInput');
              if (input) {
                const current = parseInt(input.value) || 1;
                const max = parseInt(input.max) || 10;
                if (current < max) {
                  input.value = current + 1;
                  console.log('Quantity increased to:', input.value);
                }
              }
            };
          }

          if (typeof window.decreaseQuantity !== 'function') {
            console.log('âš ï¸ Redefining decreaseQuantity function');
            window.decreaseQuantity = function() {
              const input = document.getElementById('quantityInput');
              if (input) {
                const current = parseInt(input.value) || 1;
                if (current > 1) {
                  input.value = current - 1;
                  console.log('Quantity decreased to:', input.value);
                }
              }
            };
          }

          if (typeof window.updateQuantity !== 'function') {
            console.log('âš ï¸ Redefining updateQuantity function');
            window.updateQuantity = function() {
              const input = document.getElementById('quantityInput');
              if (input) {
                let value = parseInt(input.value) || 1;
                const max = parseInt(input.max) || 10;
                if (value < 1) value = 1;
                if (value > max) value = max;
                input.value = value;
                console.log('Quantity updated to:', input.value);
              }
            };
          }

          if (typeof window.addToBag !== 'function') {
            console.log('âš ï¸ Redefining addToBag function');
            window.addToBag = function() {
              console.log('ðŸ›’ Enhanced add to bag clicked!');

              // Get selections
              const colorBtn = document.querySelector('.color-option.active');
              const sizeBtn = document.querySelector('.size-option.active');
              const quantityInput = document.getElementById('quantityInput');

              const color = colorBtn ? colorBtn.dataset.color : null;
              const size = sizeBtn ? sizeBtn.dataset.size : null;
              const quantity = parseInt(quantityInput ? quantityInput.value : 1);

              console.log('Selections:', { color, size, quantity });

              if (!color) {
                alert('Please select a color');
                return;
              }

              if (!size) {
                alert('Please select a size');
                return;
              }

              // Make API call to add to cart
              console.log('ðŸ›’ Making API call to add to cart...');
              fetch('/add-to-cart', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  product_id: {{ product.id }},
                  color: color,
                  size: size,
                  quantity: quantity
                })
              })
              .then(response => response.json())
              .then(data => {
                console.log('API Response:', data);
                if (data.success) {
                  console.log('âœ… Successfully added to cart');

                  // Update cart count in header if available
                  const cartCountEl = document.querySelector('.cart-count');
                  if (cartCountEl && data.cart_count) {
                    cartCountEl.textContent = data.cart_count;
                    console.log('Updated cart count to:', data.cart_count);
                  }

                  // Try to show the modal
                  try {
                    if (typeof createDynamicModal === 'function') {
                      console.log('ðŸ“± Showing dynamic modal...');
                      createDynamicModal();
                    } else {
                      console.log('ðŸ“± Creating simple modal...');
                      showSimpleModal(color, size, quantity);
                    }
                  } catch (modalError) {
                    console.error('Modal error:', modalError);
                    alert(`âœ… Added to cart: ${color} ${size} (Qty: ${quantity})`);
                  }
                } else {
                  console.error('âŒ Failed to add to cart:', data.error);
                  alert('Failed to add item to cart: ' + (data.error || 'Unknown error'));
                }
              })
              .catch(error => {
                console.error('âŒ API Error:', error);
                alert('Error adding item to cart. Please try again.');
              });
            };
          }

          // Simple modal function as fallback
          window.showSimpleModal = function(color, size, quantity) {
            console.log('ðŸ“± Creating simple modal fallback...');

            // Remove existing modal if any
            const existing = document.getElementById('simpleCartModal');
            if (existing) existing.remove();

            // Get product info
            const productName = document.querySelector('.product-name')?.textContent || 'Product';
            const productPrice = document.querySelector('.current-price')?.textContent || 'â‚±0';
            const productImage = document.querySelector('.main-image img')?.src || '';

            // Create modal HTML
            const modalHTML = `
              <div id="simpleCartModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999;" onclick="this.remove(); document.body.style.overflow='auto';">
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);" onclick="event.stopPropagation();">

                  <!-- Modal header -->
                  <div style="padding: 40px 40px 0; display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="display: flex; align-items: center; gap: 12px; font-size: 28px; font-weight: 700; color: #000;">
                      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2l3 6v8a2 2 0 002 2h2a2 2 0 002-2V8l3-6"/>
                        <path d="M5 8h14l-1 13H6L5 8z"/>
                        <path d="M10 10v4"/>
                        <path d="M14 10v4"/>
                      </svg>
                      You've Got Great Taste
                      <span style="font-size: 16px; font-weight: 400; color: #666; margin-left: 8px;">1 Item</span>
                    </div>
                    <button onclick="this.closest('#simpleCartModal').remove(); document.body.style.overflow='auto';" style="background: none; border: none; font-size: 28px; color: #999; cursor: pointer; padding: 0; line-height: 1; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
                  </div>

                  <!-- Modal body -->
                  <div style="padding: 40px; padding-top: 20px;">
                    <div style="display: flex; gap: 60px; align-items: flex-start; min-height: 200px;">

                      <!-- Left side - Product section -->
                      <div style="flex: 1;">
                        <div style="display: flex; gap: 24px; align-items: flex-start;">
                          <div style="width: 120px; height: 120px; background-color: #f5f5f5; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            <img src="${productImage}" alt="${productName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                          </div>
                          <div style="flex: 1;">
                            <div style="font-size: 20px; font-weight: 600; color: #000; margin-bottom: 12px; line-height: 1.3;">${productName}</div>
                            <div style="font-size: 16px; color: #666; margin-bottom: 8px;">Color: ${color}</div>
                            <div style="font-size: 16px; color: #666; margin-bottom: 16px;">Size: ${size}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #666;">${productPrice}</div>
                          </div>
                        </div>
                      </div>

                      <!-- Right side - Subtotal and actions -->
                      <div style="flex: 0 0 300px; display: flex; flex-direction: column; gap: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                          <div style="font-size: 18px; font-weight: 600; color: #000;">Subtotal</div>
                          <div style="font-size: 18px; font-weight: 600; color: #000;">${productPrice}</div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 16px;">
                          <a href="/cart" style="background-color: #dc2626; color: white; padding: 16px 24px; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.2s ease; width: 100%; text-decoration: none; display: inline-block; text-align: center;">VIEW BAG & CHECKOUT</a>
                          <a href="#" onclick="this.closest('#simpleCartModal').remove(); document.body.style.overflow='auto';" style="display: flex; align-items: center; justify-content: center; gap: 8px; color: #666; text-decoration: none; font-size: 16px; font-weight: 500; padding: 12px 8px; transition: all 0.2s ease;">
                            Continue Shopping
                            <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;">
                              <line x1="5" y1="12" x2="19" y2="12"></line>
                              <polyline points="12,5 19,12 12,19"></polyline>
                            </svg>
                          </a>
                        </div>
                      </div>
                    </div>

                    <!-- Recommendations section -->
                    <div style="margin-top: 40px;">
                      <h3 style="font-size: 24px; font-weight: 700; color: #000; margin-bottom: 24px;">Goes well with</h3>
                      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px;">
                        <div style="text-align: left;">
                          <div style="width: 100%; height: 200px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">
                            <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" alt="Product" style="width: 100%; height: 100%; object-fit: cover;">
                          </div>
                          <div style="font-size: 16px; font-weight: 600; color: #000; margin-bottom: 8px;">Clippable Nano Pouch</div>
                          <div style="font-size: 16px; font-weight: 600; color: #666;">â‚±1,200</div>
                        </div>
                        <div style="text-align: left;">
                          <div style="width: 100%; height: 200px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">
                            <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" alt="Product" style="width: 100%; height: 100%; object-fit: cover;">
                          </div>
                          <div style="font-size: 16px; font-weight: 600; color: #000; margin-bottom: 8px;">New Crew Backpack 22L</div>
                          <div style="font-size: 16px; font-weight: 600; color: #666;">â‚±4,900</div>
                        </div>
                        <div style="text-align: left;">
                          <div style="width: 100%; height: 200px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">
                            <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" alt="Product" style="width: 100%; height: 100%; object-fit: cover;">
                          </div>
                          <div style="font-size: 16px; font-weight: 600; color: #000; margin-bottom: 8px;">Everywhere Backpack 22L</div>
                          <div style="font-size: 16px; font-weight: 600; color: #666;">â‚±4,900</div>
                        </div>
                        <div style="text-align: left;">
                          <div style="width: 100%; height: 200px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">
                            <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" alt="Product" style="width: 100%; height: 100%; object-fit: cover;">
                          </div>
                          <div style="font-size: 16px; font-weight: 600; color: #000; margin-bottom: 8px;">City Essentials Pouch</div>
                          <div style="font-size: 16px; font-weight: 600; color: #666;">â‚±1,900</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';

            console.log('âœ… Simple modal displayed');
          };

          // Test functions
          console.log('âœ… Function availability check:');
          console.log('- increaseQuantity:', typeof window.increaseQuantity);
          console.log('- decreaseQuantity:', typeof window.decreaseQuantity);
          console.log('- updateQuantity:', typeof window.updateQuantity);
          console.log('- addToBag:', typeof window.addToBag);

          // Test elements
          const quantityInput = document.getElementById('quantityInput');
          const decreaseBtn = document.getElementById('decreaseBtn');
          const increaseBtn = document.getElementById('increaseBtn');
          const addToBagBtn = document.querySelector('.add-to-bag-btn');

          console.log('âœ… Element availability check:');
          console.log('- quantityInput:', !!quantityInput);
          console.log('- decreaseBtn:', !!decreaseBtn);
          console.log('- increaseBtn:', !!increaseBtn);
          console.log('- addToBagBtn:', !!addToBagBtn);

          if (quantityInput) {
            console.log('- Current quantity:', quantityInput.value);
            console.log('- Max quantity:', quantityInput.max);
          }

          console.log('ðŸŽ¯ Final initialization complete!');
        }, 1000); // Wait 1 second to ensure everything is loaded
      });
    </script>
  </body>
</html>
