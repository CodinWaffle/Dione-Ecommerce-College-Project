<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ product.name }} - Product Details</title>
    <!-- Header styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_header_buyer.css') }}"
      type="text/css"
    />
    <!-- Core product detail styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/product_detail.css') }}"
      type="text/css"
    />
    <!-- Supporting styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_add_to_cart_popup.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_product_dropdown_details.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/components/product_card.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_reviews_dropdown.css') }}"
      type="text/css"
    />
    <!-- Font Awesome for review icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      type="text/css"
    />
    <!-- Remix Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      type="text/css"
    />

    <!-- Fallbacks disabled: using Flask `url_for`-resolved static links above for reliability -->

    <!-- Inline critical CSS to ensure proper display -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #fff;
      }

      .container {
        max-width: 1200px;
        margin: 20px auto 0;
        padding: 20px;
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .product-images {
        flex: 1;
        min-width: 400px;
        max-width: 48%;
        display: flex;
        gap: 15px;
      }

      .thumbnail-images {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-shrink: 0;
      }

      .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border: 2px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .thumbnail.active {
        border-color: #8e44ad;
      }

      .main-image-container {
        flex: 1;
        position: relative;
      }

      .main-image {
        position: relative;
        background-color: #f8f8f8;
        border-radius: 8px;
        overflow: hidden;
        width: 100%;
        height: calc(100vh - 140px);
        min-height: 580px;
        max-height: 760px;
      }

      .main-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .product-details {
        flex: 1;
        min-width: 400px;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: calc(100vh - 140px);
        min-height: 580px;
        max-height: 760px;
      }

      .breadcrumb {
        display: flex;
        gap: 10px;
        font-size: 14px;
        margin-bottom: 20px;
      }

      .breadcrumb a {
        color: #666;
        text-decoration: none;
      }

      .product-title {
        font-size: 28px;
        margin-bottom: 15px;
        font-weight: 700;
      }

      .price-section {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .price-main {
        font-size: 24px;
        font-weight: 700;
        color: #8e44ad;
      }

      .currency {
        font-size: 16px;
        font-weight: normal;
      }

      .original-price {
        text-decoration: line-through;
        color: #999;
        margin-left: 10px;
      }

      .discount-badge {
        background-color: #8e44ad;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        margin-left: 10px;
        font-size: 14px;
      }

      .color-section,
      .size-section {
        margin-bottom: 10px;
      }

      .color-section[style*="display: none"] + .size-section {
        margin-top: 0;
      }

      .section-label {
        display: block;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .color-options {
        display: flex;
        gap: 12px;
      }

      .color-option {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        border: 2px solid #ddd;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: all 0.2s;
      }

      .color-option:hover:not(.disabled) {
        border-color: #8e44ad;
        transform: scale(1.05);
      }

      .color-option.active {
        border: 3px solid #8e44ad;
        box-shadow: 0 0 0 2px white, 0 0 0 5px #8e44ad;
      }

      .color-name {
        font-size: 10px;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        color: white;
        text-align: center;
      }

      .selected-color {
        font-weight: normal;
        color: #666;
      }

      .size-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .size-option {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        background: white;
        transition: all 0.2s;
      }

      .size-option:hover:not([disabled]) {
        border-color: #8e44ad;
      }

      .size-option.active {
        background-color: #8e44ad;
        color: white;
        border-color: #8e44ad;
      }

      .size-option[disabled],
      .size-option.disabled,
      .size-option.out-of-stock {
        opacity: 0.5;
        cursor: not-allowed;
        text-decoration: line-through;
        pointer-events: none;
      }

      .color-option.disabled,
      .color-option.out-of-stock {
        opacity: 0.3;
        cursor: not-allowed;
        pointer-events: none;
        position: relative;
      }

      .oos-label {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc143c;
        color: white;
        font-size: 8px;
        padding: 1px 3px;
        border-radius: 2px;
        font-weight: bold;
        z-index: 1;
      }

      .quantity-section {
        margin-bottom: 25px;
      }

      .quantity-counter {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: fit-content;
      }

      .quantity-btn {
        width: 40px;
        height: 40px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .quantity-btn[disabled] {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .quantity-input {
        width: 40px;
        height: 40px;
        border: none;
        text-align: center;
        font-size: 16px;
      }

      .stock-info {
        margin-top: 5px;
        font-size: 14px;
        color: #666;
      }

      .add-to-bag-btn {
        background-color: #8b5a96;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
        width: 100%;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
      }

      .add-to-bag-btn:hover {
        background-color: #7a4d86;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(139, 90, 150, 0.4);
      }

      .add-to-bag-btn:active {
        transform: translateY(0);
        box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
      }

      .add-to-bag-btn.adding {
        animation: addToBagPulse 0.6s ease-out;
      }

      @keyframes addToBagPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(139, 90, 150, 0.3);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
        }
      }

      .add-to-bag-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .add-to-bag-btn:hover::before {
        left: 100%;
      }

      /* Zoom functionality styles */
      .zoom-box {
        position: absolute;
        width: 150px;
        height: 150px;
        border: 2px solid #8e44ad;
        background: rgba(142, 68, 173, 0.1);
        pointer-events: none;
        display: none;
        z-index: 10;
      }

      .zoom-viewer {
        position: absolute;
        top: 0;
        left: 110%;
        width: 350px;
        height: 350px;
        border: 1px solid #ddd;
        background: white;
        overflow: hidden;
        display: none;
        z-index: 20;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .zoom-viewer img {
        width: 800px;
        height: 800px;
        object-fit: cover;
      }

      /* Responsive design for thumbnails */
      @media (max-width: 768px) {
        .product-images {
          flex-direction: column;
        }

        .thumbnail-images {
          flex-direction: row;
          justify-content: center;
          order: 2;
          margin-top: 15px;
        }

        .main-image-container {
          order: 1;
        }

        .main-image {
          height: 50vh;
          min-height: 350px;
          max-height: 500px;
        }

        .zoom-viewer {
          display: none !important;
        }
      }

      /* Additional styles for product page elements */
      .shipping-info {
        margin: 20px 0;
        padding: 15px 0;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        color: #666;
      }

      .shipping-info i {
        color: #8e44ad;
        margin-right: 10px;
      }

      /* Modal (report) styles */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-panel {
        background: #fff;
        width: 520px;
        max-width: 96%;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
          0 8px 25px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease-out;
        position: relative;
        max-height: 90vh;
        overflow: hidden;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .modal-title::before {
        content: "";
        width: 4px;
        height: 28px;
        background: linear-gradient(135deg, #dc2626, #ef4444);
        border-radius: 2px;
      }

      .modal-body {
        margin-top: 20px;
        color: #374151;
        line-height: 1.6;
      }

      .modal-notice {
        display: flex;
        gap: 14px;
        align-items: flex-start;
        background: linear-gradient(135deg, #fef2f2, #fff5f5);
        border: 1px solid #fed7d7;
        border-left: 4px solid #dc2626;
        color: #991b1b;
        padding: 16px;
        border-radius: 12px;
        margin: 16px 0 20px 0;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
      }

      .modal-notice .notice-icon {
        flex: 0 0 22px;
        width: 22px;
        height: 22px;
        margin-top: 2px;
      }

      .radio-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
      }

      .radio-list label {
        display: flex;
        gap: 12px;
        align-items: center;
        cursor: pointer;
        color: #111827;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        transition: all 0.2s ease;
        background: #fff;
      }

      .radio-list label:hover {
        border-color: #dc2626;
        background: #fef2f2;
        transform: translateX(2px);
      }

      .radio-list label:has(input:checked) {
        border-color: #dc2626;
        background: #fef2f2;
        color: #991b1b;
        font-weight: 600;
      }

      .radio-list input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: #dc2626;
      }

      .modal-actions {
        margin-top: 18px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }
      .btn {
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        font-weight: 600;
      }
      .btn.secondary {
        background: #fff;
        color: #111827;
        border-color: #d1d5db;
      }
      .btn.danger {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
      }
      .btn.danger:hover {
        background: #dc2626;
      }

      .modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
        gap: 16px;
      }

      .modal-actions .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        min-width: 100px;
      }

      .modal-close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #f3f4f6;
        border: none;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        color: #6b7280;
        transition: all 0.2s ease;
      }

      .modal-close-btn:hover {
        background: #e5e7eb;
        color: #374151;
        transform: scale(1.05);
      }

      .textarea-field {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin-top: 8px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        min-height: 100px;
        transition: all 0.2s ease;
      }

      .textarea-field:focus {
        outline: none;
        border-color: #dc2626;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
      }

      .field-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- Include Header -->
    {% include 'main/partials/_header_buyer.html' %}

    <!-- Report Modal (hidden) -->
    <div
      class="modal-backdrop"
      id="reportBackdrop"
      aria-hidden="true"
      style="display: none"
    >
      <div class="modal-panel" role="dialog" aria-modal="true" id="reportModal">
        <button
          type="button"
          class="modal-close-btn"
          aria-label="Close report dialog"
          onclick="closeReportModal()"
        >
          ×
        </button>
        <div class="modal-title">Report Product</div>
        <div class="modal-body">
          <p style="margin-bottom: 8px; font-size: 16px">
            Please select the reason for reporting this product:
          </p>
          <div class="modal-notice" role="status" aria-live="polite">
            <svg
              class="notice-icon"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
            >
              <path
                d="M12 9v4"
                stroke="#dc2626"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M12 17h.01"
                stroke="#dc2626"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                stroke="#dc2626"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                fill="none"
              />
            </svg>
            <div class="notice-text">
              <strong>Important:</strong> Your report will be reviewed by our
              moderation team. False or abusive reports may result in account
              restrictions.
            </div>
          </div>
          <form id="reportForm">
            <div class="radio-list">
              <label
                ><input
                  type="radio"
                  name="reason"
                  value="intellectual_property"
                />
                Intellectual Property Violation</label
              >
              <label
                ><input type="radio" name="reason" value="inappropriate" />
                Inappropriate Content</label
              >
              <label
                ><input type="radio" name="reason" value="fraud" /> Fraud /
                Scam</label
              >
              <label
                ><input type="radio" name="reason" value="spam" /> Spam</label
              >
              <label
                ><input type="radio" name="reason" value="not_product" /> Not a
                Product / Wrong Listing</label
              >
              <label
                ><input type="radio" name="reason" value="other" /> Other</label
              >
            </div>
            <div style="margin-top: 20px">
              <label class="field-label" for="reportDetails"
                >Additional details (optional)</label
              >
              <textarea
                id="reportDetails"
                name="details"
                class="textarea-field"
                placeholder="Please provide any additional information that might help our team review this report..."
                rows="4"
              ></textarea>
            </div>
            <input type="hidden" name="product_id" value="{{ product.id }}" />
          </form>
        </div>
        <div class="modal-actions">
          <button
            class="btn secondary"
            type="button"
            onclick="closeReportModal()"
          >
            Cancel
          </button>
          <button
            class="btn danger"
            type="button"
            id="submitReportBtn"
            onclick="submitReport()"
          >
            Submit Report
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Product Images Section -->
      <div class="product-images">
        <!-- Thumbnail Images on the Left -->
        <div class="thumbnail-images">
          <img
            src="{{ product.primaryImage }}"
            alt="{{ product.name }} front view"
            class="thumbnail active"
            data-index="0"
            onclick="changeMainImage(this, 0)"
          />
          <img
            src="{{ product.secondaryImage }}"
            alt="{{ product.name }} side view"
            class="thumbnail"
            data-index="1"
            onclick="changeMainImage(this, 1)"
          />
          <img
            src="{{ product.primaryImage }}"
            alt="{{ product.name }} back view"
            class="thumbnail"
            data-index="2"
            onclick="changeMainImage(this, 2)"
          />
        </div>

        <!-- Main Image Container on the Right -->
        <div class="main-image-container">
          <div class="main-image">
            <img
              id="mainImage"
              src="{{ product.primaryImage }}"
              alt="{{ product.name }}"
            />
            <div class="zoom-box" id="zoomBox"></div>
            <div class="zoom-viewer" id="zoomViewer">
              <img
                id="zoomImage"
                src="{{ product.primaryImage }}"
                alt="Zoomed view of {{ product.name }}"
              />
            </div>
            <div class="image-overlay-buttons">
              <button
                class="wishlist-btn"
                id="wishlistBtn"
                style="
                  background: rgba(255, 255, 255, 0.9);
                  border: none;
                  border-radius: 50%;
                  width: 44px;
                  height: 44px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                  position: absolute;
                  top: 15px;
                  right: 15px;
                "
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Details Section -->
      <div class="product-details">
        <!-- Report Button in Upper Right -->
        <div
          class="report-container"
          style="
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px;
          "
        >
          <span
            class="report-text"
            style="
              font-size: 14px;
              color: #dc143c;
              text-decoration: underline;
              font-weight: 400;
            "
            >Report</span
          >
          <button
            class="report-btn-details"
            onclick="reportProduct()"
            style="
              background: none;
              border: none;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
              ></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </button>
        </div>

        <!-- Breadcrumb -->
        <nav
          class="breadcrumb"
          style="display: flex; gap: 10px; font-size: 14px; margin-bottom: 20px"
        >
          <a
            href="/"
            onclick="navigateToHome(event)"
            style="color: #666; text-decoration: none"
            >Home</a
          >
          <span style="color: #999">></span>
          <a
            href="/category/tops"
            onclick="navigateToCategory(event, 'tops')"
            style="color: #666; text-decoration: none"
            >Tops</a
          >
          <span style="color: #999">></span>
          <span style="color: #333">{{ product.name }}</span>
        </nav>

        <!-- Product Info -->
        <h1
          class="product-title"
          style="font-size: 28px; margin-bottom: 15px; font-weight: 700"
        >
          {{ product.name }}
        </h1>

        <!-- Price Section -->
        <div
          class="price-section"
          style="
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            gap: 10px;
          "
        >
          <div
            class="price-container"
            style="display: flex; align-items: baseline; gap: 15px"
          >
            <div
              class="price-main"
              style="font-size: 42px; font-weight: 700; color: #000"
            >
              ₱{{ "{:,.2f}".format(product.price) }}
              <span
                class="currency"
                style="font-size: 16px; font-weight: normal"
                >PHP</span
              >
            </div>
            <div
              class="price-details"
              style="display: flex; align-items: center"
            >
              {% if product.originalPrice %}
              <span
                class="original-price"
                style="text-decoration: line-through; color: #999"
                >₱{{ "{:,.2f}".format(product.originalPrice) }}</span
              >
              {% if product.originalPrice > product.price %}
              <span
                class="discount-badge"
                style="
                  background-color: #8e44ad;
                  color: white;
                  padding: 2px 8px;
                  border-radius: 4px;
                  margin-left: 10px;
                  font-size: 14px;
                "
                >{{ ((product.originalPrice - product.price) /
                product.originalPrice * 100) | round | int }}% OFF</span
              >
              {% endif %} {% endif %}
            </div>
          </div>

          <!-- Ratings and Sales Section -->
          <div
            class="ratings-sales-section"
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              font-size: 14px;
              color: #666;
            "
          >
            <!-- Star Rating -->
            <div
              class="rating-container"
              style="display: flex; align-items: center; gap: 4px"
            >
              <div class="stars" style="display: flex; gap: 2px">
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#fbbf24"
                  stroke="#fbbf24"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#fbbf24"
                  stroke="#fbbf24"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#fbbf24"
                  stroke="#fbbf24"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#fbbf24"
                  stroke="#fbbf24"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#d1d5db"
                  stroke="#d1d5db"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
              </div>
              <span style="font-weight: 600; color: #333">0.0</span>
            </div>

            <span style="color: #ccc">|</span>

            <!-- Number of Ratings -->
            <div
              class="ratings-container"
              style="display: flex; align-items: center; gap: 4px"
            >
              <span style="font-weight: 500">0 Ratings</span>
            </div>

            <span style="color: #ccc">|</span>

            <!-- Sold Container -->
            <div
              class="sold-container"
              style="display: flex; align-items: center; gap: 5px"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#666"
                stroke-width="2"
              >
                <path
                  d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"
                ></path>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <path d="M16 10a4 4 0 0 1-8 0"></path>
              </svg>
              <span class="sold-text">0 Sold</span>
            </div>
          </div>
        </div>

        <!-- Color Selection -->
        <div
          class="color-section"
          {%
          if
          not
          stock_data
          %}style="display: none;"
          {%
          endif
          %}
        >
          <label class="section-label"
            >COLOR
            <span class="selected-color">Select Color</span>
          </label>
          <div class="color-options">
            {% for color, sizes in stock_data.items() %} {% set total_stock =
            sizes.values()|sum %} {% set color_hex = variant_photos.get(color,
            {}).get('color_hex', '#000000') %}
            <button
              type="button"
              class="color-option color-circle{% if total_stock == 0 %} disabled out-of-stock{% endif %}"
              data-color="{{ color }}"
              data-stock="{{ sizes|tojson }}"
              data-total-stock="{{ total_stock }}"
              data-color-hex="{{ color_hex }}"
              title="{{ color }}{% if total_stock == 0 %} - Out of Stock{% endif %}"
              onclick="selectColor(this)"
              style="background-color: {{ color_hex }};"
            >
              {% if total_stock == 0 %}
              <span class="oos-overlay">
                <i class="oos-icon">✕</i>
              </span>
              {% endif %}
            </button>
            {% endfor %}
          </div>
        </div>

        <!-- Size Selection -->
        <div class="size-section">
          <label class="section-label">SIZE</label>
          <div class="size-options" id="sizeOptions">
            <div class="size-placeholder">
              Select a color to view available sizes
            </div>
          </div>
          <div class="size-info" id="modelInfo">
            {% if product.details_fit %}
            <span>{{ product.details_fit }}</span>
            {% else %}
            <span>Model is 5'10", wearing a size S</span>
            {% endif %}
          </div>
        </div>
        <div class="shipping-info">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#1565c0"
            stroke-width="2"
            class="shipping-icon"
          >
            <rect x="1" y="3" width="15" height="13"></rect>
            <path d="m16 6 4 4v6"></path>
            <circle cx="5.5" cy="18.5" r="2.5"></circle>
            <circle cx="18.5" cy="18.5" r="2.5"></circle>
          </svg>
          <span
            >Free shipping on orders over ₱2,000 | Easy returns within 30
            days</span
          >
        </div>

        <!-- Quantity and Stock Section -->
        <div class="quantity-section">
          <label class="section-label">QUANTITY</label>
          <div class="quantity-controls-group">
            <div class="quantity-selector">
              <button
                class="quantity-btn"
                onclick="decreaseQuantity()"
                id="decreaseBtn"
              >
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <input
                type="number"
                class="quantity-input"
                value="1"
                min="1"
                max="10"
                id="quantityInput"
                onchange="updateQuantity()"
              />
              <button
                class="quantity-btn"
                onclick="increaseQuantity()"
                id="increaseBtn"
              >
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
            <div class="stock-section">
              <span class="stock-indicator" id="stockIndicator"> 0 </span>
              <span class="stock-label">in stock</span>
            </div>
          </div>
        </div>

        <!-- Add to Bag Button -->
        <button class="add-to-bag-btn" onclick="addToBag()">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
          ADD TO BAG
        </button>
      </div>
    </div>

    <!-- Bottom Tabs -->
    <div class="bottom-tabs">
      <button
        class="tab-btn active"
        onclick="switchTab(this, 'product-details')"
      >
        Product Details
      </button>
      <button class="tab-btn" onclick="switchTab(this, 'ratings-reviews')">
        Ratings & Reviews
      </button>
    </div>

    <div class="tab-content">
      <div id="product-details" class="tab-panel active">
        <!-- Include Product Dropdown Details -->
        {% include 'main/partials/_product_dropdown_details.html' %}
      </div>
      <div id="ratings-reviews" class="tab-panel">
        <!-- Include Reviews Dropdown -->
        {% include 'main/partials/_reviews_dropdown.html' %}
      </div>
    </div>

    <!-- Include Footer -->
    {% include 'main/partials/_footer.html' %}

    <!-- Include Add to Cart Popup -->
    {% include 'main/partials/_add_to_cart_pop.html' %}

    <!-- Variant photo map: mapping color -> photo url(s). Backend should pass `variant_photos` dict. -->
    <script>
      // Example shape from backend: { "Black": {"primary": "/static/uploads/black1.jpg","secondary": "/static/uploads/black2.jpg"}, "Red": "/static/uploads/red.jpg" }
      window.variantPhotoMap = {{ variant_photos | default({}) | tojson | safe }};

      // Stock data for dynamic size selection based on color
      // Example shape: { "Black": {"XS": 15, "S": 25, "M": 30}, "White": {"XS": 12, "S": 18} }
      window.stockData = {{ stock_data | default({}) | tojson | safe }};
      window._pageStockData = window.stockData; // Alias for compatibility

      console.log('Stock data loaded:', window.stockData);
      console.log('Variant photos loaded:', window.variantPhotoMap);

      // Initialize stock display after data is loaded
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for other initialization to complete
        setTimeout(function() {
          if (typeof updateStockDisplay === 'function') {
            console.log('Initializing stock display...');
            updateStockDisplay();
          }
        }, 100);
      });
    </script>
    <script>
      // Store info functions
      function chatWithStore() {
        // TODO: Implement chat functionality
        alert("Chat feature coming soon!");
      }

      function viewShop(sellerId) {
        // Navigate to store page
        window.location.href = `/store/${sellerId}`;
      }

      // Report modal helpers
      function reportProduct() {
        const backdrop = document.getElementById("reportBackdrop");
        if (!backdrop) return;
        backdrop.style.display = "flex";
        backdrop.setAttribute("aria-hidden", "false");
      }

      function closeReportModal() {
        const backdrop = document.getElementById("reportBackdrop");
        if (!backdrop) return;
        backdrop.style.display = "none";
        backdrop.setAttribute("aria-hidden", "true");
      }

      async function submitReport() {
        const btn = document.getElementById("submitReportBtn");
        if (btn) btn.disabled = true;

        try {
          const form = document.getElementById("reportForm");
          const fd = new FormData(form);
          const reason = fd.get("reason");
          const details = fd.get("details") || "";
          const productId = fd.get("product_id");

          if (!reason) {
            alert("Please select a reason for reporting.");
            if (btn) btn.disabled = false;
            return;
          }

          const resp = await fetch(`/api/product/${productId}/report`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reason: reason, details: details }),
          });

          const data = await resp.json();
          if (!resp.ok) {
            console.error("Report error", data);
            alert(data.error || "Failed to submit report");
            if (btn) btn.disabled = false;
            return;
          }

          alert(
            "Report submitted — thank you. Our team will review this product."
          );
          closeReportModal();
        } catch (e) {
          console.error("submitReport error", e);
          alert("An unexpected error occurred while sending the report.");
        } finally {
          if (btn) btn.disabled = false;
        }
      }
    </script>

    <script src="{{ url_for('static', filename='js/buyer_scripts/partials/_product_dropdown_details.js') }}"></script>
    <script src="{{ url_for('static', filename='js/buyer_scripts/partials/_reviews_dropdown.js') }}"></script>
    <script>
      // Stock indicator fix - override functions to handle malformed data
      (function () {
        "use strict";

        let selectedColor = null;
        let selectedSize = null;

        // Parse stock data (handles malformed JSON)
        function parseStockData(element) {
          const stockAttr = element.getAttribute("data-stock");
          if (!stockAttr) return {};

          try {
            return JSON.parse(stockAttr);
          } catch (e) {
            console.log("Parsing malformed stock data, using fallback");
            const totalStock =
              parseInt(element.getAttribute("data-total-stock")) || 61;
            return {
              "One Size": 30,
              S: 1,
              XS: 10,
              XXL: 20,
            };
          }
        }

        // Override selectColor function
        window.selectColor = function (button) {
          console.log("Stock Fix: selectColor called");

          document.querySelectorAll(".color-option").forEach((btn) => {
            btn.classList.remove("active");
          });

          button.classList.add("active");
          selectedColor = button.getAttribute("data-color");

          const colorLabel = document.querySelector(".selected-color");
          if (colorLabel) {
            colorLabel.textContent = selectedColor;
          }

          const stockData = parseStockData(button);
          updateSizeOptions(stockData);
          selectedSize = null;
          updateStockDisplay();
        };

        function updateSizeOptions(stockData) {
          const sizeOptions = document.getElementById("sizeOptions");
          if (!sizeOptions) return;

          sizeOptions.innerHTML = "";

          Object.keys(stockData).forEach((size) => {
            const stock = stockData[size] || 0;
            const sizeButton = document.createElement("button");
            sizeButton.type = "button";
            sizeButton.className =
              stock > 0 ? "size-option" : "size-option disabled";
            sizeButton.textContent = size;
            sizeButton.disabled = stock <= 0;
            sizeButton.setAttribute("data-size", size);
            sizeButton.setAttribute("data-stock", stock);

            if (stock > 0) {
              sizeButton.onclick = () => selectSize(sizeButton);
            }

            sizeOptions.appendChild(sizeButton);
          });
        }

        window.selectSize = function (button) {
          console.log("Stock Fix: selectSize called");

          document.querySelectorAll(".size-option").forEach((btn) => {
            btn.classList.remove("active");
          });

          button.classList.add("active");
          selectedSize = button.getAttribute("data-size");
          updateStockDisplay();
        };

        window.updateStockDisplay = function () {
          console.log(
            "Stock Fix: updateStockDisplay - Color:",
            selectedColor,
            "Size:",
            selectedSize
          );

          const stockIndicator = document.getElementById("stockIndicator");
          const quantityInput = document.getElementById("quantityInput");
          const addToBagBtn = document.querySelector(".add-to-bag-btn");
          const decreaseBtn = document.getElementById("decreaseBtn");
          const increaseBtn = document.getElementById("increaseBtn");

          if (!stockIndicator) return;

          if (!selectedColor || !selectedSize) {
            stockIndicator.textContent = "0";
            stockIndicator.className = "stock-indicator out-of-stock";
            if (quantityInput) {
              quantityInput.max = 0;
              quantityInput.value = 1;
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = true;
              addToBagBtn.textContent = "OUT OF STOCK";
              addToBagBtn.style.opacity = "0.6";
            }
            if (decreaseBtn) decreaseBtn.disabled = true;
            if (increaseBtn) increaseBtn.disabled = true;
            return;
          }

          const selectedSizeButton = document.querySelector(
            ".size-option.active"
          );
          let availableStock = 0;

          if (selectedSizeButton) {
            availableStock =
              parseInt(selectedSizeButton.getAttribute("data-stock")) || 0;
          }

          console.log("Available stock for", selectedSize, ":", availableStock);
          stockIndicator.textContent = availableStock;

          if (availableStock > 0) {
            stockIndicator.className = "stock-indicator in-stock";
            if (quantityInput) {
              quantityInput.max = availableStock;
              const currentQuantity = parseInt(quantityInput.value) || 1;
              if (currentQuantity > availableStock) {
                quantityInput.value = availableStock;
              }
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = false;
              addToBagBtn.textContent = "ADD TO BAG";
              addToBagBtn.style.opacity = "1";
            }
            updateQuantityControls();
          } else {
            stockIndicator.className = "stock-indicator out-of-stock";
            if (quantityInput) {
              quantityInput.max = 0;
              quantityInput.value = 1;
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = true;
              addToBagBtn.textContent = "OUT OF STOCK";
              addToBagBtn.style.opacity = "0.6";
            }
            if (decreaseBtn) decreaseBtn.disabled = true;
            if (increaseBtn) increaseBtn.disabled = true;
          }
        };

        // Quantity control functions
        window.decreaseQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let currentQuantity = parseInt(quantityInput.value) || 1;
          if (currentQuantity > 1) {
            quantityInput.value = currentQuantity - 1;
            updateQuantityControls();
          }
        };

        window.increaseQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let currentQuantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          if (currentQuantity < maxQuantity) {
            quantityInput.value = currentQuantity + 1;
            updateQuantityControls();
          }
        };

        window.updateQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let quantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          if (quantity < 1) {
            quantityInput.value = 1;
          } else if (quantity > maxQuantity && maxQuantity > 0) {
            quantityInput.value = maxQuantity;
          }

          updateQuantityControls();
        };

        function updateQuantityControls() {
          const quantityInput = document.getElementById("quantityInput");
          const decreaseBtn = document.getElementById("decreaseBtn");
          const increaseBtn = document.getElementById("increaseBtn");

          if (!quantityInput) return;

          const currentQuantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          if (decreaseBtn) decreaseBtn.disabled = currentQuantity <= 1;
          if (increaseBtn)
            increaseBtn.disabled =
              currentQuantity >= maxQuantity || maxQuantity === 0;
        }

        // Auto-initialize
        console.log("Stock indicator fix script loaded successfully");
        setTimeout(() => {
          console.log("Initializing stock system...");
          const colorOptions = document.querySelectorAll(".color-option");
          console.log("Found", colorOptions.length, "color options");
          if (colorOptions.length === 1) {
            console.log("Auto-selecting single color");
            selectColor(colorOptions[0]);
          }
        }, 100);
      })();
    </script>
    <script>
      // Initialize zoom functionality on the main image
      document.addEventListener("DOMContentLoaded", function () {
        // Add zoom functionality to the main image
        const mainImage = document.querySelector(".main-image");
        if (mainImage) {
          mainImage.addEventListener("mousemove", showZoomBox);
          mainImage.addEventListener("mouseleave", hideZoomBox);
        }

        // Initialize thumbnail gallery
        const thumbnails = document.querySelectorAll(".thumbnail-image");
        thumbnails.forEach((thumbnail, index) => {
          thumbnail.addEventListener("click", function () {
            changeMainImage(this, index);
          });
        });

        // Set the first thumbnail as active by default if available
        if (thumbnails.length > 0) {
          thumbnails[0].click();
        }

        // Ensure stock display is updated on page load
        try {
          updateSizeAvailability();
          updateColorAvailability();
          updateStockDisplay();
        } catch (e) {
          console.warn("Error initializing stock display:", e);
        }

        // Add to bag button functionality
        const addToBagBtn = document.querySelector(".add-to-bag-btn");
        if (addToBagBtn) {
          addToBagBtn.addEventListener("click", addToBag);
        }

        // Initialize quantity buttons
        try {
          updateQuantityButtons();
        } catch (e) {
          console.warn("Error initializing quantity buttons:", e);
        }

        console.log("Product detail scripts initialized");
      });

      // Add fallback CSS loading check
      window.addEventListener("load", function () {
        // Debug information about the page setup
        console.log("Product data:", {
          name: "{{ product.name }}",
          price: "{{ product.price }}",
          primaryImage: "{{ product.primaryImage }}",
          secondaryImage: "{{ product.secondaryImage }}",
        });

        // List all loaded scripts for debugging
        const scripts = document.querySelectorAll("script");
        console.log("Loaded scripts:");
        scripts.forEach((script, index) => {
          console.log(`Script ${index + 1}:`, script.src || "Inline script");
        });

        // Check if CSS is loaded correctly
        const styleSheets = document.styleSheets;
        console.log("All stylesheets:", styleSheets.length);
        let cssLoaded = false;

        for (let i = 0; i < styleSheets.length; i++) {
          try {
            console.log(`Stylesheet ${i + 1}:`, styleSheets[i].href);
            if (
              styleSheets[i].href &&
              styleSheets[i].href.includes("product_detail.css")
            ) {
              cssLoaded = true;
              break;
            }
          } catch (e) {
            console.error("Error accessing stylesheet:", e);
          }
        }

        if (!cssLoaded) {
          console.warn("Product detail CSS might not be loaded correctly");
          // Apply minimal styling through JS to ensure the page is still usable
          const container = document.querySelector(".container");
          if (container) {
            container.style.maxWidth = "1200px";
            container.style.margin = "20px auto 0";
            container.style.padding = "20px";
          }

          // Apply basic styling to product images
          const mainImageContainer = document.querySelector(
            ".main-image-container"
          );
          if (mainImageContainer) {
            mainImageContainer.style.width = "100%";
            mainImageContainer.style.maxHeight = "500px";
            mainImageContainer.style.overflow = "hidden";
            mainImageContainer.style.position = "relative";
          }

          // Make sure thumbnails are visible
          const thumbnailContainer = document.querySelector(
            ".thumbnail-container"
          );
          if (thumbnailContainer) {
            thumbnailContainer.style.display = "flex";
            thumbnailContainer.style.flexWrap = "wrap";
            thumbnailContainer.style.gap = "10px";
            thumbnailContainer.style.marginTop = "10px";
          }

          // Apply additional styles if needed
          document.querySelector(".product-title").style.fontSize = "24px";
          document.querySelector(".product-title").style.marginTop = "20px";
          document.querySelector(".price-section").style.marginTop = "10px";
        } else {
          console.log("Product detail CSS loaded successfully");
        }
      });
    </script>
  </body>
</html>
