<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ product.name }} - Product Details</title>
    <!-- Header styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_header_buyer.css') }}"
      type="text/css"
    />
    <!-- Core product detail styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/product_detail.css') }}"
      type="text/css"
    />
    <!-- Supporting styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_add_to_cart_popup.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_product_dropdown_details.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/components/product_card.css') }}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_reviews_dropdown.css') }}"
      type="text/css"
    />
    <!-- Font Awesome for review icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      type="text/css"
    />
    <!-- Remix Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      type="text/css"
    />

    <!-- Fallbacks disabled: using Flask `url_for`-resolved static links above for reliability -->

    <!-- Inline critical CSS to ensure proper display -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #fff;
      }

      .container {
        max-width: 1200px;
        margin: 20px auto 0;
        padding: 20px;
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .product-images {
        flex: 1;
        min-width: 400px;
        max-width: 48%;
        display: flex;
        gap: 15px;
      }

      .thumbnail-images {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-shrink: 0;
      }

      .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border: 2px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .thumbnail.active {
        border-color: #8e44ad;
      }

      .main-image-container {
        flex: 1;
        position: relative;
      }

      .main-image {
        position: relative;
        background-color: #f8f8f8;
        border-radius: 8px;
        overflow: hidden;
        width: 100%;
        height: calc(100vh - 140px);
        min-height: 580px;
        max-height: 760px;
      }

      .main-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .product-details {
        flex: 1;
        min-width: 400px;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: calc(100vh - 140px);
        min-height: 580px;
        max-height: 760px;
      }

      .breadcrumb {
        display: flex;
        gap: 10px;
        font-size: 14px;
        margin-bottom: 20px;
      }

      .breadcrumb a {
        color: #666;
        text-decoration: none;
      }

      .product-title {
        font-size: 28px;
        margin-bottom: 15px;
        font-weight: 700;
      }

      .price-section {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .price-main {
        font-size: 24px;
        font-weight: 700;
        color: #8e44ad;
      }

      .currency {
        font-size: 16px;
        font-weight: normal;
      }

      .original-price {
        text-decoration: line-through;
        color: #999;
        margin-left: 10px;
      }

      .discount-badge {
        background-color: #8e44ad;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        margin-left: 10px;
        font-size: 14px;
      }

      .color-section,
      .size-section {
        margin-bottom: 10px;
      }

      .color-section[style*="display: none"] + .size-section {
        margin-top: 0;
      }

      .section-label {
        display: block;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .color-options {
        display: flex;
        gap: 12px;
      }

      .color-option {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        border: 2px solid #ddd;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: all 0.2s;
      }

      .color-option:hover:not(.disabled) {
        border-color: #8e44ad;
        transform: scale(1.05);
      }

      .color-option.active {
        border: 3px solid #8e44ad;
        box-shadow: 0 0 0 2px white, 0 0 0 5px #8e44ad;
      }

      .color-name {
        font-size: 10px;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        color: white;
        text-align: center;
      }

      .selected-color {
        font-weight: normal;
        color: #666;
      }

      .size-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .size-option {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        background: white;
        transition: all 0.2s;
      }

      .size-option:hover:not([disabled]) {
        border-color: #8e44ad;
      }

      .size-option.active {
        background-color: #8e44ad;
        color: white;
        border-color: #8e44ad;
      }

      .size-option[disabled],
      .size-option.disabled,
      .size-option.out-of-stock {
        opacity: 0.5;
        cursor: not-allowed;
        text-decoration: line-through;
        pointer-events: none;
      }

      .color-option.disabled,
      .color-option.out-of-stock {
        opacity: 0.3;
        cursor: not-allowed;
        pointer-events: none;
        position: relative;
      }

      .oos-label {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc143c;
        color: white;
        font-size: 8px;
        padding: 1px 3px;
        border-radius: 2px;
        font-weight: bold;
        z-index: 1;
      }

      .quantity-section {
        margin-bottom: 25px;
      }

      .quantity-counter {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: fit-content;
      }

      .quantity-btn {
        width: 40px;
        height: 40px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .quantity-btn[disabled] {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .quantity-input {
        width: 40px;
        height: 40px;
        border: none;
        text-align: center;
        font-size: 16px;
      }

      .stock-info {
        margin-top: 5px;
        font-size: 14px;
        color: #666;
      }

      .add-to-bag-btn {
        background-color: #8b5a96;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
        width: 100%;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
      }

      .add-to-bag-btn:hover {
        background-color: #7a4d86;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(139, 90, 150, 0.4);
      }

      .add-to-bag-btn:active {
        transform: translateY(0);
        box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
      }

      .add-to-bag-btn.adding {
        animation: addToBagPulse 0.6s ease-out;
      }

      @keyframes addToBagPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(139, 90, 150, 0.3);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 4px 15px rgba(139, 90, 150, 0.3);
        }
      }

      .add-to-bag-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .add-to-bag-btn:hover::before {
        left: 100%;
      }

      /* Zoom functionality styles */
      .zoom-box {
        position: absolute;
        width: 150px;
        height: 150px;
        border: 2px solid #8e44ad;
        background: rgba(142, 68, 173, 0.1);
        pointer-events: none;
        display: none;
        z-index: 10;
      }

      .zoom-viewer {
        position: absolute;
        top: 0;
        left: 110%;
        width: 350px;
        height: 350px;
        border: 1px solid #ddd;
        background: white;
        overflow: hidden;
        display: none;
        z-index: 20;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .zoom-viewer img {
        width: 800px;
        height: 800px;
        object-fit: cover;
      }

      /* Responsive design for thumbnails */
      @media (max-width: 768px) {
        .product-images {
          flex-direction: column;
        }

        .thumbnail-images {
          flex-direction: row;
          justify-content: center;
          order: 2;
          margin-top: 15px;
        }

        .main-image-container {
          order: 1;
        }

        .main-image {
          height: 50vh;
          min-height: 350px;
          max-height: 500px;
        }

        .zoom-viewer {
          display: none !important;
        }
      }

      /* Additional styles for product page elements */
      .shipping-info {
        margin: 20px 0;
        padding: 15px 0;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        color: #666;
      }

      .shipping-info i {
        color: #8e44ad;
        margin-right: 10px;
      }

      /* Modal (report) styles */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-panel {
        background: #fff;
        width: 520px;
        max-width: 96%;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
          0 8px 25px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease-out;
        position: relative;
        max-height: 90vh;
        overflow: hidden;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .modal-title::before {
        content: "";
        width: 4px;
        height: 28px;
        background: linear-gradient(135deg, #dc2626, #ef4444);
        border-radius: 2px;
      }

      .modal-body {
        margin-top: 20px;
        color: #374151;
        line-height: 1.6;
      }

      .modal-notice {
        display: flex;
        gap: 14px;
        align-items: flex-start;
        background: linear-gradient(135deg, #fef2f2, #fff5f5);
        border: 1px solid #fed7d7;
        border-left: 4px solid #dc2626;
        color: #991b1b;
        padding: 16px;
        border-radius: 12px;
        margin: 16px 0 20px 0;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
      }

      .modal-notice .notice-icon {
        flex: 0 0 22px;
        width: 22px;
        height: 22px;
        margin-top: 2px;
      }

      .radio-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
      }

      .radio-list label {
        display: flex;
        gap: 12px;
        align-items: center;
        cursor: pointer;
        color: #111827;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        transition: all 0.2s ease;
        background: #fff;
      }

      .radio-list label:hover {
        border-color: #dc2626;
        background: #fef2f2;
        transform: translateX(2px);
      }

      .radio-list label:has(input:checked) {
        border-color: #dc2626;
        background: #fef2f2;
        color: #991b1b;
        font-weight: 600;
      }

      .radio-list input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: #dc2626;
      }

      .modal-actions {
        margin-top: 18px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }
      .btn {
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        font-weight: 600;
      }
      .btn.secondary {
        background: #fff;
        color: #111827;
        border-color: #d1d5db;
      }
      .btn.danger {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
      }
      .btn.danger:hover {
        background: #dc2626;
      }

      .modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
        gap: 16px;
      }

      .modal-actions .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        min-width: 100px;
      }

      .modal-close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #f3f4f6;
        border: none;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        color: #6b7280;
        transition: all 0.2s ease;
      }

      .modal-close-btn:hover {
        background: #e5e7eb;
        color: #374151;
        transform: scale(1.05);
      }

      .textarea-field {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin-top: 8px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        min-height: 100px;
        transition: all 0.2s ease;
      }

      .textarea-field:focus {
        outline: none;
        border-color: #dc2626;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
      }

      .field-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- Include Header -->
    {% include 'main/partials/_header_buyer.html' %}

    <!-- Report Modal (hidden) -->
    <div
      class="modal-backdrop"
      id="reportBackdrop"
      aria-hidden="true"
      style="display: none"
    >
      <div class="modal-panel" role="dialog" aria-modal="true" id="reportModal">
        <button
          type="button"
          class="modal-close-btn"
          aria-label="Close report dialog"
          onclick="closeReportModal()"
        >
          Ã—
        </button>
        <div class="modal-title">Report Product</div>
        <div class="modal-body">
          <p style="margin-bottom: 8px; font-size: 16px">
            Please select the reason for reporting this product:
          </p>
          <div class="modal-notice" role="status" aria-live="polite">
            <svg
              class="notice-icon"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
            >
              <path
                d="M12 9v4"
                stroke="#dc2626"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M12 17h.01"
                stroke="#dc2626"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                stroke="#dc2626"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                fill="none"
              />
            </svg>
            <div class="notice-text">
              <strong>Important:</strong> Your report will be reviewed by our
              moderation team. False or abusive reports may result in account
              restrictions.
            </div>
          </div>
          <form id="reportForm">
            <div class="radio-list">
              <label
                ><input
                  type="radio"
                  name="reason"
                  value="intellectual_property"
                />
                Intellectual Property Violation</label
              >
              <label
                ><input type="radio" name="reason" value="inappropriate" />
                Inappropriate Content</label
              >
              <label
                ><input type="radio" name="reason" value="fraud" /> Fraud /
                Scam</label
              >
              <label
                ><input type="radio" name="reason" value="spam" /> Spam</label
              >
              <label
                ><input type="radio" name="reason" value="not_product" /> Not a
                Product / Wrong Listing</label
              >
              <label
                ><input type="radio" name="reason" value="other" /> Other</label
              >
            </div>
            <div style="margin-top: 20px">
              <label class="field-label" for="reportDetails"
                >Additional details (optional)</label
              >
              <textarea
                id="reportDetails"
                name="details"
                class="textarea-field"
                placeholder="Please provide any additional information that might help our team review this report..."
                rows="4"
              ></textarea>
            </div>
            <input type="hidden" name="product_id" value="{{ product.id }}" />
          </form>
        </div>
        <div class="modal-actions">
          <button
            class="btn secondary"
            type="button"
            onclick="closeReportModal()"
          >
            Cancel
          </button>
          <button
            class="btn danger"
            type="button"
            id="submitReportBtn"
            onclick="submitReport()"
          >
            Submit Report
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Product Images Section -->
      <div class="product-images">
        <!-- Thumbnail Images on the Left -->
        <div class="thumbnail-images">
          <img
            src="{{ product.primaryImage }}"
            alt="{{ product.name }} front view"
            class="thumbnail active"
            data-index="0"
            onclick="changeMainImage(this, 0)"
          />
          <img
            src="{{ product.secondaryImage }}"
            alt="{{ product.name }} side view"
            class="thumbnail"
            data-index="1"
            onclick="changeMainImage(this, 1)"
          />
          <img
            src="{{ product.primaryImage }}"
            alt="{{ product.name }} back view"
            class="thumbnail"
            data-index="2"
            onclick="changeMainImage(this, 2)"
          />
        </div>

        <!-- Main Image Container on the Right -->
        <div class="main-image-container">
          <div class="main-image">
            <img
              id="mainImage"
              src="{{ product.primaryImage }}"
              alt="{{ product.name }}"
            />
            <div class="zoom-box" id="zoomBox"></div>
            <div class="zoom-viewer" id="zoomViewer">
              <img
                id="zoomImage"
                src="{{ product.primaryImage }}"
                alt="Zoomed view of {{ product.name }}"
              />
            </div>
            <div class="image-overlay-buttons">
              <button
                class="wishlist-btn"
                id="wishlistBtn"
                style="
                  background: rgba(255, 255, 255, 0.9);
                  border: none;
                  border-radius: 50%;
                  width: 44px;
                  height: 44px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                  position: absolute;
                  top: 15px;
                  right: 15px;
                "
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Details Section -->
      <div class="product-details" data-product-id="{{ product.id }}">
        <!-- Report Button in Upper Right -->
        <div
          class="report-container"
          style="
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px;
          "
        >
          <span
            class="report-text"
            style="
              font-size: 14px;
              color: #dc143c;
              text-decoration: underline;
              font-weight: 400;
            "
            >Report</span
          >
          <button
            class="report-btn-details"
            onclick="reportProduct()"
            style="
              background: none;
              border: none;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
              ></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </button>
        </div>

        <!-- Breadcrumb -->
        <nav
          class="breadcrumb"
          style="display: flex; gap: 10px; font-size: 14px; margin-bottom: 20px"
        >
          <a
            href="/"
            onclick="navigateToHome(event)"
            style="color: #666; text-decoration: none"
            >Home</a
          >
          <span style="color: #999">></span>
          <a
            href="/category/tops"
            onclick="navigateToCategory(event, 'tops')"
            style="color: #666; text-decoration: none"
            >Tops</a
          >
          <span style="color: #999">></span>
          <span style="color: #333">{{ product.name }}</span>
        </nav>

        <!-- Product Info -->
        <h1
          class="product-title"
          style="font-size: 28px; margin-bottom: 15px; font-weight: 700"
        >
          {{ product.name }}
        </h1>

        <!-- Price Section -->
        <div
          class="price-section"
          style="
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            gap: 10px;
          "
        >
          <div
            class="price-container"
            style="display: flex; align-items: baseline; gap: 15px"
          >
            <div
              class="price-main"
              style="font-size: 42px; font-weight: 700; color: #000"
            >
              â‚±{{ "{:,.2f}".format(product.price) }}
              <span
                class="currency"
                style="font-size: 16px; font-weight: normal"
                >PHP</span
              >
            </div>
            <div
              class="price-details"
              style="display: flex; align-items: center"
            >
              {% if product.originalPrice %}
              <span
                class="original-price"
                style="text-decoration: line-through; color: #999"
                >â‚±{{ "{:,.2f}".format(product.originalPrice) }}</span
              >
              {% if product.originalPrice > product.price %}
              <span
                class="discount-badge"
                style="
                  background-color: #8e44ad;
                  color: white;
                  padding: 2px 8px;
                  border-radius: 4px;
                  margin-left: 10px;
                  font-size: 14px;
                "
                >{{ ((product.originalPrice - product.price) /
                product.originalPrice * 100) | round | int }}% OFF</span
              >
              {% endif %} {% endif %}
            </div>
          </div>

          <!-- Ratings and Sales Section -->
          <div
            class="ratings-sales-section"
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              font-size: 14px;
              color: #666;
            "
          >
            <!-- Star Rating -->
            <div
              class="rating-container"
              style="display: flex; align-items: center; gap: 4px"
            >
              <div class="stars" style="display: flex; gap: 2px">
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#fbbf24"
                  stroke="#fbbf24"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#fbbf24"
                  stroke="#fbbf24"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#fbbf24"
                  stroke="#fbbf24"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#fbbf24"
                  stroke="#fbbf24"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="#d1d5db"
                  stroke="#d1d5db"
                  stroke-width="1"
                >
                  <polygon
                    points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
                  ></polygon>
                </svg>
              </div>
              <span style="font-weight: 600; color: #333">0.0</span>
            </div>

            <span style="color: #ccc">|</span>

            <!-- Number of Ratings -->
            <div
              class="ratings-container"
              style="display: flex; align-items: center; gap: 4px"
            >
              <span style="font-weight: 500">0 Ratings</span>
            </div>

            <span style="color: #ccc">|</span>

            <!-- Sold Container -->
            <div
              class="sold-container"
              style="display: flex; align-items: center; gap: 5px"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#666"
                stroke-width="2"
              >
                <path
                  d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"
                ></path>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <path d="M16 10a4 4 0 0 1-8 0"></path>
              </svg>
              <span class="sold-text">0 Sold</span>
            </div>
          </div>
        </div>

        <!-- Color Selection -->
        <div
          class="color-section"
          {%
          if
          not
          stock_data
          %}style="display: none;"
          {%
          endif
          %}
        >
          <label class="section-label"
            >COLOR
            <span class="selected-color">Select Color</span>
          </label>
          <div class="color-options">
            {% for color, sizes in stock_data.items() %} {% set total_stock =
            sizes.values()|sum %} {% set color_hex = variant_photos.get(color,
            {}).get('color_hex', '#000000') %}
            <button
              type="button"
              class="color-option color-circle{% if total_stock == 0 %} disabled out-of-stock{% endif %}"
              data-color="{{ color }}"
              data-stock="{{ sizes|tojson|e }}"
              data-total-stock="{{ total_stock }}"
              data-color-hex="{{ color_hex }}"
              title="{{ color }}{% if total_stock == 0 %} - Out of Stock{% endif %}"
              onclick="
                console.log('ðŸ–±ï¸ Onclick handler fired for: {{ color }}');
                this.classList.add('debug-clicked');
                setTimeout(() => this.classList.remove('debug-clicked'), 1000);
                if (window.simpleSelectColor) {
                  window.simpleSelectColor(this);
                } else {
                  console.error('âŒ window.simpleSelectColor not available');
                  alert('Color selection function not loaded!');
                }
              "
              style="background-color: {{ color_hex }};"
            >
              {% if total_stock == 0 %}
              <span class="oos-overlay">
                <i class="oos-icon">âœ•</i>
              </span>
              {% endif %}
            </button>
            {% endfor %}
          </div>
        </div>

        <!-- Size Selection -->
        <div class="size-section">
          <label class="section-label">SIZE</label>
          <div class="size-options" id="sizeOptions">
            <div class="size-placeholder">
              Select a color to view available sizes
            </div>
          </div>
          <div class="size-info" id="modelInfo">
            <span>Model is 5'10", wearing a size S</span>
          </div>
        </div>
        <div class="shipping-info">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#1565c0"
            stroke-width="2"
            class="shipping-icon"
          >
            <rect x="1" y="3" width="15" height="13"></rect>
            <path d="m16 6 4 4v6"></path>
            <circle cx="5.5" cy="18.5" r="2.5"></circle>
            <circle cx="18.5" cy="18.5" r="2.5"></circle>
          </svg>
          <span
            >Free shipping on orders over â‚±2,000 | Easy returns within 30
            days</span
          >
        </div>

        <!-- Quantity and Stock Section -->
        <div class="quantity-section">
          <label class="section-label">QUANTITY</label>
          <div class="quantity-controls-group">
            <div class="quantity-selector">
              <button
                class="quantity-btn"
                onclick="decreaseQuantity()"
                id="decreaseBtn"
              >
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <input
                type="number"
                class="quantity-input"
                value="1"
                min="1"
                max="10"
                id="quantityInput"
                onchange="updateQuantity()"
              />
              <button
                class="quantity-btn"
                onclick="increaseQuantity()"
                id="increaseBtn"
              >
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
            <div class="stock-section">
              <span class="stock-indicator" id="stockIndicator"> 0 </span>
              <span class="stock-label">in stock</span>
            </div>
          </div>
        </div>

        <!-- Add to Bag Button -->
        <button class="add-to-bag-btn">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
          ADD TO BAG
        </button>
      </div>
    </div>

    <!-- Bottom Tabs -->
    <div class="bottom-tabs">
      <button
        class="tab-btn active"
        onclick="switchTab(this, 'product-details')"
      >
        Product Details
      </button>
      <button class="tab-btn" onclick="switchTab(this, 'ratings-reviews')">
        Ratings & Reviews
      </button>
    </div>

    <div class="tab-content">
      <div id="product-details" class="tab-panel active">
        <!-- Include Product Dropdown Details -->
        {% include 'main/partials/_product_dropdown_details.html' %}
      </div>
      <div id="ratings-reviews" class="tab-panel">
        <!-- Include Reviews Dropdown -->
        {% include 'main/partials/_reviews_dropdown.html' %}
      </div>
    </div>

    <!-- Include Footer -->
    {% include 'main/partials/_footer.html' %}

    <!-- Include Add to Cart Popup -->
    {% include 'main/partials/_add_to_cart_pop.html' %}

    <!-- Variant photo map: mapping color -> photo url(s). Backend should pass `variant_photos` dict. -->
    <script>
      // Example shape from backend: { "Black": {"primary": "/static/uploads/black1.jpg","secondary": "/static/uploads/black2.jpg"}, "Red": "/static/uploads/red.jpg" }
      window.variantPhotoMap = {{ variant_photos | default({}) | tojson | safe }};

      // Stock data for dynamic size selection based on color
      // Example shape: { "Black": {"XS": 15, "S": 25, "M": 30}, "White": {"XS": 12, "S": 18} }
      window.stockData = {{ stock_data | default({}) | tojson | safe }};
      window._pageStockData = window.stockData; // Alias for compatibility
      window.productId = {{ product.id | tojson | safe }};

      console.log('Stock data loaded:', window.stockData);
      console.log('Product ID:', window.productId);
      console.log('Variant photos loaded:', window.variantPhotoMap);

      // Initialize stock display after data is loaded
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for other initialization to complete
        setTimeout(function() {
          if (typeof updateStockDisplay === 'function') {
            console.log('Initializing stock display...');
            updateStockDisplay();
          }
        }, 100);
      });
    </script>
    <script>
      // Store info functions
      function chatWithStore() {
        // TODO: Implement chat functionality
        alert("Chat feature coming soon!");
      }

      function viewShop(sellerId) {
        // Navigate to store page
        window.location.href = `/store/${sellerId}`;
      }

      // Report modal helpers
      function reportProduct() {
        const backdrop = document.getElementById("reportBackdrop");
        if (!backdrop) return;
        backdrop.style.display = "flex";
        backdrop.setAttribute("aria-hidden", "false");
      }

      function closeReportModal() {
        const backdrop = document.getElementById("reportBackdrop");
        if (!backdrop) return;
        backdrop.style.display = "none";
        backdrop.setAttribute("aria-hidden", "true");
      }

      async function submitReport() {
        const btn = document.getElementById("submitReportBtn");
        if (btn) btn.disabled = true;

        try {
          const form = document.getElementById("reportForm");
          const fd = new FormData(form);
          const reason = fd.get("reason");
          const details = fd.get("details") || "";
          const productId = fd.get("product_id");

          if (!reason) {
            alert("Please select a reason for reporting.");
            if (btn) btn.disabled = false;
            return;
          }

          const resp = await fetch(`/api/product/${productId}/report`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reason: reason, details: details }),
          });

          const data = await resp.json();
          if (!resp.ok) {
            console.error("Report error", data);
            alert(data.error || "Failed to submit report");
            if (btn) btn.disabled = false;
            return;
          }

          alert(
            "Report submitted â€” thank you. Our team will review this product."
          );
          closeReportModal();
        } catch (e) {
          console.error("submitReport error", e);
          alert("An unexpected error occurred while sending the report.");
        } finally {
          if (btn) btn.disabled = false;
        }
      }
    </script>

    <!-- Main product detail JavaScript -->
    <script src="{{ url_for('static', filename='js/buyer_scripts/product_detail.js') }}"></script>

    <!-- Supporting scripts -->
    <script src="{{ url_for('static', filename='js/buyer_scripts/partials/_product_dropdown_details.js') }}"></script>
    <script src="{{ url_for('static', filename='js/buyer_scripts/partials/_reviews_dropdown.js') }}"></script>
    <script>
      // Stock indicator fix - override functions to handle malformed data
      (function () {
        "use strict";

        let selectedColor = null;
        let selectedSize = null;

        // Parse stock data (handles malformed JSON)
        // Removed parseStockData function with hardcoded fallback sizes
        // Size data is now fetched dynamically from the database via API

        // Override selectColor function
        // Removed conflicting inline selectColor and updateSizeOptions functions
        // These are now handled by the external product_detail.js file which calls the API

        // Removed conflicting inline selectSize function
        // This is now handled by the external product_detail.js file

        window.updateStockDisplay = function () {
          console.log(
            "Stock Fix: updateStockDisplay - Color:",
            selectedColor,
            "Size:",
            selectedSize
          );

          const stockIndicator = document.getElementById("stockIndicator");
          const quantityInput = document.getElementById("quantityInput");
          const addToBagBtn = document.querySelector(".add-to-bag-btn");
          const decreaseBtn = document.getElementById("decreaseBtn");
          const increaseBtn = document.getElementById("increaseBtn");

          if (!stockIndicator) return;

          if (!selectedColor || !selectedSize) {
            stockIndicator.textContent = "0";
            stockIndicator.className = "stock-indicator out-of-stock";
            if (quantityInput) {
              quantityInput.max = 0;
              quantityInput.value = 1;
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = true;
              addToBagBtn.textContent = "OUT OF STOCK";
              addToBagBtn.style.opacity = "0.6";
            }
            if (decreaseBtn) decreaseBtn.disabled = true;
            if (increaseBtn) increaseBtn.disabled = true;
            return;
          }

          const selectedSizeButton = document.querySelector(
            ".size-option.active"
          );
          let availableStock = 0;

          if (selectedSizeButton) {
            availableStock =
              parseInt(selectedSizeButton.getAttribute("data-stock")) || 0;
          }

          console.log("Available stock for", selectedSize, ":", availableStock);
          stockIndicator.textContent = availableStock;

          if (availableStock > 0) {
            stockIndicator.className = "stock-indicator in-stock";
            if (quantityInput) {
              quantityInput.max = availableStock;
              const currentQuantity = parseInt(quantityInput.value) || 1;
              if (currentQuantity > availableStock) {
                quantityInput.value = availableStock;
              }
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = false;
              addToBagBtn.textContent = "ADD TO BAG";
              addToBagBtn.style.opacity = "1";
            }
            updateQuantityControls();
          } else {
            stockIndicator.className = "stock-indicator out-of-stock";
            if (quantityInput) {
              quantityInput.max = 0;
              quantityInput.value = 1;
            }
            if (addToBagBtn) {
              addToBagBtn.disabled = true;
              addToBagBtn.textContent = "OUT OF STOCK";
              addToBagBtn.style.opacity = "0.6";
            }
            if (decreaseBtn) decreaseBtn.disabled = true;
            if (increaseBtn) increaseBtn.disabled = true;
          }
        };

        // Quantity control functions
        window.decreaseQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let currentQuantity = parseInt(quantityInput.value) || 1;
          if (currentQuantity > 1) {
            quantityInput.value = currentQuantity - 1;
            updateQuantityControls();
          }
        };

        window.increaseQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let currentQuantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          if (currentQuantity < maxQuantity) {
            quantityInput.value = currentQuantity + 1;
            updateQuantityControls();
          }
        };

        window.updateQuantity = function () {
          const quantityInput = document.getElementById("quantityInput");
          if (!quantityInput) return;

          let quantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          if (quantity < 1) {
            quantityInput.value = 1;
          } else if (quantity > maxQuantity && maxQuantity > 0) {
            quantityInput.value = maxQuantity;
          }

          updateQuantityControls();
        };

        function updateQuantityControls() {
          const quantityInput = document.getElementById("quantityInput");
          const decreaseBtn = document.getElementById("decreaseBtn");
          const increaseBtn = document.getElementById("increaseBtn");

          if (!quantityInput) return;

          const currentQuantity = parseInt(quantityInput.value) || 1;
          const maxQuantity = parseInt(quantityInput.max) || 0;

          // Update decrease button
          if (decreaseBtn) {
            decreaseBtn.disabled = currentQuantity <= 1;
          }

          // Update increase button
          if (increaseBtn) {
            increaseBtn.disabled =
              currentQuantity >= maxQuantity || maxQuantity <= 0;
          }

          console.log("ðŸŽ›ï¸ Quantity controls updated:", {
            current: currentQuantity,
            max: maxQuantity,
            decreaseDisabled: currentQuantity <= 1,
            increaseDisabled: currentQuantity >= maxQuantity,
          });
        }

        // Make updateQuantityControls globally accessible
        window.updateQuantityControls = updateQuantityControls;

        // Add to bag functionality
        window.addToBag = function () {
          console.log("ðŸ›’ Add to bag clicked!");

          // Check if button is disabled
          const addToBagBtn = document.querySelector(".add-to-bag-btn");
          if (addToBagBtn && addToBagBtn.disabled) {
            console.log("â›” Button is disabled - checking why...");

            // Check current selections
            const selectedColor = getSelectedColor();
            const selectedSize = getSelectedSize();

            if (!selectedColor) {
              alert("Please select a color first");
              return;
            }

            if (!selectedSize) {
              alert("Please select a size first");
              return;
            }

            alert("This size is out of stock. Please select a different size.");
            return;
          }

          // Get currently selected values
          const selectedColor = getSelectedColor();
          const selectedSize = getSelectedSize();
          const quantity = getSelectedQuantity();

          console.log("Selected values:", {
            color: selectedColor,
            size: selectedSize,
            quantity: quantity,
          });

          // Validate selections
          if (!selectedColor) {
            alert("Please select a color");
            return;
          }

          if (!selectedSize) {
            alert("Please select a size");
            return;
          }

          // Update modal with selected values
          updateCartModal(selectedColor, selectedSize, quantity);

          // Show the cart modal
          showCartModal();
        };

        // Get currently selected color
        function getSelectedColor() {
          const selectedColorOption = document.querySelector(
            ".color-option.active"
          );
          return selectedColorOption ? selectedColorOption.dataset.color : null;
        }

        // Get currently selected size
        function getSelectedSize() {
          const selectedSizeOption = document.querySelector(
            ".size-option.active"
          );
          return selectedSizeOption ? selectedSizeOption.dataset.size : null;
        }

        // Get current quantity
        function getSelectedQuantity() {
          const quantityInput = document.getElementById("quantityInput");
          return quantityInput ? parseInt(quantityInput.value) || 1 : 1;
        }

        // Update cart modal with current selections
        function updateCartModal(color, size, quantity) {
          console.log("ðŸŽ¨ Updating cart modal with:", {
            color,
            size,
            quantity,
          });

          // Update color display
          const colorDisplay = document.getElementById(
            "cartModalSelectedColor"
          );
          if (colorDisplay) {
            colorDisplay.textContent = color;
          }

          // Update size display
          const sizeDisplay = document.getElementById("cartModalSelectedSize");
          if (sizeDisplay) {
            sizeDisplay.textContent = size;
          }

          // Update quantity display
          const quantityDisplay = document.getElementById(
            "cartModalSelectedQuantity"
          );
          if (quantityDisplay) {
            quantityDisplay.textContent = quantity;
          }

          // Update item count in modal header
          const itemCount = document.querySelector(".cart-item-count");
          if (itemCount) {
            itemCount.textContent =
              quantity === 1 ? "1 Item" : `${quantity} Items`;
          }

          // Update product image in modal
          const modalImage = document.querySelector(".cart-product-image img");
          const currentMainImage = document.querySelector(
            ".main-product-image"
          );
          if (modalImage && currentMainImage) {
            modalImage.src = currentMainImage.src;
            modalImage.alt = currentMainImage.alt;
            console.log("ðŸ–¼ï¸ Updated modal image to:", modalImage.src);
          }
        }

        // Show cart modal
        function showCartModal() {
          console.log("ðŸ“± Opening cart modal");
          const modal = document.getElementById("cartModalOverlay");
          console.log("Modal element found:", modal);
          
          if (modal) {
            console.log("Adding active class to modal");
            modal.classList.add("active");
            document.body.style.overflow = "hidden";
            
            // Check if modal is visible after adding class
            setTimeout(() => {
              const computedStyle = window.getComputedStyle(modal);
              console.log("Modal display:", computedStyle.display);
              console.log("Modal visibility:", computedStyle.visibility);
              console.log("Modal opacity:", computedStyle.opacity);
              console.log("Modal classList:", [...modal.classList]);
            }, 100);
          } else {
            console.error("âŒ Modal element with ID 'cartModalOverlay' not found!");
            
            // Try to find any modal-related elements
            const allModals = document.querySelectorAll('[id*="modal"], [class*="modal"]');
            console.log("All modal-related elements found:", allModals);
          }
        }

        // Auto-initialize
        console.log("Stock indicator fix script loaded successfully");

        // Initialize product controls
        setTimeout(() => {
          initializeProductControls();

          // Add debugging info
          console.log("ðŸ” Available debug functions:");
          console.log("- window.debugAddToBagButton() - Check button state");
          console.log("- window.debugStockData() - Check stock data");
          console.log("- window.testColorSelection() - Test color selection");
          console.log("- window.testCartModal() - Test cart modal display");
        }, 500);
        setTimeout(() => {
          console.log("Initializing stock system...");
          const colorOptions = document.querySelectorAll(".color-option");
          console.log("Found", colorOptions.length, "color options");
          if (colorOptions.length === 1) {
            console.log("Auto-selecting single color");
            selectColor(colorOptions[0]);
          }
        }, 100);
      })();
    </script>
    <script>
      // Initialize zoom functionality on the main image
      document.addEventListener("DOMContentLoaded", function () {
        // Add zoom functionality to the main image
        const mainImage = document.querySelector(".main-image");
        if (mainImage) {
          mainImage.addEventListener("mousemove", showZoomBox);
          mainImage.addEventListener("mouseleave", hideZoomBox);
        }

        // Initialize thumbnail gallery
        const thumbnails = document.querySelectorAll(".thumbnail-image");
        thumbnails.forEach((thumbnail, index) => {
          thumbnail.addEventListener("click", function () {
            changeMainImage(this, index);
          });
        });

        // Set the first thumbnail as active by default if available
        if (thumbnails.length > 0) {
          thumbnails[0].click();
        }

        // Ensure stock display is updated on page load
        try {
          updateSizeAvailability();
          updateColorAvailability();
          updateStockDisplay();
        } catch (e) {
          console.warn("Error initializing stock display:", e);
        }

        // Add to bag button functionality
        const addToBagBtn = document.querySelector(".add-to-bag-btn");
        if (addToBagBtn) {
          console.log("ðŸ›’ Add to bag button found and event listener added");
          // Remove any existing onclick attribute to avoid conflicts
          addToBagBtn.removeAttribute("onclick");
          addToBagBtn.addEventListener("click", window.addToBag);
        }

        // Initialize quantity buttons
        try {
          updateQuantityButtons();
        } catch (e) {
          console.warn("Error initializing quantity buttons:", e);
        }

        console.log("Product detail scripts initialized");
      });

      // Add fallback CSS loading check
      window.addEventListener("load", function () {
        // Debug information about the page setup
        console.log("Product data:", {
          name: "{{ product.name }}",
          price: "{{ product.price }}",
          primaryImage: "{{ product.primaryImage }}",
          secondaryImage: "{{ product.secondaryImage }}",
        });

        // List all loaded scripts for debugging
        const scripts = document.querySelectorAll("script");
        console.log("Loaded scripts:");
        scripts.forEach((script, index) => {
          console.log(`Script ${index + 1}:`, script.src || "Inline script");
        });

        // Check if CSS is loaded correctly
        const styleSheets = document.styleSheets;
        console.log("All stylesheets:", styleSheets.length);
        let cssLoaded = false;

        for (let i = 0; i < styleSheets.length; i++) {
          try {
            console.log(`Stylesheet ${i + 1}:`, styleSheets[i].href);
            if (
              styleSheets[i].href &&
              styleSheets[i].href.includes("product_detail.css")
            ) {
              cssLoaded = true;
              break;
            }
          } catch (e) {
            console.error("Error accessing stylesheet:", e);
          }
        }

        if (!cssLoaded) {
          console.warn("Product detail CSS might not be loaded correctly");
          // Apply minimal styling through JS to ensure the page is still usable
          const container = document.querySelector(".container");
          if (container) {
            container.style.maxWidth = "1200px";
            container.style.margin = "20px auto 0";
            container.style.padding = "20px";
          }

          // Apply basic styling to product images
          const mainImageContainer = document.querySelector(
            ".main-image-container"
          );
          if (mainImageContainer) {
            mainImageContainer.style.width = "100%";
            mainImageContainer.style.maxHeight = "500px";
            mainImageContainer.style.overflow = "hidden";
            mainImageContainer.style.position = "relative";
          }

          // Make sure thumbnails are visible
          const thumbnailContainer = document.querySelector(
            ".thumbnail-container"
          );
          if (thumbnailContainer) {
            thumbnailContainer.style.display = "flex";
            thumbnailContainer.style.flexWrap = "wrap";
            thumbnailContainer.style.gap = "10px";
            thumbnailContainer.style.marginTop = "10px";
          }

          // Apply additional styles if needed
          document.querySelector(".product-title").style.fontSize = "24px";
          document.querySelector(".product-title").style.marginTop = "20px";
          document.querySelector(".price-section").style.marginTop = "10px";
        } else {
          console.log("Product detail CSS loaded successfully");
        }
      });
    </script>
    <!-- Debug script to verify functionality -->
    <script>
      // Verify our functions are loaded
      setTimeout(() => {
        console.log("ðŸ” Checking function availability:");
        console.log(
          "- window.simpleSelectColor:",
          typeof window.simpleSelectColor
        );
        console.log("- selectColor:", typeof selectColor);

        const colorOptions = document.querySelectorAll(".color-option");
        const sizeContainer = document.getElementById("sizeOptions");
        console.log("ðŸ“Š DOM elements:");
        console.log("- Color options found:", colorOptions.length);
        console.log("- Size container found:", !!sizeContainer);

        if (colorOptions.length > 0) {
          console.log("âœ… Product detail page setup looks good!");
        } else {
          console.log(
            "âš ï¸ No color options found - may be a product without variants"
          );
        }
      }, 1000);
    </script>

    <!-- Fallback CSS for debug -->
    <style>
      /* Aggressive color option active state */
      .color-option.active {
        border-color: #8e44ad !important;
        transform: scale(1.1) !important;
        box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.3) !important;
        z-index: 15 !important;
        position: relative !important;
      }

      /* Ensure color options are clickable */
      .color-option {
        pointer-events: auto !important;
        cursor: pointer !important;
        z-index: 10 !important;
      }

      /* Size option active state */
      .size-option.active {
        border-color: #8e44ad !important;
        background-color: #8e44ad !important;
        color: white !important;
        transform: scale(1.05) !important;
        z-index: 10 !important;
      }

      /* Ensure size options are clickable */
      .size-option {
        pointer-events: auto !important;
        cursor: pointer !important;
      }

      /* Make sure overlays don't block clicks */
      .oos-overlay {
        pointer-events: none !important;
      }

      /* Debug styles */
      .color-option:hover {
        outline: 2px solid orange !important;
      }

      .debug-clicked {
        outline: 3px solid red !important;
      }
    </style>

    <!-- Load order check -->
    <script>
      console.log("ðŸ“„ Product detail template scripts loaded");

      // Define simple color selection function directly in template to ensure availability
      window.simpleSelectColor = function (button) {
        console.log("=== SIMPLE SELECT COLOR CALLED ===", button.dataset.color);

        // Remove active from all color buttons
        document.querySelectorAll(".color-option").forEach((btn) => {
          btn.classList.remove("active");
          btn.style.transform = "";
          btn.style.boxShadow = "";
        });

        // Add active to clicked button
        button.classList.add("active");
        button.style.transform = "scale(1.1)";
        button.style.boxShadow = "0 0 0 3px rgba(142, 68, 173, 0.3)";

        // Update selected color text
        const span = document.querySelector(".selected-color");
        if (span) span.textContent = button.dataset.color;

        // Update global state
        window.selectedColor = button.dataset.color;

        console.log("âœ… Color selected:", button.dataset.color);

        // Reset stock indicator when color changes (before size selection)
        const stockIndicator = document.getElementById("stockIndicator");
        if (stockIndicator) {
          stockIndicator.textContent = "Select size";
          stockIndicator.className = "stock-indicator";
        }

        // Reset quantity input
        const quantityInput = document.getElementById("quantityInput");
        if (quantityInput) {
          quantityInput.value = 1;
          quantityInput.max = 0;
        }

        // Update quantity button states
        if (typeof updateQuantityControls === "function") {
          updateQuantityControls();
        }

        // Load sizes for this color
        window.loadSizesForColor(button.dataset.color, button);
      };

      // Function to load sizes for selected color
      window.loadSizesForColor = function (colorName, colorButton) {
        console.log("ðŸ“ Loading sizes for color:", colorName);

        const sizeContainer = document.getElementById("sizeOptions");
        if (!sizeContainer) {
          console.error("âŒ Size container not found!");
          return;
        }

        try {
          // Get stock data from button with robust parsing
          let stockData = {};
          const rawStockData = colorButton.dataset.stock || "{}";

          console.log("ðŸ“‹ Raw stock data:", rawStockData);
          console.log("ðŸ“‹ Raw stock data type:", typeof rawStockData);
          console.log("ðŸ“‹ Raw stock data length:", rawStockData.length);

          try {
            // First try to parse as JSON
            stockData = JSON.parse(rawStockData);
          } catch (jsonError) {
            console.warn(
              "âš ï¸ JSON parse failed, trying alternative parsing:",
              jsonError.message
            );

            // Try to fix common JSON issues
            let fixedData = rawStockData
              .replace(/'/g, '"') // Replace single quotes with double quotes
              .replace(/(\w+):/g, '"$1":') // Add quotes around property names
              .replace(/,\s*}/g, "}") // Remove trailing commas
              .replace(/,\s*]/g, "]"); // Remove trailing commas in arrays

            console.log("ðŸ”§ Attempting to parse fixed data:", fixedData);

            try {
              stockData = JSON.parse(fixedData);
            } catch (fixError) {
              console.error(
                "âŒ Both parsing attempts failed, trying API fallback"
              );

              // Try to get product ID for API call
              const productId =
                window.productId ||
                document.querySelector("[data-product-id]")?.dataset
                  .productId ||
                window.location.pathname.split("/").pop();

              if (productId) {
                console.log(
                  "ðŸŒ Attempting API fallback for product:",
                  productId
                );

                // Show loading message
                sizeContainer.innerHTML =
                  '<div style="color: #666; padding: 10px; font-style: italic;">Loading sizes...</div>';

                // Fetch from API
                fetch(
                  `/api/product/${productId}/sizes/${encodeURIComponent(
                    colorName
                  )}`
                )
                  .then((response) => response.json())
                  .then((data) => {
                    if (data.success && data.sizes) {
                      console.log("âœ… API fallback successful:", data.sizes);
                      stockData = data.sizes;
                      renderSizes(stockData, sizeContainer);
                    } else {
                      throw new Error(data.error || "API returned no sizes");
                    }
                  })
                  .catch((apiError) => {
                    console.error("âŒ API fallback also failed:", apiError);
                    // Final fallback: create basic structure
                    stockData = { XS: 0, S: 0, M: 0, L: 0, XL: 0 };
                    renderSizes(stockData, sizeContainer);
                  });
                return; // Exit early since we're using async API
              } else {
                // No product ID available, use basic fallback
                stockData = { XS: 0, S: 0, M: 0, L: 0, XL: 0 };
              }
            }
          }

          console.log("ðŸ“Š Final stock data for color:", stockData);

          // Render the sizes using helper function
          renderSizes(stockData, sizeContainer);
        } catch (e) {
          console.error("âŒ Error loading sizes:", e);
          sizeContainer.innerHTML = `<div style="color: red; padding: 10px;">Error loading sizes: ${e.message}</div>`;
        }
      };

      // Helper function to render sizes
      function renderSizes(stockData, sizeContainer) {
        console.log("ðŸŽ¨ Rendering sizes with data:", stockData);

        // Clear container
        sizeContainer.innerHTML = "";

        // Define size order for proper sorting
        const sizeOrder = ["XS", "S", "M", "L", "XL", "XXL", "3XL"];
        const sizes = Object.keys(stockData).sort((a, b) => {
          const aIndex = sizeOrder.indexOf(a);
          const bIndex = sizeOrder.indexOf(b);
          if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
          if (aIndex !== -1) return -1;
          if (bIndex !== -1) return 1;
          return a.localeCompare(b);
        });

        // Create size buttons
        sizes.forEach((size) => {
          let stock = stockData[size];

          // Debug the stock value
          console.log(
            `ðŸ“¦ Size ${size} raw stock:`,
            stock,
            `(type: ${typeof stock})`
          );

          // Convert to number and handle various data types
          if (typeof stock === "string") {
            stock = parseInt(stock, 10);
          } else if (typeof stock === "object" && stock !== null) {
            // If it's an object, try to get a stock property
            stock = stock.stock || stock.quantity || stock.count || 0;
          }

          // Ensure we have a valid number
          if (isNaN(stock) || stock === null || stock === undefined) {
            stock = 0;
          }

          console.log(
            `ðŸ“Š Size ${size} final stock:`,
            stock,
            `(available: ${stock > 0})`
          );

          const sizeBtn = document.createElement("button");
          sizeBtn.className =
            "size-option" + (stock > 0 ? "" : " out-of-stock");
          sizeBtn.textContent = size;
          sizeBtn.dataset.size = size;
          sizeBtn.dataset.stock = stock;
          sizeBtn.title = `${size} - ${stock} in stock`;

          // Add debug info to button text temporarily
          sizeBtn.textContent = `${size} (${stock})`;

          sizeBtn.onclick = () => window.simpleSelectSize(sizeBtn);
          sizeContainer.appendChild(sizeBtn);
        });

        console.log(`âœ… ${sizes.length} sizes rendered successfully`);
      }

      // Simple size selection function
      window.simpleSelectSize = function (button) {
        console.log("=== SIMPLE SELECT SIZE CALLED ===", button.dataset.size);

        // Remove active from all size buttons
        document.querySelectorAll(".size-option").forEach((btn) => {
          btn.classList.remove("active");
          btn.style.transform = "";
          btn.style.boxShadow = "";
        });

        // Add active to clicked button
        button.classList.add("active");
        button.style.transform = "scale(1.05)";
        button.style.boxShadow = "0 2px 8px rgba(142, 68, 173, 0.3)";

        // Update global state
        window.selectedSize = button.dataset.size;

        // Get stock for selected size
        const stock = parseInt(button.dataset.stock) || 0;

        // Update stock indicator
        const stockIndicator = document.getElementById("stockIndicator");
        if (stockIndicator) {
          stockIndicator.textContent = stock;
          stockIndicator.className =
            "stock-indicator " + (stock > 0 ? "in-stock" : "out-of-stock");
          console.log("ðŸ“Š Stock indicator updated:", stock);
        }

        // Update quantity input max value
        const quantityInput = document.getElementById("quantityInput");
        if (quantityInput) {
          quantityInput.max = stock;
          if (parseInt(quantityInput.value) > stock) {
            quantityInput.value = Math.max(1, stock);
          }
          console.log("ðŸ”¢ Quantity max set to:", stock);
        }

        // Update quantity button states
        updateQuantityControls();

        console.log("âœ… Size selected:", button.dataset.size, "Stock:", stock);
      };

      console.log("ðŸŽ¨ Simple color/size functions defined and ready!");

      // Aggressively attach event listeners when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ðŸ”§ DOM ready, attaching aggressive event listeners...");

        setTimeout(() => {
          const colorOptions = document.querySelectorAll(".color-option");
          console.log(
            `ðŸŽ¨ Found ${colorOptions.length} color options to attach listeners to`
          );

          colorOptions.forEach((btn, index) => {
            console.log(
              `Attaching listener to color ${index + 1}: ${btn.dataset.color}`
            );

            // Remove any existing listeners
            btn.removeEventListener("click", btn._clickHandler);
            btn.removeEventListener("mousedown", btn._clickHandler);
            btn.removeEventListener("touchstart", btn._clickHandler);

            // Create click handler
            btn._clickHandler = function (e) {
              e.preventDefault();
              e.stopPropagation();
              console.log(
                `ðŸŽ¯ Event listener fired for color: ${this.dataset.color}`
              );
              window.simpleSelectColor(this);
            };

            // Attach multiple event types to ensure it works
            btn.addEventListener("click", btn._clickHandler);
            btn.addEventListener("mousedown", btn._clickHandler);
            btn.addEventListener("touchstart", btn._clickHandler);

            // Ensure the button is clickable
            btn.style.pointerEvents = "auto";
            btn.style.zIndex = "10";

            console.log(`âœ… Listeners attached to ${btn.dataset.color}`);
          });

          console.log("âœ… All event listeners attached!");

          // Initialize stock indicator and quantity controls
          initializeProductControls();

          // Test that functions are available
          if (typeof window.simpleSelectColor === "function") {
            console.log("âœ… window.simpleSelectColor is available");
          } else {
            console.error("âŒ window.simpleSelectColor is NOT available");
          }
        }, 100);
      });

      // Initialize product controls on page load
      function initializeProductControls() {
        console.log("ðŸ”§ Initializing product controls...");

        // Set initial stock indicator state
        const stockIndicator = document.getElementById("stockIndicator");
        if (stockIndicator) {
          stockIndicator.textContent = "Select color & size";
          stockIndicator.className = "stock-indicator";
        }

        // Set initial quantity input state
        const quantityInput = document.getElementById("quantityInput");
        if (quantityInput) {
          quantityInput.value = 1;
          quantityInput.max = 0;
        }

        // Initialize add to bag button state - enable it by default
        const addToBagBtn = document.querySelector(".add-to-bag-btn");
        if (addToBagBtn) {
          addToBagBtn.disabled = false;
          addToBagBtn.textContent = "ADD TO BAG";
          addToBagBtn.style.opacity = "1";
          console.log("âœ… Add to bag button initialized and enabled");
        }

        // Update quantity controls
        if (typeof updateQuantityControls === "function") {
          updateQuantityControls();
        }

        console.log("âœ… Product controls initialized");
      }

      // Add a test function accessible from console
      window.testColorSelection = function () {
        console.log("ðŸ§ª Testing color selection...");
        const firstColor = document.querySelector(".color-option");
        if (firstColor) {
          console.log("Testing with first color:", firstColor.dataset.color);
          window.simpleSelectColor(firstColor);
        } else {
          console.log("âŒ No color buttons found");
        }
      };

      // Add test function for modal
      window.testCartModal = function() {
        console.log("ðŸ§ª Testing cart modal...");
        
        // Test if modal element exists
        const modal = document.getElementById("cartModalOverlay");
        console.log("Modal found:", modal);
        
        if (!modal) {
          console.error("âŒ Modal element not found!");
          return;
        }
        
        // Test updating modal content first
        updateCartModal("Red", "M", 2);
        
        // Test showing modal
        console.log("ðŸ“± Attempting to show modal...");
        showCartModal();
        
        // Check if modal is visible after 500ms
        setTimeout(() => {
          const isVisible = modal.classList.contains("active");
          console.log("Modal has active class:", isVisible);
          
          if (isVisible) {
            console.log("âœ… Modal should be visible now!");
            console.log("If you don't see it, there might be a CSS issue.");
          } else {
            console.log("âŒ Modal doesn't have active class!");
          }
        }, 500);
      };

      // Add debug function to inspect current state
      window.debugAddToBagButton = function () {
        console.log("ðŸ” DEBUGGING ADD TO BAG BUTTON:");
        const addToBagBtn = document.querySelector(".add-to-bag-btn");
        const selectedColor = getSelectedColor();
        const selectedSize = getSelectedSize();
        const selectedSizeBtn = document.querySelector(".size-option.active");

        console.log("Button element:", addToBagBtn);
        console.log(
          "Button disabled:",
          addToBagBtn ? addToBagBtn.disabled : "N/A"
        );
        console.log(
          "Button text:",
          addToBagBtn ? addToBagBtn.textContent : "N/A"
        );
        console.log("Selected color:", selectedColor);
        console.log("Selected size:", selectedSize);
        console.log("Selected size button:", selectedSizeBtn);
        console.log(
          "Size button stock:",
          selectedSizeBtn ? selectedSizeBtn.dataset.stock : "N/A"
        );

        if (
          selectedColor &&
          selectedSize &&
          addToBagBtn &&
          addToBagBtn.disabled
        ) {
          console.log(
            "ðŸš¨ ISSUE: Color and size selected but button still disabled!"
          );
          console.log("Attempting to manually enable button...");
          addToBagBtn.disabled = false;
          addToBagBtn.textContent = "ADD TO BAG";
          addToBagBtn.style.opacity = "1";
          console.log("âœ… Button manually enabled. Try clicking it now.");
        }
      };

      // Add debug function to inspect stock data
      window.debugStockData = function () {
        console.log("ðŸ” DEBUGGING STOCK DATA:");
        const colorButtons = document.querySelectorAll(".color-option");
        colorButtons.forEach((btn, index) => {
          console.log(`Color ${index + 1}: ${btn.dataset.color}`);
          console.log(`  Raw data-stock:`, btn.dataset.stock);
          console.log(`  Type:`, typeof btn.dataset.stock);

          try {
            const parsed = JSON.parse(btn.dataset.stock || "{}");
            console.log(`  Parsed data:`, parsed);
            console.log(`  Object keys:`, Object.keys(parsed));
            Object.keys(parsed).forEach((size) => {
              console.log(
                `    ${size}:`,
                parsed[size],
                `(type: ${typeof parsed[size]})`
              );
            });
          } catch (e) {
            console.log(`  Parse error:`, e.message);
          }
        });
      };

      console.log("ðŸš€ All debugging and event handling ready!");
    </script>
  </body>
</html>
