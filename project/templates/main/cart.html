<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Cart - Dione</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/cart.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/buyer_styles/partials/_header_buyer.css') }}"
    />
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  </head>
  <body>
    {% macro render_cart_card(item) %}
    <div
      class="product-card"
      data-item-id="{{ item.id }}"
      data-max-quantity="{{ item.max_quantity or max_cart_quantity or 100 }}"
    >
      <div class="product-select-control">
        <label class="select-checkbox">
          <input
            type="checkbox"
            class="cart-select"
            data-item-id="{{ item.id }}"
            {%
            if
            item.selected
            is
            not
            defined
            or
            item.selected
            %}checked{%
            endif
            %}
          />
          <span>Select</span>
        </label>
      </div>
      <div class="product-image-container">
        <img
          src="{{ item.image_url if item.image_url else url_for('static', filename='images/product_1.jpg') }}"
          alt="{{ item.name }}"
          class="product-image"
          loading="lazy"
        />
      </div>

      <div class="product-info">
        <div class="product-header">
          <div class="product-meta">
            <div class="meta-left">
              <span class="store-pill">
                <i data-lucide="store"></i>
                {{ item.store_name|default('Dione Store') }}
              </span>
              <div class="sku-wrapper">
                <span class="sku-label">SKU:</span>
                <span class="sku-value">{{ item.sku }}</span>
              </div>
            </div>
            <button
              class="remove-btn"
              data-cart-action="remove"
              data-item-id="{{ item.id }}"
              title="Remove item"
            >
              <i data-lucide="x"></i>
            </button>
          </div>
          <h3 class="product-name">{{ item.name }}</h3>
        </div>

        <div class="product-variants">
          <div class="variant-item">
            <span class="variant-label">Size:</span>
            <span class="variant-value">{{ item.size }}</span>
          </div>
          <div class="variant-item">
            <span class="variant-label">Color:</span>
            <span class="variant-value">{{ item.color }}</span>
          </div>
        </div>

        <div class="product-footer">
          <div class="quantity-section">
            <label class="quantity-label">Quantity</label>
            <div class="quantity-controls">
              <button
                class="qty-btn qty-decrease"
                data-cart-action="decrease"
                data-item-id="{{ item.id }}"
                title="Decrease quantity"
              >
                <i data-lucide="minus"></i>
              </button>
              <input
                type="number"
                class="qty-input"
                value="{{ item.quantity }}"
                id="qty-{{ item.id }}"
                min="1"
                max="{{ item.max_quantity or max_cart_quantity or 100 }}"
                readonly
              />
              <button
                class="qty-btn qty-increase"
                data-cart-action="increase"
                data-item-id="{{ item.id }}"
                title="Increase quantity"
              >
                <i data-lucide="plus"></i>
              </button>
            </div>
          </div>

          <div class="price-section">
            <div class="product-price">
              ₱{{ "%.2f"|format(item.price * item.quantity) }}
            </div>
            {% if item.quantity > 1 %}
            <div class="unit-price">₱{{ "%.2f"|format(item.price) }} each</div>
            {% endif %}
          </div>
        </div>

        <div class="product-actions">
          <button
            class="action-btn save-btn"
            data-cart-action="save"
            data-item-id="{{ item.id }}"
          >
            <i data-lucide="heart"></i>
            Save for later
          </button>
        </div>
      </div>
    </div>
    {% endmacro %}

    <!-- Include Header -->
    {% include 'main/partials/_header_buyer.html' %}

    <!-- Breadcrumb -->
    <div class="breadcrumb-container">
      <nav class="breadcrumb">
        <a href="{{ url_for('main.index') }}" class="breadcrumb-link">
          <i data-lucide="home"></i>
          Home
        </a>
        <i data-lucide="chevron-right" class="breadcrumb-separator"></i>
        <span class="breadcrumb-current">Shopping Cart</span>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-container">
      <!-- Cart Section -->
      <div class="cart-section">
        <div class="cart-header">
          <div class="cart-title-section">
            <h1 class="cart-title">Shopping Cart</h1>
            <p class="cart-subtitle">Review your items before checkout</p>
          </div>
          <div class="item-count">
            <span class="item-number"
              >{{ cart_items|length if cart_items else 0 }}</span
            >
            <span class="item-text"
              >item{{ 's' if cart_items and cart_items|length != 1 else ''
              }}</span
            >
          </div>
        </div>

        {% if cart_items %}
        <div class="shipping-notice">
          <div class="shipping-notice-content">
            <div class="shipping-icon">
              <i data-lucide="truck"></i>
            </div>
            <div class="shipping-text">
              <strong>Free shipping</strong> on orders over ₱1,500
              <span class="shipping-subtext"
                >Estimated delivery: 2-3 business days</span
              >
            </div>
          </div>
        </div>
        <div class="selection-toolbar">
          <label class="select-all-control">
            <input type="checkbox" id="select-all-checkbox" checked />
            <span>Select all</span>
          </label>
          <span class="selected-count-text" id="selected-count-label">
            {{ cart_items|length }} selected
          </span>
        </div>
        {% endif %}

        <!-- Product Cards -->
        {% if cart_items %}
        <div class="cart-items">
          {% if store_groups %} {% for group in store_groups %}
          <section class="store-group" data-store="{{ group.store_name }}">
            {% for item in group.items_list %} {{ render_cart_card(item) }} {%
            endfor %}
          </section>
          {% endfor %} {% else %} {% for item in cart_items %} {{
          render_cart_card(item) }} {% endfor %} {% endif %}
        </div>
        {% else %}
        <div class="empty-cart">
          <div class="empty-cart-icon">
            <i data-lucide="shopping-bag"></i>
          </div>
          <h2 class="empty-cart-title">Your cart is empty</h2>
          <p class="empty-cart-text">
            Looks like you haven't added anything to your cart yet.
          </p>
          <a href="{{ url_for('main.index') }}" class="continue-shopping-btn">
            <i data-lucide="arrow-left"></i>
            Continue Shopping
          </a>
        </div>
        {% endif %}

        <!-- Saved Items Section -->
        {% if cart_items %}
        <div class="saved-section" id="saved-items">
          <div class="saved-header">
            <h2 class="saved-title">
              <i data-lucide="heart"></i>
              Saved for Later
            </h2>
          </div>
          <div id="saved-items-container">
            <div class="no-saved-items" id="no-saved-message">
              <i data-lucide="bookmark"></i>
              <p>No saved items yet</p>
              <span>Items you save for later will appear here</span>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Order Summary -->
      {% if cart_items %}
      <div class="order-summary">
        <div class="summary-header">
          <h2 class="summary-title">Order Summary</h2>
          <div class="summary-badge" id="selected-summary-count">
            {{ cart_items|length }} selected
          </div>
        </div>

        <div class="summary-content">
          <div class="summary-row">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value" id="subtotal"
              >₱{{ "%.2f"|format(subtotal|default(0)) }}</span
            >
          </div>

          <div class="summary-row">
            <span class="summary-label">
              Shipping
              <span class="shipping-info">
                <i data-lucide="info"></i>
                <div class="tooltip">Free shipping on orders over ₱1,500</div>
              </span>
            </span>
            <span class="summary-value" id="delivery">
              {% if subtotal and subtotal >= 1500 %}
              <span class="free-shipping">FREE</span>
              {% else %} ₱{{ "%.2f"|format(delivery_fee|default(150)) }} {%
              endif %}
            </span>
          </div>

          {% if discount and discount > 0 %}
          <div class="summary-row discount-row">
            <span class="summary-label">
              <i data-lucide="tag"></i>
              Discount
            </span>
            <span class="summary-value discount"
              >-₱{{ "%.2f"|format(discount) }}</span
            >
          </div>
          {% endif %}

          <div class="promo-section">
            <div class="promo-input-container">
              <input
                type="text"
                class="promo-input"
                placeholder="Enter promo code"
                id="promo-code"
              />
              <button class="apply-btn" data-cart-action="apply-promo">
                <i data-lucide="tag"></i>
                Apply
              </button>
            </div>
          </div>

          <div class="summary-divider"></div>

          <div class="summary-row total-row">
            <span class="summary-label">Total</span>
            <span class="summary-value total-value" id="total"
              >₱{{ "%.2f"|format(total|default(0)) }}</span
            >
          </div>
        </div>

        <div class="checkout-section">
          <button class="checkout-btn" data-cart-action="checkout">
            <i data-lucide="credit-card"></i>
            Proceed to Checkout
          </button>

          <div class="security-badges">
            <div class="security-item">
              <i data-lucide="shield-check"></i>
              <span>Secure Checkout</span>
            </div>
            <div class="security-item">
              <i data-lucide="truck"></i>
              <span>Fast Delivery</span>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <script id="cart-page-bootstrap" type="application/json">
      {{ {
        'cartItems': cart_items or [],
        'savedItems': [],
        'checkoutUrl': url_for('main.buyer_checkout'),
        'maxQuantity': max_cart_quantity or 100
      }|tojson }}
    </script>
    <script src="{{ url_for('static', filename='js/buyer_scripts/cart_page.js') }}"></script>
    <script src="{{ url_for('static', filename='js/buyer_scripts/cart.js') }}"></script>
  </body>
</html>
