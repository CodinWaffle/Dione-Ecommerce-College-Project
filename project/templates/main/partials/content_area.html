<!-- Content Area - Reusable component for filter pages -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/buyer_styles/partials/content_area.css') }}"
/>

<div class="content-area">
  <div class="content-header">
    <div class="content-info">
      <div class="product-count">
        Showing <span id="productCount">12</span> of
        <span id="totalProducts">12</span> products
        <span id="viewMore" class="view-more" style="display: none"
          >â€¢ View More</span
        >
      </div>
    </div>
    <div class="sort-wrapper">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
        class="sort-icon"
      >
        <path d="M3 6h18M7 12h10M11 18h2" />
      </svg>
      <div class="sort-dropdown">
        <select id="sortBy">
          <option value="sort-by">Sort By</option>
          <option value="price-low">Price: Low to High</option>
          <option value="price-high">Price: High to Low</option>
          <option value="newest">Newest First</option>
          <option value="popular">Most Popular</option>
        </select>
      </div>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="12"
        height="12"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
        class="dropdown-chevron"
      >
        <polyline points="6,9 12,15 18,9" />
      </svg>
    </div>
  </div>

  <div class="filter-tags" id="selectedFilters">
    <!-- Selected filters will appear here -->
    <button
      class="reset-filters-btn"
      onclick="resetAllFilters()"
      style="display: none"
      id="resetFiltersBtn"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="14"
        height="14"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"
        />
      </svg>
      Reset Filters
    </button>
  </div>

  <div class="product-grid" id="productGrid">
    {# Include the product card template once; cards will be instantiated by JS
    #} {% include 'main/components/_product_card.html' %}
  </div>

  <!-- Empty State Message -->
  <div class="empty-state" id="emptyState" style="display: none">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="64"
      height="64"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="1.5"
    >
      <path d="M3 3h18v18H3z" />
      <path d="M9 9h6v6H9z" />
    </svg>
    <h3>No Products Found</h3>
    <p>Sorry, we couldn't find any products matching your filters.</p>
  </div>

  <!-- Pagination Controls -->
  <div class="pagination-container">
    <div class="pagination-info">
      <span
        >Showing <span id="currentRange">1-12</span> of
        <span id="totalItems">24</span> items</span
      >
    </div>
    <div class="pagination-controls">
      <button
        class="pagination-btn prev-btn"
        id="prevBtn"
        onclick="goToPage(currentPage - 1)"
        disabled
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="15,18 9,12 15,6"></polyline>
        </svg>
        Previous
      </button>
      <div class="page-numbers" id="pageNumbers">
        <!-- Page numbers will be generated by JavaScript -->
      </div>
      <button
        class="pagination-btn next-btn"
        id="nextBtn"
        onclick="goToPage(currentPage + 1)"
      >
        Next
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="9,18 15,12 9,6"></polyline>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Connect content area JS -->
<script src="{{ url_for('static', filename='js/buyer_scripts/partials/content_area.js') }}"></script>
<script src="{{ url_for('static', filename='js/buyer_scripts/components/product_card.js') }}"></script>

<script>
  // If the parent template provided `category` (and optional `subcategory`),
  // fetch products from the API and initialize the product grid using the
  // existing ProductCard component.
  document.addEventListener('DOMContentLoaded', function () {
    // Try to detect category from breadcrumb (e.g. Home > Clothing)
    let categoryFromBreadcrumb = null;
    const breadcrumb = document.querySelector('.carousel-breadcrumb') || document.querySelector('.breadcrumb');
    if (breadcrumb) {
      const links = breadcrumb.querySelectorAll('.breadcrumb-link');
      if (links && links.length >= 2) {
        categoryFromBreadcrumb = links[1].textContent.trim().toLowerCase();
      }
    }

    // Server-provided fallback + server-passed products
    const serverCategory = {{ (category|tojson) if category is defined else 'null' }};
    const serverSubcategory = {{ (subcategory|tojson) if subcategory is defined else 'null' }};
    const serverProducts = {{ (products|tojson) if products is defined else 'null' }};

    const finalCategory = categoryFromBreadcrumb || serverCategory || null;

    // Build query string
    const params = new URLSearchParams();
    if (finalCategory) params.set('category', finalCategory);
    if (serverSubcategory) params.set('subcategory', serverSubcategory);
    params.set('limit', 48);

    function renderProductsFromList(list) {
      const prepared = (list || []).map((p) => ({
        id: p.id,
        name: p.name || '-',
        price: p.price || 0,
        primaryImage: p.primaryImage || p.primary_image || '/static/image/banner.png',
        secondaryImage: p.secondaryImage || p.secondary_image || p.primaryImage || '/static/image/banner.png',
        material: p.material || p.materials || 'Premium Material',
        originalPrice: p.originalPrice || p.compare_at_price || null,
      }));
      if (typeof initializeProducts === 'function' && prepared.length) {
        initializeProducts('productGrid', prepared);
      }
      if (typeof updateProductCount === 'function') updateProductCount();
    }

    function fetchAndRender(qs) {
      return fetch(`/api/products${qs ? ('?' + qs) : ''}`)
        .then((r) => r.json())
        .then((data) => {
          if (!data || !Array.isArray(data.products)) return [];
          return data.products;
        })
        .catch((err) => {
          console.warn('Failed to load products for content area', err);
          return [];
        });
    }

    // If server already passed product list, use it (server-rendered data path)
    if (serverProducts && Array.isArray(serverProducts) && serverProducts.length) {
      renderProductsFromList(serverProducts);
      return;
    }

    // Otherwise, fetch using category/subcategory if provided
    fetchAndRender(params.toString()).then((products) => {
      if (products && products.length) {
        renderProductsFromList(products);
        return;
      }
      // Fallback: fetch any active products regardless of category
      fetchAndRender('limit=48').then((fallback) => {
        if (fallback && fallback.length) renderProductsFromList(fallback);
      });
    });
  });
</script>
