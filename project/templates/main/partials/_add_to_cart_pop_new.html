<!-- Add to Cart Modal -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/buyer_styles/partials/_add_to_cart_popup.css') }}"
/>

<!-- Success Animation -->
<div class="cart-success-animation" id="cartSuccessAnimation">
  <div class="cart-success-content">
    <div class="cart-success-icon">
      <svg
        width="48"
        height="48"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M9 12l2 2 4-4"></path>
        <circle cx="12" cy="12" r="10"></circle>
      </svg>
    </div>
    <div class="cart-success-message">Product Successfully Added to Cart</div>
  </div>
</div>

<!-- Modal overlay -->
<div
  class="cart-modal-overlay"
  id="cartModalOverlay"
  onclick="closeCartModal(event)"
>
  <div class="cart-modal" onclick="event.stopPropagation()">
    <!-- Modal header -->
    <div class="cart-modal-header">
      <div class="cart-modal-title">
        <svg
          class="cart-bag-icon"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M6 2l3 6v8a2 2 0 002 2h2a2 2 0 002-2V8l3-6" />
          <path d="M5 8h14l-1 13H6L5 8z" />
          <path d="M10 10v4" />
          <path d="M14 10v4" />
        </svg>
        You've Got Great Taste
        <span class="cart-item-count">1 Item</span>
      </div>
      <button class="cart-close-button" onclick="closeCartModal()">
        &times;
      </button>
    </div>

    <!-- Modal body -->
    <div class="cart-modal-body">
      <div class="cart-modal-content-wrapper">
        <!-- Left side - Product section -->
        <div class="cart-left-section">
          <div class="cart-product-section">
            <div class="cart-product-image">
              <img
                id="cartModalProductImage"
                src="{{ url_for('static', filename='image/banner.png') }}"
                alt="Product"
              />
            </div>
            <div class="cart-product-details">
              <div class="cart-product-name" id="cartModalProductName">
                Product
              </div>
              <div class="cart-product-meta">
                Color: <span id="cartModalSelectedColor">-</span>
              </div>
              <div class="cart-product-meta">
                Size: <span id="cartModalSelectedSize">-</span>
              </div>
              <div class="cart-product-meta">
                Quantity: <span id="cartModalSelectedQuantity">1</span>
              </div>
              <div class="cart-product-price" id="cartModalProductPrice">₱0</div>
            </div>
          </div>
        </div>

        <!-- Right side - Subtotal and actions -->
        <div class="cart-right-section">
          <div class="cart-subtotal-section">
            <div class="cart-subtotal-label">Subtotal</div>
            <div class="cart-subtotal-amount" id="cartModalSubtotalAmount">₱0</div>
          </div>

          <div class="cart-action-buttons">
            <a class="cart-checkout-button" href="{{ url_for('main.cart') }}"
              >VIEW BAG & CHECKOUT</a
            >
            <a
              href="#"
              class="cart-continue-shopping"
              onclick="closeCartModal()"
            >
              Continue Shopping
              <svg class="cart-arrow-icon" viewBox="0 0 24 24">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12,5 19,12 12,19"></polyline>
              </svg>
            </a>
          </div>
        </div>
      </div>

      <!-- Recommendations section -->
      <div class="cart-recommendations">
        <h3 class="cart-recommendations-title">Goes well with</h3>
        <div class="cart-recommendations-grid" id="cartRecommendationsGrid">
          <!-- Recommendations will be loaded dynamically -->
          <div class="cart-recommendations-loading">
            Loading recommendations...
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function showCartSuccessAnimation() {
    const successAnimation = document.getElementById("cartSuccessAnimation");
    successAnimation.classList.add("active");
    document.body.style.overflow = "hidden";

    // Hide success animation after 2 seconds and show modal
    setTimeout(() => {
      successAnimation.classList.remove("active");
      // Show the modal after success animation
      setTimeout(() => {
        openCartModal();
      }, 300);
    }, 2000);
  }

  function openCartModal() {
    const modal = document.getElementById("cartModalOverlay");
    modal.classList.add("active");
    document.body.style.overflow = "hidden";
  }

  function closeCartModal(event) {
    // Only close if clicking the overlay or close button
    if (
      event &&
      event.target !== event.currentTarget &&
      !event.target.classList.contains("cart-close-button")
    ) {
      return;
    }

    const modal = document.getElementById("cartModalOverlay");
    modal.classList.remove("active");
    document.body.style.overflow = "auto";
  }

  // Close modal with Escape key
  document.addEventListener("keydown", function (event) {
    if (event.key === "Escape") {
      const successAnimation = document.getElementById("cartSuccessAnimation");
      const modal = document.getElementById("cartModalOverlay");

      // Close success animation if active
      if (successAnimation.classList.contains("active")) {
        successAnimation.classList.remove("active");
        document.body.style.overflow = "auto";
      }
      // Close modal if active
      else if (modal.classList.contains("active")) {
        closeCartModal();
      }
    }
  });

  // Prevent modal from closing when clicking inside the modal content
  document
    .querySelector(".cart-modal")
    .addEventListener("click", function (event) {
      event.stopPropagation();
    });

  // Handle clicking outside success animation
  document
    .getElementById("cartSuccessAnimation")
    .addEventListener("click", function (event) {
      if (event.target === this) {
        this.classList.remove("active");
        document.body.style.overflow = "auto";
      }
    });

  // Prevent success content from closing when clicked
  document
    .querySelector(".cart-success-content")
    .addEventListener("click", function (event) {
      event.stopPropagation();
    });

  // Function to populate cart modal with product data
  function populateCartModal(productData) {
    try {
      // Update product image
      const productImage = document.getElementById('cartModalProductImage');
      if (productImage && productData.image) {
        productImage.src = productData.image;
        productImage.alt = productData.name || 'Product';
      }

      // Update product name
      const productName = document.getElementById('cartModalProductName');
      if (productName && productData.name) {
        productName.textContent = productData.name;
      }

      // Update color
      const selectedColor = document.getElementById('cartModalSelectedColor');
      if (selectedColor && productData.color) {
        selectedColor.textContent = productData.color;
      }

      // Update size
      const selectedSize = document.getElementById('cartModalSelectedSize');
      if (selectedSize && productData.size) {
        selectedSize.textContent = productData.size;
      }

      // Update quantity
      const selectedQuantity = document.getElementById('cartModalSelectedQuantity');
      if (selectedQuantity && productData.quantity) {
        selectedQuantity.textContent = productData.quantity;
      }

      // Update price
      const productPrice = document.getElementById('cartModalProductPrice');
      if (productPrice && productData.price) {
        productPrice.textContent = `₱${parseFloat(productData.price).toLocaleString()}`;
      }

      // Update subtotal
      const subtotalAmount = document.getElementById('cartModalSubtotalAmount');
      if (subtotalAmount && productData.price && productData.quantity) {
        const subtotal = parseFloat(productData.price) * parseInt(productData.quantity);
        subtotalAmount.textContent = `₱${subtotal.toLocaleString()}`;
      }

      // Load seller recommendations
      if (productData.sellerId && productData.productId) {
        loadSellerRecommendations(productData.sellerId, productData.productId);
      }

    } catch (error) {
      console.error('Error populating cart modal:', error);
    }
  }

  // Function to load seller recommendations
  async function loadSellerRecommendations(sellerId, excludeProductId) {
    try {
      const recommendationsGrid = document.getElementById('cartRecommendationsGrid');
      if (!recommendationsGrid) return;

      // Show loading state
      recommendationsGrid.innerHTML = '<div class="cart-recommendations-loading">Loading recommendations...</div>';

      // Fetch seller products
      const response = await fetch(`/api/seller/${sellerId}/products?limit=4&exclude_id=${excludeProductId}`);
      
      if (!response.ok) {
        throw new Error('Failed to load recommendations');
      }

      const data = await response.json();
      const products = data.products || [];

      // Clear loading state
      recommendationsGrid.innerHTML = '';

      if (products.length === 0) {
        recommendationsGrid.innerHTML = '<div class="cart-recommendations-loading">No other products available from this seller.</div>';
        return;
      }

      // Populate recommendations
      products.forEach(product => {
        const recommendationItem = document.createElement('div');
        recommendationItem.className = 'cart-recommendation-item';
        recommendationItem.style.cursor = 'pointer';
        
        recommendationItem.innerHTML = `
          <div class="cart-recommendation-image">
            <img
              src="${product.primaryImage || '/static/image/banner_1.png'}"
              alt="${product.name}"
              style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
            />
          </div>
          <div class="cart-recommendation-name">${product.name}</div>
          <div class="cart-recommendation-price">₱${parseFloat(product.price).toLocaleString()}</div>
        `;

        // Add click handler to navigate to product
        recommendationItem.addEventListener('click', () => {
          window.location.href = `/product/${product.id}`;
        });

        recommendationsGrid.appendChild(recommendationItem);
      });

    } catch (error) {
      console.error('Error loading seller recommendations:', error);
      const recommendationsGrid = document.getElementById('cartRecommendationsGrid');
      if (recommendationsGrid) {
        recommendationsGrid.innerHTML = '<div class="cart-recommendations-loading">Failed to load recommendations.</div>';
      }
    }
  }

  // Make functions globally available
  window.populateCartModal = populateCartModal;
  window.loadSellerRecommendations = loadSellerRecommendations;
</script>
