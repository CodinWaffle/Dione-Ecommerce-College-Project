{% extends 'main/base.html' %}
{% block title %}My Purchases - Dione Ecommerce{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/buyer_styles/my_purchases.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
{% endblock %}

{% block content %}
<div class="my-purchases-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="ri-shopping-bag-3-line"></i>
        My Purchases
      </h1>
      <p class="page-subtitle">Track and manage all your orders</p>
    </div>
  </div>

  <!-- Order Status Tabs -->
  <div class="order-tabs">
    <div class="tabs-container">
      <a href="{{ url_for('buyer.my_purchases', status='all') }}" 
         class="tab-item {% if status_filter == 'all' %}active{% endif %}">
        <span class="tab-label">All Orders</span>
        <span class="tab-count">{{ status_counts.all }}</span>
      </a>
      
      <a href="{{ url_for('buyer.my_purchases', status='pending') }}" 
         class="tab-item {% if status_filter == 'pending' %}active{% endif %}">
        <span class="tab-label">Pending</span>
        <span class="tab-count">{{ status_counts.pending }}</span>
      </a>
      
      <a href="{{ url_for('buyer.my_purchases', status='confirmed') }}" 
         class="tab-item {% if status_filter == 'confirmed' %}active{% endif %}">
        <span class="tab-label">Confirmed</span>
        <span class="tab-count">{{ status_counts.confirmed }}</span>
      </a>
      
      <a href="{{ url_for('buyer.my_purchases', status='shipping') }}" 
         class="tab-item {% if status_filter == 'shipping' %}active{% endif %}">
        <span class="tab-label">Shipping</span>
        <span class="tab-count">{{ status_counts.shipping }}</span>
      </a>
      
      <a href="{{ url_for('buyer.my_purchases', status='in_transit') }}" 
         class="tab-item {% if status_filter == 'in_transit' %}active{% endif %}">
        <span class="tab-label">In Transit</span>
        <span class="tab-count">{{ status_counts.in_transit }}</span>
      </a>
      
      <a href="{{ url_for('buyer.my_purchases', status='delivered') }}" 
         class="tab-item {% if status_filter == 'delivered' %}active{% endif %}">
        <span class="tab-label">Delivered</span>
        <span class="tab-count">{{ status_counts.delivered }}</span>
      </a>
      
      <a href="{{ url_for('buyer.my_purchases', status='to_review') }}" 
         class="tab-item {% if status_filter == 'to_review' %}active{% endif %}">
        <span class="tab-label">To Review</span>
        <span class="tab-count">{{ status_counts.to_review }}</span>
      </a>
    </div>
  </div>

  <!-- Orders List -->
  <div class="orders-list">
    {% if orders %}
      {% for order in orders %}
      <div class="order-card" data-status="{{ order.status }}" data-order="{{ order.id }}">
        <!-- Order Header -->
        <div class="order-header">
          <div class="order-info">
            <div class="order-number">
              <i class="ri-file-list-3-line"></i>
              <span>Order #{{ order.order_number }}</span>
            </div>
            <div class="order-date">
              <i class="ri-calendar-line"></i>
              <span>{{ order.created_at.strftime('%B %d, %Y') }}</span>
            </div>
          </div>
          
          <div class="order-status">
            <span class="status-badge status-{{ order.status }}">
              {% if order.status == 'pending' %}
                <i class="ri-time-line"></i> Pending
              {% elif order.status == 'confirmed' %}
                <i class="ri-check-line"></i> Confirmed
              {% elif order.status == 'shipping' %}
                <i class="ri-truck-line"></i> Shipping
              {% elif order.status == 'in_transit' %}
                <i class="ri-map-pin-line"></i> In Transit
              {% elif order.status == 'delivered' %}
                <i class="ri-home-line"></i> Delivered
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Order Items -->
        <div class="order-items">
          {% for item in order.order_items %}
          <div class="order-item">
            <div class="item-image">
              <img src="{{ item.product_image or '/static/image/banner.png' }}" 
                   alt="{{ item.product_name }}" 
                   loading="lazy">
            </div>
            
            <div class="item-details">
              <h3 class="item-name">{{ item.product_name }}</h3>
              <div class="item-variant">
                {% if item.variant_name %}
                  <span class="variant-info">{{ item.variant_name }}</span>
                {% else %}
                  {% if item.color %}<span class="color">{{ item.color }}</span>{% endif %}
                  {% if item.size %}<span class="size">Size: {{ item.size }}</span>{% endif %}
                {% endif %}
              </div>
              <div class="item-quantity">Qty: {{ item.quantity }}</div>
            </div>
            
            <div class="item-price">
              <span class="price">₱{{ "%.2f"|format(item.total_price) }}</span>
            </div>
            
            <div class="item-actions">
              {% if order.status == 'delivered' and not item.is_reviewed %}
                <button class="btn-review" onclick="openReviewModal({{ item.id }})">
                  <i class="ri-star-line"></i>
                  Write Review
                </button>
              {% elif item.is_reviewed %}
                <span class="reviewed-badge">
                  <i class="ri-star-fill"></i>
                  Reviewed
                </span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
          <div class="summary-left">
            {% if order.tracking_number %}
            <div class="tracking-info">
              <i class="ri-truck-line"></i>
              <span>Tracking: {{ order.tracking_number }}</span>
            </div>
            {% endif %}
          </div>
          
          <div class="summary-right">
            <div class="total-amount">
              <span class="label">Total:</span>
              <span class="amount">₱{{ "%.2f"|format(order.total_amount) }}</span>
            </div>
          </div>
        </div>

        <!-- Order Actions -->
        <div class="order-actions">
          <button class="btn-secondary" onclick="viewOrderDetails({{ order.id }})">
            <i class="ri-eye-line"></i>
            View Details
          </button>
          
          {% if order.tracking_number %}
          <button class="btn-primary" onclick="trackOrder({{ order.id }})">
            <i class="ri-map-pin-line"></i>
            Track Order
          </button>
          {% endif %}
          
          {% if order.status == 'pending' %}
          <button class="btn-danger" onclick="cancelOrder({{ order.id }})">
            <i class="ri-close-line"></i>
            Cancel Order
          </button>
          {% endif %}
          
          <!-- Reviews Toggle -->
          <button class="btn-ghost reviews-toggle" onclick="toggleReviews({{ order.id }})">
            <i class="ri-chat-3-line"></i>
            <span id="reviews-count-{{ order.id }}">
              {% set review_count = order.order_items|selectattr('is_reviewed')|list|length %}
              {% if review_count > 0 %}
                {{ review_count }} Review{{ 's' if review_count != 1 else '' }}
              {% else %}
                Reviews
              {% endif %}
            </span>
            <i class="ri-arrow-down-s-line toggle-icon"></i>
          </button>
        </div>

        <!-- Reviews Dropdown -->
        <div class="reviews-dropdown" id="reviews-{{ order.id }}">
          {% set has_reviews = order.order_items|selectattr('is_reviewed')|list|length > 0 %}
          {% if has_reviews %}
            <div class="reviews-content">
              <div class="reviews-header">
                <h4>Your Reviews</h4>
                <div class="review-filters">
                  <button class="filter-btn active" data-rating="all">All</button>
                  <button class="filter-btn" data-rating="5">5★</button>
                  <button class="filter-btn" data-rating="4">4★</button>
                  <button class="filter-btn" data-rating="3">3★</button>
                  <button class="filter-btn" data-rating="2">2★</button>
                  <button class="filter-btn" data-rating="1">1★</button>
                </div>
              </div>
              
              <div class="reviews-list">
                {% for item in order.order_items %}
                  {% if item.is_reviewed %}
                    {% for review in item.reviews %}
                    <div class="review-item" data-rating="{{ review.rating }}">
                      <div class="review-product">
                        <img src="{{ item.product_image or '/static/image/banner.png' }}" 
                             alt="{{ item.product_name }}">
                        <div class="product-info">
                          <h5>{{ item.product_name }}</h5>
                          <span class="variant">{{ item.variant_name or (item.color + ' - ' + item.size if item.color and item.size else '') }}</span>
                        </div>
                      </div>
                      
                      <div class="review-content">
                        <div class="review-rating">
                          {% for i in range(5) %}
                            <i class="ri-star-{{ 'fill' if i < review.rating else 'line' }}"></i>
                          {% endfor %}
                          <span class="rating-text">{{ review.rating }}/5</span>
                        </div>
                        
                        {% if review.title %}
                        <h6 class="review-title">{{ review.title }}</h6>
                        {% endif %}
                        
                        {% if review.comment %}
                        <p class="review-comment">{{ review.comment }}</p>
                        {% endif %}
                        
                        {% if review.images %}
                        <div class="review-images">
                          {% for image in review.images %}
                          <img src="{{ image }}" alt="Review image" class="review-image" onclick="showImageModal('{{ image }}')">
                          {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="review-date">
                          <i class="ri-calendar-line"></i>
                          {{ review.created_at.strftime('%B %d, %Y') }}
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% else %}
            <div class="no-reviews-message">
              <i class="ri-chat-3-line"></i>
              <p>No reviews yet for this order</p>
              {% if order.status == 'delivered' %}
              <p class="hint">You can write reviews for delivered items</p>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    {% else %}
      <!-- Empty State -->
      <div class="empty-state">
        <div class="empty-icon">
          <i class="ri-shopping-bag-3-line"></i>
        </div>
        <h3>No orders found</h3>
        <p>
          {% if status_filter == 'all' %}
            You haven't made any purchases yet.
          {% else %}
            No orders with "{{ status_filter.replace('_', ' ').title() }}" status.
          {% endif %}
        </p>
        <a href="/" class="btn-primary">
          <i class="ri-shopping-cart-line"></i>
          Start Shopping
        </a>
      </div>
    {% endif %}
  </div>

  <!-- Pagination -->
  {% if pagination.pages > 1 %}
  <div class="pagination-container">
    <div class="pagination">
      {% if pagination.has_prev %}
        <a href="{{ url_for('buyer.my_purchases', status=status_filter, page=pagination.prev_num) }}" class="page-btn">
          <i class="ri-arrow-left-line"></i>
        </a>
      {% endif %}
      
      {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
          {% if page_num != pagination.page %}
            <a href="{{ url_for('buyer.my_purchases', status=status_filter, page=page_num) }}" class="page-btn">{{ page_num }}</a>
          {% else %}
            <span class="page-btn active">{{ page_num }}</span>
          {% endif %}
        {% else %}
          <span class="page-btn disabled">…</span>
        {% endif %}
      {% endfor %}
      
      {% if pagination.has_next %}
        <a href="{{ url_for('buyer.my_purchases', status=status_filter, page=pagination.next_num) }}" class="page-btn">
          <i class="ri-arrow-right-line"></i>
        </a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Review Modal -->
<div id="reviewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Write a Review</h3>
      <button class="close-btn" onclick="closeReviewModal()">
        <i class="ri-close-line"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div id="reviewForm">
        <!-- Review form will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="modal">
  <div class="modal-content image-modal">
    <button class="close-btn" onclick="closeImageModal()">
      <i class="ri-close-line"></i>
    </button>
    <img id="modalImage" src="" alt="Review image">
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/buyer_scripts/my_purchases.js') }}"></script>
{% endblock %}