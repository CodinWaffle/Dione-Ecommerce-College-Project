<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Rider Platform{% endblock %}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/rider_styles/rider_dashboard.css') }}"
    />
    <!-- Lucide Icons (used by seller/rider header & sidebar) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Include seller sidebar/header styles so rider matches seller UI -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='css/seller_styles/partials/_sidebar_seller.css') }}?v={{ range(1, 10000) | random }}"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='css/seller_styles/partials/_header_seller.css') }}?v={{ range(1, 10000) | random }}"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='css/seller_styles/seller_common.css') }}?v={{ range(1, 10000) | random }}"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Montserrat:400,600|Poppins:400,600&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined"
    />
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <!-- Header -->
    {% block header %}{% endblock %} {% include 'rider/_rider_header.html' %}
    <style>
      /* Ensure rider header matches seller header layout and is visible */
      .seller-header.rider-header-override,
      .rider-header-override {
        height: var(--header-height);
        background: var(--white, #ffffff);
        border-bottom: 1px solid rgba(229, 231, 235, 1);
        position: fixed;
        top: 0;
        left: var(--sidebar-width); /* leave space for rider sidebar */
        right: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
      }
      .seller-header.rider-header-override.expanded,
      .rider-header-override.expanded {
        left: var(--sidebar-collapsed-width);
      }
      .rider-header-override .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .rider-header-override .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }
    </style>
    <!-- Sidebar -->
    {% include 'rider/_rider_sidebar.html' %}

    <!-- Main Content Block -->
    {% block content %}{% endblock %}

    <!-- Common Scripts -->
    <script>
      // Initialize Lucide icons for rider templates
      document.addEventListener("DOMContentLoaded", function () {
        if (typeof lucide !== "undefined") {
          lucide.createIcons();
        }
      });

      (function () {
        const sidebar = document.getElementById("sidebar");
        const toggle = document.getElementById("sidebarToggle");
        const header = document.querySelector(".rider-header-override");
        const main =
          document.querySelector(".dashboard-main") ||
          document.querySelector(".main-content");
        const search = document.querySelector(
          ".search-container-header.left-search"
        );

        if (!sidebar || !toggle) return;

        // Restore previous state (sidebar only)
        const collapsed =
          localStorage.getItem("riderSidebarCollapsed") === "true";
        if (collapsed) {
          sidebar.classList.add("collapsed");
        }

        function positionControls() {
          try {
            const sw =
              sidebar.getBoundingClientRect().width ||
              parseInt(
                getComputedStyle(document.documentElement).getPropertyValue(
                  "--sidebar-width"
                )
              );
            if (toggle) toggle.style.left = sw + 12 + "px";
            if (search) search.style.left = sw + 56 + "px";
          } catch (err) {}
        }

        // Initial position
        positionControls();
        window.addEventListener("resize", positionControls);

        toggle.addEventListener("click", function () {
          const isCollapsed = sidebar.classList.toggle("collapsed");
          // Also toggle header alignment so it visually aligns with the collapsed sidebar width
          if (header) header.classList.toggle("expanded");
          // Persist only sidebar collapsed state
          localStorage.setItem("riderSidebarCollapsed", isCollapsed);
          // Recreate lucide icons after toggle to ensure icons redraw correctly
          if (typeof lucide !== "undefined") {
            setTimeout(() => lucide.createIcons(), 80);
          }
          // Reposition controls after animation
          setTimeout(positionControls, 160);
        });

        // User profile dropdown handling (notifications/profile/logout)
        const profileToggle = document.querySelector(".user-profile-toggle");
        const profileMenu = document.querySelector(".user-dropdown-menu");
        if (profileToggle && profileMenu) {
          profileToggle.addEventListener("click", function (e) {
            e.stopPropagation();
            const isOpen = profileMenu.classList.toggle("open");
            profileMenu.setAttribute("aria-hidden", isOpen ? "false" : "true");
            // Update the toggle button aria-expanded state
            try {
              profileToggle.setAttribute(
                "aria-expanded",
                isOpen ? "true" : "false"
              );
            } catch (err) {}
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", function (e) {
            if (!profileMenu.classList.contains("open")) return;
            if (
              !profileMenu.contains(e.target) &&
              !profileToggle.contains(e.target)
            ) {
              profileMenu.classList.remove("open");
              profileMenu.setAttribute("aria-hidden", "true");
            }
          });

          // Close on Escape
          document.addEventListener("keydown", function (e) {
            if (e.key === "Escape" && profileMenu.classList.contains("open")) {
              profileMenu.classList.remove("open");
              profileMenu.setAttribute("aria-hidden", "true");
            }
          });
        }
      })();
    </script>
    {% block scripts %}{% endblock %} {% include 'partials/_chat_bubble.html' %}
  </body>
</html>
